---
phase: 06-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - arden/lib/supabase/queries/dashboard.ts
  - arden/components/ui/kpi-card.tsx
  - arden/app/app/obras/[id]/page.tsx
  - arden/app/app/obras/[id]/_components/obra-dashboard.tsx
  - arden/app/app/obras/[id]/_components/kpi-section.tsx
autonomous: true

must_haves:
  truths:
    - "User sees Taxa de Conformidade card with percentage value"
    - "User sees IRS card with percentage value"
    - "User sees Verificacoes Pendentes card with count"
    - "User sees Verificacoes Concluidas card with count"
    - "Each card shows trend arrow with percentage change vs previous month"
    - "Cards show skeleton while loading"
    - "Zero data displays 0% or 0 (not '--')"
  artifacts:
    - path: "arden/lib/supabase/queries/dashboard.ts"
      provides: "Dashboard data fetching functions"
      exports: ["getDashboardKPIs", "DashboardKPIs"]
    - path: "arden/components/ui/kpi-card.tsx"
      provides: "KPICard with trend indicator support"
      contains: "trend"
    - path: "arden/app/app/obras/[id]/_components/kpi-section.tsx"
      provides: "Grid of 4 KPI cards"
      contains: "grid"
  key_links:
    - from: "arden/app/app/obras/[id]/page.tsx"
      to: "arden/lib/supabase/queries/dashboard.ts"
      via: "getDashboardKPIs(obraId)"
      pattern: "getDashboardKPIs"
    - from: "arden/app/app/obras/[id]/_components/kpi-section.tsx"
      to: "arden/components/ui/kpi-card.tsx"
      via: "KPICard component import"
      pattern: "import.*KPICard"
---

<objective>
Create dashboard KPI cards with real data from verificacoes tables

Purpose: Enable engineers to see quality metrics at a glance (Taxa de Conformidade, IRS, Pendentes, Concluidas) with trend indicators comparing current month vs previous month.

Output: Functioning KPI grid that displays real metrics from database, with proper loading states and handling of zero data scenarios.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard/06-CONTEXT.md
@.planning/phases/06-dashboard/06-RESEARCH.md

Reference files:
@arden/app/app/obras/[id]/page.tsx (current placeholder)
@arden/components/ui/kpi-card.tsx (existing component to extend)
@database/schema.sql (verificacoes, itens_verificacao tables)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard data access layer</name>
  <files>arden/lib/supabase/queries/dashboard.ts</files>
  <action>
Create new file with dashboard data fetching functions:

1. Define `DashboardKPIs` interface:
   ```typescript
   interface DashboardKPIs {
     taxaConformidade: { current: number; previous: number }
     irs: { current: number; previous: number }
     pendentes: { current: number; previous: number }
     concluidas: { current: number; previous: number }
   }
   ```

2. Implement `getDashboardKPIs(obraId: string): Promise<DashboardKPIs>`:
   - Query `verificacoes` and `itens_verificacao` tables for obra
   - Calculate metrics for current month AND previous month (for trend)

   **Metric formulas:**
   - Taxa de Conformidade = (Conformes + Conformes apos reinspecao + Aprovado com concessao) / Total verificados * 100
     - Use `itens_verificacao.status IN ('conforme') OR itens_verificacao.status_reinspecao IN ('conforme_apos_reinspecao', 'aprovado_com_concessao')`
   - IRS = (Itens com status_reinspecao = 'retrabalho') / Total verificados * 100
   - Pendentes = Count of `itens_verificacao.status = 'nao_conforme' AND status_reinspecao IS NULL`
   - Concluidas = Count of items that are conforme OR have resolved reinspecao (not reprovado_apos_retrabalho)

   **Date filtering:**
   - Current month: `created_at >= date_trunc('month', CURRENT_DATE)`
   - Previous month: `created_at >= date_trunc('month', CURRENT_DATE - INTERVAL '1 month') AND created_at < date_trunc('month', CURRENT_DATE)`

3. Use RLS optimization: wrap `auth.uid()` in subquery `(SELECT auth.uid())` for performance

4. Handle zero data gracefully: return 0 for all metrics if no verification data exists
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd arden && npx tsc --noEmit
```
  </verify>
  <done>File exists with getDashboardKPIs function that returns DashboardKPIs type</done>
</task>

<task type="auto">
  <name>Task 2: Extend KPICard with trend indicator</name>
  <files>arden/components/ui/kpi-card.tsx</files>
  <action>
Extend existing KPICard to support trend indicators:

1. Add new props to interface:
   ```typescript
   interface KPICardProps {
     title: string
     value: string | number
     previousValue?: number  // For trend calculation
     format?: 'percent' | 'number'  // How to format value
     description?: string
     loading?: boolean
     className?: string
   }
   ```

2. Calculate trend when previousValue is provided:
   - `trend = ((current - previous) / previous) * 100` (handle division by zero)
   - If no previousValue, don't show trend

3. Add trend indicator next to value:
   - Import ArrowUp, ArrowDown, Minus from lucide-react
   - Positive trend (>0): green text-brand with ArrowUp icon
   - Negative trend (<0): red text-destructive with ArrowDown icon
   - Zero trend (=0): neutral with Minus icon
   - Show trend percentage with 1 decimal place

4. Format value based on `format` prop:
   - 'percent': append '%' to value
   - 'number': show as-is (default)

5. Keep existing loading skeleton behavior

6. Use cn() for conditional classes
  </action>
  <verify>
Component renders without errors. Check with:
```bash
cd arden && npm run build
```
  </verify>
  <done>KPICard shows trend arrow and percentage when previousValue is provided</done>
</task>

<task type="auto">
  <name>Task 3: Create KPI section and update dashboard page</name>
  <files>
arden/app/app/obras/[id]/_components/kpi-section.tsx
arden/app/app/obras/[id]/_components/obra-dashboard.tsx
arden/app/app/obras/[id]/page.tsx
  </files>
  <action>
**Step 1: Create KPISection component** (kpi-section.tsx)
```typescript
'use client'
```
- Accept `kpis: DashboardKPIs` prop
- Render 4 KPICards in responsive grid:
  - `grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4`
- Cards:
  1. Taxa de Conformidade: value={kpis.taxaConformidade.current}, previousValue={kpis.taxaConformidade.previous}, format="percent"
  2. IRS: value={kpis.irs.current}, previousValue={kpis.irs.previous}, format="percent"
  3. Verificacoes Pendentes: value={kpis.pendentes.current}, previousValue={kpis.pendentes.previous}, format="number"
  4. Verificacoes Concluidas: value={kpis.concluidas.current}, previousValue={kpis.concluidas.previous}, format="number"

**Step 2: Create ObraDashboard client component** (obra-dashboard.tsx)
```typescript
'use client'
```
- Accept `kpis: DashboardKPIs` prop (and later ncs, chartData)
- Render KPISection with kpis
- Keep placeholders for NC feed and chart (will be added in plans 02 and 03):
  ```tsx
  {/* NC Feed - Plan 06-02 */}
  <div className="rounded-lg border border-dashed border-border p-6">
    <h3 className="text-sm font-medium text-foreground mb-2">Ultimas NCs</h3>
    <p className="text-sm text-foreground-muted">Em breve</p>
  </div>

  {/* Chart - Plan 06-03 */}
  <div className="rounded-lg border border-dashed border-border p-6">
    <h3 className="text-sm font-medium text-foreground mb-2">Evolucao Temporal</h3>
    <p className="text-sm text-foreground-muted">Em breve</p>
  </div>
  ```

**Step 3: Update page.tsx**
- Import getDashboardKPIs from queries/dashboard
- Fetch KPIs in Server Component: `const kpis = await getDashboardKPIs(id)`
- Pass to ObraDashboard: `<ObraDashboard kpis={kpis} />`
- Keep ObraHeader at top
- Update page wrapper to use convention pattern: `bg-background min-h-full`
- Remove old placeholder KPICard instances
- Remove "Acoes Rapidas" placeholder section
  </action>
  <verify>
Run dev server and visit /app/obras/[id]:
```bash
cd arden && npm run dev
```
Page loads without errors, shows 4 KPI cards (likely all showing 0 since no verification data exists yet)
  </verify>
  <done>Dashboard page shows 4 KPI cards with real data (or zeros), trend indicators working</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes without errors
2. Visit /app/obras/[id] - page loads
3. 4 KPI cards visible in grid layout
4. Cards show 0% or 0 (not "--") when no data
5. No console errors
6. Page follows convention: bg-background min-h-full wrapper
</verification>

<success_criteria>
- Dashboard displays 4 KPI cards with real data from verificacoes tables
- Each card shows current value and trend indicator (when previous data exists)
- Zero data handled gracefully (shows 0, not placeholder)
- Loading states work (skeleton while fetching)
- Page follows project conventions (wrapper, Server Component header)
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard/06-01-SUMMARY.md`
</output>
