---
phase: 06-dashboard
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - arden/package.json
  - arden/lib/supabase/queries/dashboard.ts
  - arden/app/app/obras/[id]/_components/conformidade-chart.tsx
  - arden/app/app/obras/[id]/_components/obra-dashboard.tsx
  - arden/app/app/obras/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees line chart showing Taxa de Conformidade over time"
    - "Chart shows last 3 months by default (daily granularity)"
    - "X-axis shows dates formatted in Portuguese (dd/MMM)"
    - "Y-axis shows percentage (0-100%)"
    - "Tooltip shows full date and exact percentage on hover"
    - "Empty state shows message when no data available"
    - "Period selector allows choosing 30d, 3m, 6m (stretch goal)"
    - "Chart uses brand color (green) for line"
  artifacts:
    - path: "arden/app/app/obras/[id]/_components/conformidade-chart.tsx"
      provides: "Recharts LineChart component"
      contains: "ResponsiveContainer"
    - path: "arden/lib/supabase/queries/dashboard.ts"
      provides: "getConformidadeTimeSeries function"
      exports: ["getConformidadeTimeSeries", "ChartDataPoint"]
  key_links:
    - from: "arden/app/app/obras/[id]/_components/conformidade-chart.tsx"
      to: "recharts"
      via: "LineChart, ResponsiveContainer imports"
      pattern: "import.*recharts"
    - from: "arden/app/app/obras/[id]/_components/obra-dashboard.tsx"
      to: "arden/app/app/obras/[id]/_components/conformidade-chart.tsx"
      via: "ConformidadeChart component"
      pattern: "import.*ConformidadeChart"
---

<objective>
Create temporal chart showing Taxa de Conformidade evolution using Recharts

Purpose: Enable engineers to visualize quality trends over time, identifying improvement or degradation patterns in construction quality.

Output: Interactive line chart displaying daily conformity rate for the last 3 months, with proper Portuguese date formatting and dark theme styling.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard/06-CONTEXT.md
@.planning/phases/06-dashboard/06-RESEARCH.md
@.planning/phases/06-dashboard/06-01-SUMMARY.md
@.planning/phases/06-dashboard/06-02-SUMMARY.md

Reference files:
@arden/app/app/obras/[id]/_components/obra-dashboard.tsx (from plans 01-02)
@arden/lib/supabase/queries/dashboard.ts (from plans 01-02)
@arden/app/globals.css (CSS variables for theming)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts</name>
  <files>arden/package.json</files>
  <action>
Install Recharts and its peer dependency:

```bash
cd arden && npm install recharts react-is
```

- recharts: React charting library (v3.7+)
- react-is: Required peer dependency for Recharts to work correctly with React 19

Note: date-fns was already installed in plan 06-02.
  </action>
  <verify>
Check package.json includes recharts:
```bash
grep "recharts" arden/package.json
```
  </verify>
  <done>recharts and react-is installed and in dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Add time series query to dashboard data layer</name>
  <files>arden/lib/supabase/queries/dashboard.ts</files>
  <action>
Add time series data fetching to existing dashboard queries file:

1. Define `ChartDataPoint` interface:
   ```typescript
   export interface ChartDataPoint {
     date: string  // ISO date string (YYYY-MM-DD)
     taxa: number  // Conformity rate percentage
   }
   ```

2. Implement `getConformidadeTimeSeries(obraId: string, days: number = 90): Promise<ChartDataPoint[]>`:
   - Query aggregated conformity rate per day
   - Use PostgreSQL `date_trunc('day', created_at)::date` for grouping
   - Calculate taxa = (conformes / total) * 100 for each day
   - Filter to last N days: `created_at >= CURRENT_DATE - INTERVAL 'N days'`
   - Only include days with actual data (no backfilling empty days)
   - ORDER BY date ASC (oldest to newest for chart)

   **SQL approach (can use raw query or Supabase RPC):**
   Since Supabase client doesn't support GROUP BY directly, use a raw SQL query via `supabase.rpc()` or create a database function.

   **Alternative: Create RPC function in migration:**
   If complex, create a Postgres function `get_conformidade_time_series(obra_id uuid, days int)` that returns the aggregated data.

   **Simpler approach for MVP:**
   - Fetch all itens_verificacao for obra in date range
   - Group by date in JavaScript
   - Calculate taxa per day

3. Handle empty results: return empty array (chart will show empty state)

4. Return sorted ChartDataPoint[] (oldest to newest)
  </action>
  <verify>
TypeScript compiles:
```bash
cd arden && npx tsc --noEmit
```
  </verify>
  <done>getConformidadeTimeSeries function exists and returns ChartDataPoint[]</done>
</task>

<task type="auto">
  <name>Task 3: Create ConformidadeChart component and integrate</name>
  <files>
arden/app/app/obras/[id]/_components/conformidade-chart.tsx
arden/app/app/obras/[id]/_components/obra-dashboard.tsx
arden/app/app/obras/[id]/page.tsx
  </files>
  <action>
**Step 1: Create ConformidadeChart component** (conformidade-chart.tsx)
```typescript
'use client'
```

1. Import Recharts components:
   ```typescript
   import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts'
   import { format, parseISO } from 'date-fns'
   import { ptBR } from 'date-fns/locale'
   ```

2. Accept props: `data: ChartDataPoint[]`

3. Handle empty state:
   ```tsx
   if (data.length === 0) {
     return (
       <div className="rounded-lg border border-dashed border-border p-6 text-center h-[300px] flex items-center justify-center">
         <p className="text-sm text-foreground-muted">
           Sem dados de verificacao no periodo
         </p>
       </div>
     )
   }
   ```

4. Create custom Tooltip component for dark theme:
   ```tsx
   const CustomTooltip = ({ active, payload, label }: any) => {
     if (active && payload && payload.length) {
       return (
         <div className="bg-overlay border border-overlay rounded-lg p-3 shadow-lg">
           <p className="text-xs text-foreground-muted">
             {format(parseISO(label), 'PPP', { locale: ptBR })}
           </p>
           <p className="text-sm font-medium text-foreground">
             {payload[0].value.toFixed(1)}% conforme
           </p>
         </div>
       )
     }
     return null
   }
   ```

5. Render chart inside container:
   ```tsx
   <div className="rounded-lg border border-border bg-surface-100 p-4">
     <h3 className="text-sm font-medium text-foreground mb-4">
       Evolucao da Taxa de Conformidade
     </h3>
     <div className="h-[300px]">
       <ResponsiveContainer width="100%" height="100%">
         <LineChart data={data} margin={{ top: 5, right: 20, bottom: 5, left: 0 }}>
           <CartesianGrid
             strokeDasharray="3 3"
             stroke="hsl(var(--border-default))"
             opacity={0.3}
           />
           <XAxis
             dataKey="date"
             tickFormatter={(value) => format(parseISO(value), 'dd/MMM', { locale: ptBR })}
             stroke="hsl(var(--foreground-muted))"
             tick={{ fill: 'hsl(var(--foreground-muted))', fontSize: 12 }}
             tickLine={{ stroke: 'hsl(var(--border-default))' }}
           />
           <YAxis
             domain={[0, 100]}
             tickFormatter={(value) => `${value}%`}
             stroke="hsl(var(--foreground-muted))"
             tick={{ fill: 'hsl(var(--foreground-muted))', fontSize: 12 }}
             tickLine={{ stroke: 'hsl(var(--border-default))' }}
             width={45}
           />
           <Tooltip content={<CustomTooltip />} />
           <Line
             type="monotone"
             dataKey="taxa"
             stroke="hsl(var(--brand-default))"
             strokeWidth={2}
             dot={false}
             activeDot={{ r: 6, fill: 'hsl(var(--brand-default))' }}
           />
         </LineChart>
       </ResponsiveContainer>
     </div>
   </div>
   ```

**Step 2: Update ObraDashboard** (obra-dashboard.tsx)
- Add `chartData: ChartDataPoint[]` to props
- Replace chart placeholder with: `<ConformidadeChart data={chartData} />`

**Step 3: Update page.tsx** (Server Component)
- Import getConformidadeTimeSeries from queries/dashboard
- Fetch chart data: `const chartData = await getConformidadeTimeSeries(id)`
- Pass to ObraDashboard: `<ObraDashboard kpis={kpis} ncs={ncs} chartData={chartData} />`
  </action>
  <verify>
Run dev server and visit /app/obras/[id]:
```bash
cd arden && npm run dev
```
- Chart section visible
- Shows empty state message (since no verification data exists)
- No console errors
- If data existed, chart would render with brand green line
  </verify>
  <done>Conformidade chart renders with proper empty state, ready to visualize data when available</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes without errors
2. recharts and react-is in package.json dependencies
3. Visit /app/obras/[id]:
   - KPI cards visible (from plan 01)
   - NC feed visible (from plan 02)
   - Chart section visible with empty state message
4. No console errors about missing modules or CSS
5. Chart container has proper height (300px)
6. Dark theme styling applied (brand green, proper backgrounds)
</verification>

<success_criteria>
- Recharts installed and working
- Chart component renders in dashboard
- Empty state handled gracefully with Portuguese message
- When data exists:
  - Line shows daily conformity rate
  - X-axis shows Portuguese date format (dd/MMM)
  - Y-axis shows 0-100% range
  - Tooltip shows full date and percentage
  - Line uses brand green color
- Chart is responsive (ResponsiveContainer)
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard/06-03-SUMMARY.md`
</output>
