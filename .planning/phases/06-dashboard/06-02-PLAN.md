---
phase: 06-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - arden/package.json
  - arden/lib/supabase/queries/dashboard.ts
  - arden/app/app/obras/[id]/_components/nc-feed.tsx
  - arden/app/app/obras/[id]/_components/obra-dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "User sees feed with 5 most recent NCs"
    - "Each NC shows servico name, unidade codigo, and relative date (ha X horas)"
    - "Relative dates are in Portuguese (ha 2 dias, ontem, etc)"
    - "Clicking NC shows details (future: modal, for now: just visual feedback)"
    - "Empty state shows 'Nenhuma nao-conformidade registrada' message"
    - "Link 'Ver todas as NCs' exists (placeholder for future page)"
  artifacts:
    - path: "arden/app/app/obras/[id]/_components/nc-feed.tsx"
      provides: "NC feed component with relative dates"
      contains: "formatDistanceToNow"
    - path: "arden/lib/supabase/queries/dashboard.ts"
      provides: "getRecentNCs function"
      exports: ["getRecentNCs", "NCFeedItem"]
  key_links:
    - from: "arden/app/app/obras/[id]/_components/obra-dashboard.tsx"
      to: "arden/app/app/obras/[id]/_components/nc-feed.tsx"
      via: "NCFeed component"
      pattern: "import.*NCFeed"
    - from: "arden/app/app/obras/[id]/_components/nc-feed.tsx"
      to: "date-fns"
      via: "formatDistanceToNow with ptBR locale"
      pattern: "formatDistanceToNow.*ptBR"
---

<objective>
Create NC (Non-Conformance) feed showing 5 most recent issues with relative dates

Purpose: Give engineers quick visibility into recent quality issues so they can prioritize follow-up work.

Output: NC feed component displaying recent non-conformances with service name, unit code, and relative timestamp in Portuguese.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard/06-CONTEXT.md
@.planning/phases/06-dashboard/06-RESEARCH.md
@.planning/phases/06-dashboard/06-01-SUMMARY.md

Reference files:
@arden/app/app/obras/[id]/_components/obra-dashboard.tsx (from plan 01)
@arden/lib/supabase/queries/dashboard.ts (from plan 01)
@database/schema.sql (verificacoes, itens_verificacao, servicos, unidades joins)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install date-fns</name>
  <files>arden/package.json</files>
  <action>
Install date-fns for relative date formatting:

```bash
cd arden && npm install date-fns
```

date-fns provides formatDistanceToNow with PT-BR locale support. This is needed for displaying "ha 2 horas", "ontem", "ha 3 dias" etc.
  </action>
  <verify>
Check package.json includes date-fns:
```bash
grep "date-fns" arden/package.json
```
  </verify>
  <done>date-fns installed and in dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Add NC feed query to dashboard data layer</name>
  <files>arden/lib/supabase/queries/dashboard.ts</files>
  <action>
Add NC feed data fetching to existing dashboard queries file:

1. Define `NCFeedItem` interface:
   ```typescript
   export interface NCFeedItem {
     id: string
     servicoNome: string
     unidadeCodigo: string
     observacao: string | null
     createdAt: string  // ISO date string
   }
   ```

2. Implement `getRecentNCs(obraId: string, limit: number = 5): Promise<NCFeedItem[]>`:
   - Query `itens_verificacao` with status = 'nao_conforme' AND status_reinspecao IS NULL (open NCs only)
   - JOIN with `verificacoes` to filter by obra_id
   - JOIN with `servicos` to get servico.nome
   - JOIN with `unidades` to get unidade.codigo (or unidade.nome as fallback)
   - ORDER BY itens_verificacao.created_at DESC
   - LIMIT to 5 (or passed limit)

   **Join path:**
   - itens_verificacao -> verificacoes (via verificacao_id)
   - verificacoes -> servicos (via servico_id)
   - verificacoes -> unidades (via unidade_id)

3. Return mapped results as NCFeedItem[]

4. Handle empty results gracefully (return empty array)
  </action>
  <verify>
TypeScript compiles:
```bash
cd arden && npx tsc --noEmit
```
  </verify>
  <done>getRecentNCs function exists and returns NCFeedItem[]</done>
</task>

<task type="auto">
  <name>Task 3: Create NCFeed component and integrate with dashboard</name>
  <files>
arden/app/app/obras/[id]/_components/nc-feed.tsx
arden/app/app/obras/[id]/_components/obra-dashboard.tsx
arden/app/app/obras/[id]/page.tsx
  </files>
  <action>
**Step 1: Create NCFeed component** (nc-feed.tsx)
```typescript
'use client'
```

1. Import dependencies:
   - `formatDistanceToNow` from 'date-fns'
   - `ptBR` from 'date-fns/locale'
   - `AlertCircle` from 'lucide-react' (NC icon)

2. Accept props: `ncs: NCFeedItem[]`

3. Handle empty state:
   ```tsx
   if (ncs.length === 0) {
     return (
       <div className="rounded-lg border border-dashed border-border p-6 text-center">
         <p className="text-sm text-foreground-muted">
           Nenhuma nao-conformidade registrada
         </p>
       </div>
     )
   }
   ```

4. Render NC list:
   - Container: `rounded-lg border border-border bg-surface-100 divide-y divide-border`
   - Each NC item:
     - Padding: `p-4`
     - Hover: `hover:bg-surface-200 transition-colors cursor-pointer`
     - Layout: flex with AlertCircle icon (text-destructive), content, and timestamp
     - Content: servicoNome + " - " + unidadeCodigo (font-medium), observacao truncated (line-clamp-2)
     - Timestamp: `formatDistanceToNow(new Date(nc.createdAt), { addSuffix: true, locale: ptBR })`
       - This produces: "ha 2 horas", "ha 3 dias", "ontem", etc.

5. Add "Ver todas as NCs" link at bottom (placeholder - no actual page yet):
   ```tsx
   <div className="p-3 border-t border-border text-center">
     <button className="text-sm text-brand-link hover:underline">
       Ver todas as NCs
     </button>
   </div>
   ```

**Step 2: Update ObraDashboard** (obra-dashboard.tsx)
- Add `ncs: NCFeedItem[]` to props
- Replace NC placeholder with: `<NCFeed ncs={ncs} />`
- Add section header above feed:
  ```tsx
  <div className="space-y-3">
    <h3 className="text-sm font-medium text-foreground">Ultimas Nao-Conformidades</h3>
    <NCFeed ncs={ncs} />
  </div>
  ```

**Step 3: Update page.tsx** (Server Component)
- Import getRecentNCs from queries/dashboard
- Fetch NCs: `const ncs = await getRecentNCs(id)`
- Pass to ObraDashboard: `<ObraDashboard kpis={kpis} ncs={ncs} />`
  </action>
  <verify>
Run dev server and visit /app/obras/[id]:
```bash
cd arden && npm run dev
```
- NC feed section visible
- Shows empty state message (since no NC data exists)
- No console errors
  </verify>
  <done>NC feed displays with proper empty state, ready to show real NCs when data exists</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes without errors
2. date-fns in package.json dependencies
3. Visit /app/obras/[id] - NC feed section visible
4. Empty state shows "Nenhuma nao-conformidade registrada"
5. "Ver todas as NCs" link visible
6. No console errors
</verification>

<success_criteria>
- NC feed component renders in dashboard
- Empty state handled gracefully with Portuguese message
- When NCs exist, they show servico + unidade + relative date in Portuguese
- AlertCircle icon indicates NC severity
- "Ver todas" link present (non-functional placeholder is acceptable)
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard/06-02-SUMMARY.md`
</output>
