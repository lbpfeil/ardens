---
phase: 05.2-tags-revisao-condicional
plan: 04
type: execute
wave: 3
depends_on: ["05.2-01", "05.2-02"]
files_modified:
  - arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx
  - arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx
  - arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx
  - arden/lib/validations/item-servico.ts
autonomous: true

must_haves:
  truths:
    - "Item form modal has tag selector dropdown"
    - "Items table shows grouped by tag with colored border"
    - "Untagged items appear first without header"
    - "Tag groups show in ordem sequence"
  artifacts:
    - path: "arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx"
      provides: "Item form with tag selector"
      min_lines: 80
    - path: "arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx"
      provides: "Items panel with tag grouping"
      min_lines: 100
  key_links:
    - from: "arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx"
      to: "arden/lib/supabase/queries/tags.ts"
      via: "fetches tags for selector"
      pattern: "from.*queries/tags"
    - from: "arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx"
      to: "arden/lib/supabase/queries/tags.ts"
      via: "receives tags for grouping"
      pattern: "Tag\\[\\]"
---

<objective>
Add tag selector to item form modal and implement grouped items table display.

Purpose: Allow engineers to assign tags to items and see them grouped visually
Output: Item form with tag selector, items table grouped by tag with colored borders
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05.2-tags-revisao-condicional/REQUIREMENTS.md
@.planning/phases/05.2-tags-revisao-condicional/05.2-RESEARCH.md
@arden/lib/supabase/queries/tags.ts
@arden/lib/supabase/queries/itens-servico.ts
@arden/lib/validations/item-servico.ts
@arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx
@arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx
@arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update item form modal with tag selector</name>
  <files>arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx, arden/lib/validations/item-servico.ts</files>
  <action>
1. Update item-servico.ts validation schema to include tag_id:

```typescript
// arden/lib/validations/item-servico.ts
export const itemServicoFormSchema = z.object({
  observacao: requiredString(3, 1000, 'Observacao'),
  metodo: optionalString(1000),
  tolerancia: optionalString(500),
  tag_id: z.string().uuid().nullable().optional(), // Add this
})

export type ItemServicoFormData = z.infer<typeof itemServicoFormSchema>
```

2. Update item-servico-form-modal.tsx to include tag selector:

```typescript
// Add imports
import { listTags, type Tag } from '@/lib/supabase/queries/tags'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'

interface ItemServicoFormModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
  servicoId: string
  mode?: 'create' | 'edit'
  item?: ItemServico | null
  tags: Tag[]  // Add this prop - tags passed from parent
}

export function ItemServicoFormModal({
  open,
  onOpenChange,
  onSuccess,
  servicoId,
  mode = 'create',
  item = null,
  tags,  // Receive tags from parent
}: ItemServicoFormModalProps) {
  // ... existing state ...

  const defaultValues = useMemo(
    () => ({
      observacao: item?.observacao ?? '',
      metodo: item?.metodo ?? '',
      tolerancia: item?.tolerancia ?? '',
      tag_id: item?.tag_id ?? null,  // Add this
    }),
    [item]
  )

  // ... form setup ...

  const tagId = watch('tag_id')

  const onSubmit = async (data: ItemServicoFormData) => {
    setIsSubmitting(true)
    try {
      const cleanedData = {
        observacao: data.observacao,
        metodo: data.metodo || null,
        tolerancia: data.tolerancia || null,
        tag_id: data.tag_id || null,  // Add this
      }

      if (mode === 'edit' && item) {
        await updateItemServico(item.id, cleanedData)
        toast.success('Item atualizado com sucesso')
      } else {
        await createItemServico({
          servico_id: servicoId,
          ...cleanedData,
        })
        toast.success('Item criado com sucesso')
      }
      onSuccess()
    } catch (error) {
      // ... error handling ...
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[500px]">
        {/* ... header ... */}

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* ... existing fields (observacao, metodo, tolerancia) ... */}

          {/* Tag Selector - add after tolerancia */}
          <div className="space-y-2">
            <Label htmlFor="tag_id">Tag</Label>
            <Select
              value={tagId ?? 'none'}
              onValueChange={(value) => setValue('tag_id', value === 'none' ? null : value)}
            >
              <SelectTrigger className="w-full">
                <SelectValue placeholder="Sem tag" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="none">Sem tag</SelectItem>
                {tags.map((tag) => (
                  <SelectItem key={tag.id} value={tag.id}>
                    <div className="flex items-center gap-2">
                      <div
                        className="h-3 w-3 rounded-sm flex-shrink-0"
                        style={{ backgroundColor: tag.cor }}
                      />
                      {tag.nome}
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <p className="text-xs text-foreground-muted">
              Tags agrupam itens na tabela de verificacao
            </p>
          </div>

          {/* ... footer ... */}
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

Note: Use value='none' for the "Sem tag" option because Select doesn't accept empty string or null as value.
  </action>
  <verify>
- `grep "tag_id" arden/lib/validations/item-servico.ts` shows field in schema
- `grep "tags:" arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx` shows tags prop
- `grep "SelectItem" arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx` shows tag selector
  </verify>
  <done>Item form modal has tag selector with color preview</done>
</task>

<task type="auto">
  <name>Task 2: Update itens panel for grouped display</name>
  <files>arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx</files>
  <action>
Rewrite itens-servico-panel.tsx to display items grouped by tag:

```typescript
'use client'

import { useMemo } from 'react'
import { Plus, ListChecks, MoreVertical, Trash2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import type { Servico } from '@/lib/supabase/queries/servicos'
import type { ItemServico } from '@/lib/supabase/queries/itens-servico'
import type { Tag } from '@/lib/supabase/queries/tags'

interface ItensServicoPanelProps {
  servico: Servico
  itens: ItemServico[]
  tags: Tag[]  // Add tags prop
  onCreateClick: () => void
  onEditClick: (item: ItemServico) => void
  onDeleteClick: (item: ItemServico) => void
}

interface GroupedItems {
  tag: Tag | null  // null = untagged group
  items: ItemServico[]
}

export function ItensServicoPanel({
  servico,
  itens,
  tags,
  onCreateClick,
  onEditClick,
  onDeleteClick,
}: ItensServicoPanelProps) {

  // Group items by tag
  const groupedItems = useMemo((): GroupedItems[] => {
    // Build tag map for quick lookup
    const tagMap = new Map(tags.map(t => [t.id, t]))

    // Group items
    const untagged: ItemServico[] = []
    const byTag = new Map<string, ItemServico[]>()

    for (const item of itens) {
      if (!item.tag_id) {
        untagged.push(item)
      } else {
        const existing = byTag.get(item.tag_id) || []
        existing.push(item)
        byTag.set(item.tag_id, existing)
      }
    }

    // Build result: untagged first, then tags in ordem
    const result: GroupedItems[] = []

    // Add untagged group if any
    if (untagged.length > 0) {
      result.push({ tag: null, items: untagged.sort((a, b) => a.ordem - b.ordem) })
    }

    // Add tagged groups in tag ordem
    const sortedTags = tags.sort((a, b) => a.ordem - b.ordem)
    for (const tag of sortedTags) {
      const tagItems = byTag.get(tag.id)
      if (tagItems && tagItems.length > 0) {
        result.push({
          tag,
          items: tagItems.sort((a, b) => a.ordem - b.ordem),
        })
      }
    }

    return result
  }, [itens, tags])

  // Empty state
  if (itens.length === 0) {
    return (
      <div className="space-y-4">
        {/* Panel header */}
        <div className="flex items-center justify-between">
          <h2 className="text-lg font-medium text-foreground">
            Itens de Verificacao
          </h2>
          <Button onClick={onCreateClick}>
            <Plus className="h-4 w-4 mr-1.5" data-icon="inline-start" />
            Novo Item
          </Button>
        </div>

        {/* Empty state */}
        <div className="rounded-md border border-border bg-surface-100">
          <div className="flex flex-col items-center justify-center py-16 px-4 text-center">
            <ListChecks className="h-12 w-12 text-foreground-muted mb-4" />
            <p className="text-foreground-light mb-2">
              Nenhum item de verificacao cadastrado
            </p>
            <p className="text-sm text-foreground-muted mb-4">
              Adicione itens que definem o que verificar neste servico.
            </p>
            <Button onClick={onCreateClick} variant="outline" size="sm">
              <Plus className="h-4 w-4 mr-1.5" data-icon="inline-start" />
              Criar primeiro item
            </Button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {/* Panel header */}
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-medium text-foreground">
          Itens de Verificacao
        </h2>
        <Button onClick={onCreateClick}>
          <Plus className="h-4 w-4 mr-1.5" data-icon="inline-start" />
          Novo Item
        </Button>
      </div>

      {/* Grouped items */}
      <div className="space-y-4">
        {groupedItems.map((group, groupIndex) => (
          <div
            key={group.tag?.id ?? 'untagged'}
            className="rounded-md border border-border bg-surface-100 overflow-hidden"
          >
            {/* Tag header (only for tagged groups) */}
            {group.tag && (
              <div
                className="flex items-center gap-2 px-3 py-2 border-b border-border"
                style={{ borderLeftWidth: '3px', borderLeftColor: group.tag.cor }}
              >
                <span className="text-sm font-medium text-foreground">
                  {group.tag.nome}
                </span>
                <span className="text-xs text-foreground-muted">
                  ({group.items.length} {group.items.length === 1 ? 'item' : 'itens'})
                </span>
              </div>
            )}

            {/* Items table */}
            <Table>
              {groupIndex === 0 && (
                <TableHeader>
                  <TableRow>
                    <TableHead className="w-[50px]">#</TableHead>
                    <TableHead>Observacao</TableHead>
                    <TableHead className="hidden md:table-cell">Metodo</TableHead>
                    <TableHead className="w-[50px]">Acoes</TableHead>
                  </TableRow>
                </TableHeader>
              )}
              <TableBody>
                {group.items.map((item) => (
                  <TableRow key={item.id} className="group hover:bg-surface-200/50">
                    <TableCell className="text-foreground-muted">
                      {item.ordem + 1}
                    </TableCell>
                    <TableCell>
                      <p className="font-medium text-foreground max-w-[300px] truncate">
                        {item.observacao}
                      </p>
                    </TableCell>
                    <TableCell className="hidden md:table-cell">
                      <p className="text-sm text-foreground-light max-w-[200px] truncate">
                        {item.metodo || '-'}
                      </p>
                    </TableCell>
                    <TableCell>
                      <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                          <Button variant="ghost" size="icon-sm">
                            <MoreVertical className="h-4 w-4" />
                          </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="end">
                          <DropdownMenuItem onClick={() => onEditClick(item)}>
                            Editar
                          </DropdownMenuItem>
                          <DropdownMenuSeparator />
                          <DropdownMenuItem
                            variant="destructive"
                            onClick={() => onDeleteClick(item)}
                          >
                            <Trash2 className="h-4 w-4 mr-2" />
                            Excluir
                          </DropdownMenuItem>
                        </DropdownMenuContent>
                      </DropdownMenu>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>
        ))}
      </div>
    </div>
  )
}
```

Key design decisions:
- Untagged items appear first, without a header
- Tagged groups have colored left border (3px) matching tag color
- Table header only shows on first group (to avoid repetition)
- Items within each group sorted by ordem
- Groups sorted by tag.ordem
  </action>
  <verify>
- `grep "groupedItems" arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx` shows grouping logic
- `grep "borderLeftColor" arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx` shows colored border
  </verify>
  <done>Items panel displays grouped by tag with colored borders</done>
</task>

<task type="auto">
  <name>Task 3: Update servico detail client to pass tags</name>
  <files>arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx, arden/app/app/biblioteca/[id]/page.tsx</files>
  <action>
Update the servico detail page to:
1. Fetch tags and pass them to components
2. Update component props to include tags

1. Update page.tsx to fetch tags:
```typescript
// arden/app/app/biblioteca/[id]/page.tsx
import { listTags } from '@/lib/supabase/queries/tags'

export default async function ServicoDetailPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params
  const servico = await getServico(id)
  const itens = await listItensServico(id)
  const tags = await listTags()  // Add this

  return (
    <ServicoDetailClient
      servico={servico}
      initialItens={itens}
      tags={tags}  // Add this prop
    />
  )
}
```

2. Update ServicoDetailClient to accept and pass tags:
```typescript
// arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx

interface ServicoDetailClientProps {
  servico: Servico
  initialItens: ItemServico[]
  tags: Tag[]  // Add this
}

export function ServicoDetailClient({
  servico,
  initialItens,
  tags,  // Add this
}: ServicoDetailClientProps) {
  // ... existing state ...

  return (
    <div className="...">
      {/* ... existing layout ... */}

      {/* Update ItensServicoPanel call */}
      <ItensServicoPanel
        servico={servico}
        itens={itens}
        tags={tags}  // Pass tags
        onCreateClick={() => setIsCreateModalOpen(true)}
        onEditClick={(item) => { setEditingItem(item) }}
        onDeleteClick={(item) => { setDeletingItem(item) }}
      />

      {/* Update ItemServicoFormModal calls */}
      <ItemServicoFormModal
        open={isCreateModalOpen}
        onOpenChange={setIsCreateModalOpen}
        onSuccess={handleCreateSuccess}
        servicoId={servico.id}
        mode="create"
        tags={tags}  // Pass tags
      />

      <ItemServicoFormModal
        open={!!editingItem}
        onOpenChange={(open) => !open && setEditingItem(null)}
        onSuccess={handleEditSuccess}
        servicoId={servico.id}
        mode="edit"
        item={editingItem}
        tags={tags}  // Pass tags
      />

      {/* ... rest ... */}
    </div>
  )
}
```

Remember to add the Tag import: `import type { Tag } from '@/lib/supabase/queries/tags'`
  </action>
  <verify>
- `grep "listTags" arden/app/app/biblioteca/[id]/page.tsx` shows tags fetch
- `grep "tags={tags}" arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx` shows tags passed to children
  </verify>
  <done>Servico detail page fetches and passes tags to all child components</done>
</task>

</tasks>

<verification>
1. Open service detail page - items display grouped by tag
2. Create new item - tag selector appears with available tags
3. Select a tag for item - item moves to that tag group after save
4. Edit item to remove tag - item moves to untagged group
5. Tagged groups show colored left border
6. Untagged items appear first without header
</verification>

<success_criteria>
- Item form modal has tag selector dropdown with color preview
- Items table groups items by tag
- Untagged items appear first without section header
- Tagged groups have colored left border matching tag color
- Groups appear in tag.ordem sequence
- Creating/editing items with tags works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/05.2-tags-revisao-condicional/05.2-04-SUMMARY.md`
</output>
