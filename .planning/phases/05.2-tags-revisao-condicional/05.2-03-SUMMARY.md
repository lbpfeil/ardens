---
phase: 05.2-tags-revisao-condicional
plan: 03
subsystem: biblioteca
tags: [supabase, react-hook-form, conditional-logic, revision-control]

# Dependency graph
requires:
  - phase: 05.2-01
    provides: primeira_ativacao_em column for tracking activation status
  - phase: 05.1-02
    provides: servicoEditFormSchema and revision update patterns
provides:
  - updateServicoSmart function for conditional revision logic
  - checkServicoActivated helper for UI decisions
  - Draft mode indicator in form modal
  - Conditional description field based on activation status
affects: [05.2-04, 05.2-05, biblioteca-servicos]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Smart update pattern: check primeira_ativacao_em to decide update path"
    - "Conditional form schema: switch resolver based on service state"
    - "Draft mode indicator: visual feedback for unactivated services"

key-files:
  created: []
  modified:
    - arden/lib/supabase/queries/servicos.ts
    - arden/app/app/biblioteca/_components/servico-form-modal.tsx

key-decisions:
  - "updateServicoSmart checks primeira_ativacao_em to decide revision behavior"
  - "Draft mode shows gray dot indicator with 'Modo rascunho' text"
  - "Description field only appears when service was activated (needsRevisionDescription)"
  - "forceRevision parameter available for future use cases"

patterns-established:
  - "Conditional update pattern: single function handles both draft and versioned updates"
  - "State-dependent form schema: zodResolver switches based on computed state"
  - "Visual mode indicator: inline banner for draft vs versioned editing"

# Metrics
duration: 4min
completed: 2026-01-23
---

# Phase 5.2 Plan 03: Conditional Revision Logic Summary

**Smart update function that skips revision for draft services, with adaptive modal UI showing draft mode indicator**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-23T09:30:00Z
- **Completed:** 2026-01-23T09:34:00Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Created updateServicoSmart function that conditionally handles revisions based on primeira_ativacao_em
- Added checkServicoActivated helper function for UI decisions
- Updated form modal to show draft mode indicator for never-activated services
- Description field only appears when service has been activated (requires revision)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create updateServicoSmart function** - `d535f78` (feat)
2. **Task 2: Update servico form modal for conditional revision** - `73a16ba` (feat)

## Files Created/Modified

- `arden/lib/supabase/queries/servicos.ts` - Added updateServicoSmart and checkServicoActivated functions
- `arden/app/app/biblioteca/_components/servico-form-modal.tsx` - Conditional revision UI with draft mode indicator

## Decisions Made

- **updateServicoSmart checks primeira_ativacao_em:** Single function decides update path based on activation status
- **forceRevision parameter:** Added for flexibility in future use cases (manual revision bump)
- **needsRevisionDescription computed state:** Combines isEditMode && isActivated for form logic
- **Draft indicator styling:** bg-surface-100 with gray dot (bg-foreground-muted) for subtle indication
- **Error messages in Portuguese:** "Servico ja foi ativado em uma obra. Descricao da mudanca e obrigatoria."

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Conditional revision logic complete and integrated
- Ready for Plan 04: Tag attachment to services
- updateServicoSmart can be used by any component editing services

---
*Phase: 05.2-tags-revisao-condicional*
*Plan: 03*
*Completed: 2026-01-23*
