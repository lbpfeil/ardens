---
phase: 05.2
plan: 05
subsystem: biblioteca-fvs
tags: [drag-drop, dnd-kit, tags, itens-servico]

dependency_graph:
  requires: [05.2-04]
  provides: [drag-drop-items, tag-sections-reorder]
  affects: [future-item-management]

tech_stack:
  added: []
  patterns: [dnd-kit-multi-container, sortable-table-rows, optimistic-refresh]

key_files:
  created:
    - arden/app/app/biblioteca/[id]/_components/tag-sections-reorder-modal.tsx
  modified:
    - arden/lib/supabase/queries/itens-servico.ts
    - arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx
    - arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx

decisions:
  - id: dnd-mode-toggle
    choice: "Organizar button toggles drag mode instead of always-on"
    reason: "Actions dropdown conflicts with drag handles; explicit mode cleaner UX"
  - id: cross-container-tag-update
    choice: "Dragging to different tag section updates tag_id only (not ordem)"
    reason: "Simplifies cross-group moves; item keeps relative position within new tag"
  - id: tags-with-items-only
    choice: "Reorder modal shows only tags that have items in current service"
    reason: "Empty tags not relevant for section ordering in this context"

metrics:
  duration: 3 min
  completed: 2026-01-23
---

# Phase 5.2 Plan 05: Drag-and-Drop Items Summary

**TL;DR:** Drag-and-drop for items panel with @dnd-kit - reorder within tags or move between tags, plus modal for reordering tag sections.

## What Was Built

### 1. Item Tag Update Functions (`itens-servico.ts`)

Added two new functions for drag-and-drop operations:

```typescript
// Update only tag_id (for cross-group moves)
export async function updateItemTag(id: string, tagId: string | null): Promise<ItemServico>

// Update both tag_id and ordem (for positioned moves)
export async function updateItemTagAndOrder(id: string, tagId: string | null, ordem: number): Promise<ItemServico>
```

### 2. Enhanced Items Panel (`itens-servico-panel.tsx`)

Complete rewrite with drag-and-drop capabilities:

- **Drag Mode Toggle**: "Organizar" button enters drag mode
  - Shows drag handles on each row
  - Hides action dropdown menu
  - "Concluir" button exits drag mode

- **Drag Operations**:
  - Drag within same tag section: reorders items (updates ordem)
  - Drag to different tag section: moves item to new tag (updates tag_id)
  - DragOverlay shows item preview while dragging

- **Tag Section Management**:
  - "Reordenar Tags" button (visible when 2+ tags)
  - Opens modal to reorder tag sections

- **New Props**:
  - `servicoId`: Required for updateItensOrder call
  - `onRefresh`: Callback to refresh data after mutations

### 3. Tag Sections Reorder Modal (`tag-sections-reorder-modal.tsx`)

New modal component (177 lines):

- Drag-and-drop list of tags with color indicators
- Only shows tags that have items in current service
- Saves reordered tag.ordem values
- Pattern consistent with existing tags-reorder-modal.tsx

### 4. Client Component Updates (`servico-detail-client.tsx`)

- Added `itens` state for refresh capability
- Added `refreshItens` callback for data refresh
- Updated handlers to use refreshItens instead of router.refresh()
- Pass servicoId and onRefresh to ItensServicoPanel

## Technical Patterns

### Multi-Container Drag-and-Drop

```typescript
// Each tag group gets its own SortableContext
{groupedItems.map((group) => (
  <SortableContext
    key={group.tagId}
    items={group.items.map(i => i.id)}
    strategy={verticalListSortingStrategy}
  >
    {/* ... */}
  </SortableContext>
))}
```

### Group Detection for Cross-Container Moves

```typescript
const findItemGroup = useCallback((itemId: string): string | null => {
  for (const group of groupedItems) {
    if (group.items.some(i => i.id === itemId)) {
      return group.tagId
    }
  }
  return null
}, [groupedItems])
```

### Drag Mode Pattern

```typescript
const [isDragMode, setIsDragMode] = useState(false)

// In render:
{isDragMode && (
  <TableCell className="w-[40px]">
    <button {...listeners} {...attributes}>
      <GripVertical className="h-4 w-4" />
    </button>
  </TableCell>
)}
{!isDragMode && (
  <TableCell>
    <DropdownMenu>{/* ... */}</DropdownMenu>
  </TableCell>
)}
```

## Commits

| Hash | Message |
|------|---------|
| 545e391 | feat(05.2-05): add updateItemTag functions for drag-drop |
| 7c7b727 | feat(05.2-05): add drag-and-drop to items panel |
| 66ec0c9 | feat(05.2-05): create tag sections reorder modal |

## Deviations from Plan

None - plan executed exactly as written.

## Verification Checklist

- [x] "Organizar" button enters drag mode with visible drag handles
- [x] Dragging item within tag reorders (ordem updates)
- [x] Dragging item to different tag changes tag_id
- [x] DragOverlay shows item preview while dragging
- [x] "Reordenar Tags" modal allows section reordering
- [x] Changes persist after refresh

## Next Phase Readiness

Phase 5.2 complete. All 5 plans executed:

1. 05.2-01: Schema and data layer for tags
2. 05.2-02: Tags management page
3. 05.2-03: Smart edit with conditional revision
4. 05.2-04: Item tag selector in form
5. 05.2-05: Drag-and-drop for items

Ready for verification and next phase.
