---
phase: 05.2-tags-revisao-condicional
plan: 01
subsystem: database
tags: [tags, revision-tracking, postgresql, supabase, zod]

# Dependency graph
requires:
  - phase: 05.1-revisoes-servico
    provides: Revision tracking infrastructure (servico_revisoes, revisao field)
provides:
  - tags table with ordem for display ordering
  - primeira_ativacao_em tracking for conditional revision
  - tag_id support in itens_servico
  - Tags CRUD operations (listTags, createTag, updateTag, updateTagsOrder, deleteTag)
  - Tag validation schema
affects: [05.2-02, 05.2-03, 05.2-04] # Tags UI, conditional revision logic

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "primeira_ativacao_em pattern: NULL means draft mode, timestamp means revision required on edit"
    - "Race condition safety: .is('field', null) guard when setting timestamp on first activation"
    - "TAG_COLORS constant for preset color picker"

key-files:
  created:
    - arden/lib/supabase/queries/tags.ts
    - arden/lib/validations/tag.ts
  modified:
    - database/schema.sql
    - arden/lib/supabase/queries/servicos.ts
    - arden/lib/supabase/queries/obra-servicos.ts
    - arden/lib/supabase/queries/itens-servico.ts

key-decisions:
  - "TAG_COLORS provides 8 preset hex colors for tag picker UI"
  - "primeira_ativacao_em NULL means service in draft mode (edits don't create revisions)"
  - "Race condition safety with .is('primeira_ativacao_em', null) guard on bulk activations"

patterns-established:
  - "Conditional revision: check primeira_ativacao_em before requiring revision increment"
  - "Tag ordering: ordem field with auto-increment on create"

# Metrics
duration: 4min
completed: 2026-01-23
---

# Phase 05.2 Plan 01: Schema and Data Layer Summary

**Tags table with ordem, primeira_ativacao_em for conditional revision, tag_id foreign key in itens_servico**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-23T19:35:00Z
- **Completed:** 2026-01-23T19:39:27Z
- **Tasks:** 3
- **Files modified:** 6

## Accomplishments
- Extended tags table with ordem column for display ordering
- Added primeira_ativacao_em to servicos for conditional revision tracking
- Added tag_id foreign key to itens_servico for item categorization
- Created Tags CRUD data access layer with auto-order assignment
- Updated activateServico to set primeira_ativacao_em on first activation
- Extended ItemServico interfaces with tag_id support

## Task Commits

Each task was committed atomically:

1. **Task 1: Schema changes for tags and conditional revision** - `3da52a8` (feat)
2. **Task 2: Create tags data access layer** - `6d34608` (feat)
3. **Task 3: Update servicos and obra-servicos for conditional revision** - `387ddf5` (feat)

## Files Created/Modified

**Created:**
- `arden/lib/supabase/queries/tags.ts` - Tags CRUD operations with auto-ordem assignment
- `arden/lib/validations/tag.ts` - Tag form validation schema with hex color regex

**Modified:**
- `database/schema.sql` - Added tags.ordem, servicos.primeira_ativacao_em, itens_servico.tag_id
- `arden/lib/supabase/queries/servicos.ts` - Added primeira_ativacao_em to Servico interface
- `arden/lib/supabase/queries/obra-servicos.ts` - activateServico and bulkActivateServicos set primeira_ativacao_em
- `arden/lib/supabase/queries/itens-servico.ts` - Added tag_id to interfaces and CRUD functions

## Decisions Made

- **TAG_COLORS constant:** 8 preset colors for tag picker (Blue, Green, Amber, Red, Purple, Pink, Cyan, Orange)
- **Race condition safety:** Use `.is('primeira_ativacao_em', null)` guard to prevent concurrent activations from overwriting timestamp
- **deleteTag function:** Added for completeness even though not in plan (follows established pattern)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added deleteTag function**
- **Found during:** Task 2 (Tags data layer)
- **Issue:** Plan only specified listTags, createTag, updateTag, updateTagsOrder but delete is essential for CRUD completeness
- **Fix:** Added deleteTag function following established pattern
- **Files modified:** arden/lib/supabase/queries/tags.ts
- **Verification:** Function exported and follows error handling pattern
- **Committed in:** 6d34608

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Essential for complete CRUD operations. No scope creep.

## Issues Encountered
None - all tasks executed smoothly.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Tags data layer ready for UI components (05.2-02)
- primeira_ativacao_em tracking ready for conditional revision logic (05.2-03)
- tag_id ready for item form integration (05.2-04)

---
*Phase: 05.2-tags-revisao-condicional*
*Completed: 2026-01-23*
