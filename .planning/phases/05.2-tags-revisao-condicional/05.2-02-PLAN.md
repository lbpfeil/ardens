---
phase: 05.2-tags-revisao-condicional
plan: 02
type: execute
wave: 2
depends_on: ["05.2-01"]
files_modified:
  - arden/app/app/tags/page.tsx
  - arden/app/app/tags/_components/tags-page-client.tsx
  - arden/app/app/tags/_components/tag-form-modal.tsx
  - arden/app/app/tags/_components/tags-reorder-modal.tsx
  - arden/components/navigation/sidebar-global.tsx
autonomous: true

must_haves:
  truths:
    - "User can access /app/tags page from sidebar"
    - "User can see list of all tags with color preview"
    - "User can create a new tag with name and color"
    - "User can edit an existing tag"
    - "User can reorder tags via modal"
  artifacts:
    - path: "arden/app/app/tags/page.tsx"
      provides: "Tags list page entry point"
      min_lines: 10
    - path: "arden/app/app/tags/_components/tags-page-client.tsx"
      provides: "Client component with tags table and modals"
      min_lines: 80
    - path: "arden/app/app/tags/_components/tag-form-modal.tsx"
      provides: "Create/edit tag modal with color picker"
      min_lines: 60
  key_links:
    - from: "arden/app/app/tags/_components/tags-page-client.tsx"
      to: "arden/lib/supabase/queries/tags.ts"
      via: "import { listTags, createTag, updateTag }"
      pattern: "from.*queries/tags"
    - from: "arden/components/navigation/sidebar-global.tsx"
      to: "/app/tags"
      via: "SidebarItem href"
      pattern: "href.*app/tags"
---

<objective>
Create the Tags management page at /app/tags with CRUD functionality and reordering.

Purpose: Allow engineers to create and organize tags that will be used for item grouping
Output: Fully functional tags page with table, create/edit modal, and reorder modal
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05.2-tags-revisao-condicional/REQUIREMENTS.md
@.planning/phases/05.2-tags-revisao-condicional/05.2-RESEARCH.md
@arden/lib/supabase/queries/tags.ts
@arden/lib/validations/tag.ts
@arden/app/app/biblioteca/page.tsx
@arden/app/app/biblioteca/_components/biblioteca-page-client.tsx
@arden/app/app/biblioteca/_components/servico-form-modal.tsx
@arden/components/navigation/sidebar-global.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tags page and client component</name>
  <files>arden/app/app/tags/page.tsx, arden/app/app/tags/_components/tags-page-client.tsx</files>
  <action>
Create the tags page following the biblioteca pattern:

1. Server component page.tsx:
```typescript
// arden/app/app/tags/page.tsx
import { TagsPageClient } from './_components/tags-page-client'
import { listTags } from '@/lib/supabase/queries/tags'

export default async function TagsPage() {
  const tags = await listTags()
  return <TagsPageClient initialTags={tags} />
}
```

2. Client component with state management:
```typescript
// arden/app/app/tags/_components/tags-page-client.tsx
'use client'

import { useState, useCallback } from 'react'
import { Tag, listTags, updateTagsOrder } from '@/lib/supabase/queries/tags'
import { Button } from '@/components/ui/button'
import { Plus, ArrowUpDown, Tags as TagsIcon, MoreVertical } from 'lucide-react'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { TagFormModal } from './tag-form-modal'
import { TagsReorderModal } from './tags-reorder-modal'
import { toast } from 'sonner'

interface TagsPageClientProps {
  initialTags: Tag[]
}

export function TagsPageClient({ initialTags }: TagsPageClientProps) {
  const [tags, setTags] = useState<Tag[]>(initialTags)
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false)
  const [isReorderModalOpen, setIsReorderModalOpen] = useState(false)
  const [editingTag, setEditingTag] = useState<Tag | null>(null)

  const refreshTags = useCallback(async () => {
    const updated = await listTags()
    setTags(updated)
  }, [])

  const handleCreateSuccess = () => {
    setIsCreateModalOpen(false)
    refreshTags()
  }

  const handleEditSuccess = () => {
    setEditingTag(null)
    refreshTags()
  }

  const handleReorderSave = async (orderedIds: string[]) => {
    try {
      await updateTagsOrder(orderedIds)
      setIsReorderModalOpen(false)
      await refreshTags()
      toast.success('Ordem das tags atualizada')
    } catch (error) {
      toast.error('Erro ao atualizar ordem das tags')
    }
  }

  // Empty state
  if (tags.length === 0) {
    return (
      <div className="p-6 max-w-4xl">
        <div className="mb-6">
          <h1 className="text-2xl font-normal text-foreground">Tags</h1>
          <p className="text-sm text-foreground-light mt-1">
            Organize itens de verificacao em grupos
          </p>
        </div>

        <div className="rounded-md border border-border bg-surface-100">
          <div className="flex flex-col items-center justify-center py-16 px-4 text-center">
            <TagsIcon className="h-12 w-12 text-foreground-muted mb-4" />
            <p className="text-foreground-light mb-2">Nenhuma tag cadastrada</p>
            <p className="text-sm text-foreground-muted mb-4">
              Tags permitem agrupar itens de verificacao por etapa ou categoria.
            </p>
            <Button onClick={() => setIsCreateModalOpen(true)} variant="outline" size="sm">
              <Plus className="h-4 w-4 mr-1.5" data-icon="inline-start" />
              Criar primeira tag
            </Button>
          </div>
        </div>

        <TagFormModal
          open={isCreateModalOpen}
          onOpenChange={setIsCreateModalOpen}
          onSuccess={handleCreateSuccess}
          mode="create"
        />
      </div>
    )
  }

  return (
    <div className="p-6 max-w-4xl">
      {/* Header */}
      <div className="mb-6">
        <h1 className="text-2xl font-normal text-foreground">Tags</h1>
        <p className="text-sm text-foreground-light mt-1">
          Organize itens de verificacao em grupos
        </p>
      </div>

      {/* Toolbar */}
      <div className="flex items-center justify-end gap-2 mb-4">
        {tags.length > 1 && (
          <Button variant="outline" onClick={() => setIsReorderModalOpen(true)}>
            <ArrowUpDown className="h-4 w-4 mr-1.5" data-icon="inline-start" />
            Reordenar
          </Button>
        )}
        <Button onClick={() => setIsCreateModalOpen(true)}>
          <Plus className="h-4 w-4 mr-1.5" data-icon="inline-start" />
          Nova Tag
        </Button>
      </div>

      {/* Table */}
      <div className="rounded-md border border-border bg-surface-100">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-[60px]">Cor</TableHead>
              <TableHead>Nome</TableHead>
              <TableHead className="w-[60px]">Acoes</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {tags.map((tag) => (
              <TableRow key={tag.id} className="group hover:bg-surface-200/50">
                <TableCell>
                  <div
                    className="h-6 w-6 rounded-md"
                    style={{ backgroundColor: tag.cor }}
                  />
                </TableCell>
                <TableCell>
                  <span className="font-medium text-foreground">{tag.nome}</span>
                </TableCell>
                <TableCell>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button variant="ghost" size="icon-sm">
                        <MoreVertical className="h-4 w-4" />
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end">
                      <DropdownMenuItem onClick={() => setEditingTag(tag)}>
                        Editar
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>

      {/* Modals */}
      <TagFormModal
        open={isCreateModalOpen}
        onOpenChange={setIsCreateModalOpen}
        onSuccess={handleCreateSuccess}
        mode="create"
      />

      <TagFormModal
        open={!!editingTag}
        onOpenChange={(open) => !open && setEditingTag(null)}
        onSuccess={handleEditSuccess}
        mode="edit"
        tag={editingTag}
      />

      <TagsReorderModal
        open={isReorderModalOpen}
        onOpenChange={setIsReorderModalOpen}
        tags={tags}
        onSave={handleReorderSave}
      />
    </div>
  )
}
```

Note: No delete option as per REQ-02 (tags cannot be deleted).
  </action>
  <verify>Files exist and render correctly - check with `ls arden/app/app/tags/page.tsx arden/app/app/tags/_components/tags-page-client.tsx`</verify>
  <done>Tags page and client component created with table and toolbar</done>
</task>

<task type="auto">
  <name>Task 2: Create tag form modal with color picker</name>
  <files>arden/app/app/tags/_components/tag-form-modal.tsx</files>
  <action>
Create the tag form modal following servico-form-modal.tsx pattern:

```typescript
// arden/app/app/tags/_components/tag-form-modal.tsx
'use client'

import { useState, useEffect, useMemo } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { tagFormSchema, type TagFormData } from '@/lib/validations/tag'
import { createTag, updateTag, TAG_COLORS, type Tag } from '@/lib/supabase/queries/tags'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { cn } from '@/lib/utils'
import { toast } from 'sonner'

interface TagFormModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
  mode?: 'create' | 'edit'
  tag?: Tag | null
}

export function TagFormModal({
  open,
  onOpenChange,
  onSuccess,
  mode = 'create',
  tag = null,
}: TagFormModalProps) {
  const [isSubmitting, setIsSubmitting] = useState(false)

  const isEditMode = mode === 'edit'

  const defaultValues = useMemo(() => ({
    nome: tag?.nome ?? '',
    cor: tag?.cor ?? TAG_COLORS[0],
  }), [tag])

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
    setValue,
    watch,
  } = useForm<TagFormData>({
    resolver: zodResolver(tagFormSchema),
    defaultValues,
  })

  const selectedColor = watch('cor')

  // Reset form when tag changes
  useEffect(() => {
    reset(defaultValues)
  }, [tag?.id, mode, reset, defaultValues])

  const onSubmit = async (data: TagFormData) => {
    setIsSubmitting(true)
    try {
      if (mode === 'edit' && tag) {
        await updateTag(tag.id, data)
        toast.success('Tag atualizada com sucesso')
      } else {
        await createTag(data)
        toast.success('Tag criada com sucesso')
      }
      onSuccess()
    } catch (error) {
      const message = error instanceof Error
        ? error.message
        : (mode === 'edit' ? 'Erro ao atualizar tag' : 'Erro ao criar tag')
      toast.error(message)
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[400px]">
        <DialogHeader>
          <DialogTitle>{isEditMode ? 'Editar Tag' : 'Nova Tag'}</DialogTitle>
          <DialogDescription className="sr-only">
            {isEditMode ? 'Edite as informacoes da tag' : 'Preencha as informacoes da nova tag'}
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* Nome */}
          <div className="space-y-2">
            <Label htmlFor="nome">Nome *</Label>
            <Input
              id="nome"
              placeholder="Ex: Alvenaria, Pintura, Etapa 1"
              {...register('nome')}
              className={errors.nome ? 'border-destructive' : ''}
            />
            {errors.nome && (
              <p className="text-destructive text-xs">{errors.nome.message}</p>
            )}
          </div>

          {/* Color Picker */}
          <div className="space-y-2">
            <Label>Cor *</Label>
            <div className="flex flex-wrap gap-2">
              {TAG_COLORS.map((color) => (
                <button
                  key={color}
                  type="button"
                  onClick={() => setValue('cor', color)}
                  className={cn(
                    "h-8 w-8 rounded-md border-2 transition-all",
                    selectedColor === color
                      ? "border-foreground scale-110"
                      : "border-transparent hover:scale-105"
                  )}
                  style={{ backgroundColor: color }}
                  aria-label={`Selecionar cor ${color}`}
                />
              ))}
            </div>
            {errors.cor && (
              <p className="text-destructive text-xs">{errors.cor.message}</p>
            )}
          </div>

          {/* Preview */}
          <div className="space-y-2">
            <Label>Preview</Label>
            <div className="flex items-center gap-2 p-3 rounded-md bg-surface-100 border border-border">
              <div
                className="h-4 w-1 rounded-full"
                style={{ backgroundColor: selectedColor }}
              />
              <span className="text-foreground text-sm">
                {watch('nome') || 'Nome da tag'}
              </span>
            </div>
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
              disabled={isSubmitting}
            >
              Cancelar
            </Button>
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting
                ? (isEditMode ? 'Salvando...' : 'Criando...')
                : (isEditMode ? 'Salvar' : 'Criar Tag')
              }
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

Key features:
- Preset color palette (8 colors from RESEARCH.md)
- Visual feedback on selected color (scale + border)
- Live preview of tag appearance
- Validation via Zod schema
  </action>
  <verify>`grep "TAG_COLORS" arden/app/app/tags/_components/tag-form-modal.tsx` shows color picker implementation</verify>
  <done>Tag form modal created with color picker and live preview</done>
</task>

<task type="auto">
  <name>Task 3: Create tags reorder modal and add to sidebar</name>
  <files>arden/app/app/tags/_components/tags-reorder-modal.tsx, arden/components/navigation/sidebar-global.tsx</files>
  <action>
1. Create reorder modal using dnd-kit pattern from agrupamentos:

```typescript
// arden/app/app/tags/_components/tags-reorder-modal.tsx
'use client'

import { useState, useEffect } from 'react'
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  type DragEndEvent,
} from '@dnd-kit/core'
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
  useSortable,
} from '@dnd-kit/sortable'
import { CSS } from '@dnd-kit/utilities'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { GripVertical } from 'lucide-react'
import type { Tag } from '@/lib/supabase/queries/tags'

interface SortableTagItemProps {
  tag: Tag
}

function SortableTagItem({ tag }: SortableTagItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: tag.id })

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  }

  return (
    <li
      ref={setNodeRef}
      style={style}
      className={`flex items-center gap-3 px-3 py-2.5 bg-surface-100 border border-border rounded-md ${
        isDragging ? 'opacity-50' : ''
      }`}
    >
      <button
        type="button"
        className="touch-none cursor-grab active:cursor-grabbing text-foreground-muted hover:text-foreground"
        {...attributes}
        {...listeners}
      >
        <GripVertical className="h-4 w-4" />
      </button>
      <div
        className="h-4 w-4 rounded-sm flex-shrink-0"
        style={{ backgroundColor: tag.cor }}
      />
      <span className="text-foreground text-sm">{tag.nome}</span>
    </li>
  )
}

interface TagsReorderModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  tags: Tag[]
  onSave: (orderedIds: string[]) => Promise<void>
}

export function TagsReorderModal({
  open,
  onOpenChange,
  tags,
  onSave,
}: TagsReorderModalProps) {
  const [pendingOrder, setPendingOrder] = useState<string[]>([])
  const [isSaving, setIsSaving] = useState(false)

  // Initialize order when modal opens
  useEffect(() => {
    if (open) {
      setPendingOrder(tags.map(t => t.id))
    }
  }, [open, tags])

  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  )

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event
    if (over && active.id !== over.id) {
      setPendingOrder((items) => {
        const oldIndex = items.indexOf(active.id as string)
        const newIndex = items.indexOf(over.id as string)
        return arrayMove(items, oldIndex, newIndex)
      })
    }
  }

  const handleSave = async () => {
    setIsSaving(true)
    try {
      await onSave(pendingOrder)
    } finally {
      setIsSaving(false)
    }
  }

  // Get tags in pending order
  const orderedTags = pendingOrder
    .map(id => tags.find(t => t.id === id))
    .filter((t): t is Tag => t !== undefined)

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[400px]">
        <DialogHeader>
          <DialogTitle>Reordenar Tags</DialogTitle>
          <DialogDescription>
            Arraste para definir a ordem de exibicao das tags.
          </DialogDescription>
        </DialogHeader>

        <DndContext
          sensors={sensors}
          collisionDetection={closestCenter}
          onDragEnd={handleDragEnd}
        >
          <SortableContext
            items={pendingOrder}
            strategy={verticalListSortingStrategy}
          >
            <ul className="space-y-2 max-h-[300px] overflow-y-auto py-2">
              {orderedTags.map((tag) => (
                <SortableTagItem key={tag.id} tag={tag} />
              ))}
            </ul>
          </SortableContext>
        </DndContext>

        <DialogFooter>
          <Button
            type="button"
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isSaving}
          >
            Cancelar
          </Button>
          <Button onClick={handleSave} disabled={isSaving}>
            {isSaving ? 'Salvando...' : 'Salvar Ordem'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

2. Add Tags link to sidebar-global.tsx:
- Find the existing navigation items (should include Home, Obras, Biblioteca FVS)
- Add Tags item after Biblioteca FVS:
```tsx
<SidebarItem
  href="/app/tags"
  icon={Tags}
  label="Tags"
  isActive={pathname === '/app/tags'}
/>
```
- Import Tags icon from lucide-react
  </action>
  <verify>
- `grep "SortableTagItem" arden/app/app/tags/_components/tags-reorder-modal.tsx` shows reorder modal
- `grep "app/tags" arden/components/navigation/sidebar-global.tsx` shows sidebar link
  </verify>
  <done>Tags reorder modal created, Tags link added to global sidebar</done>
</task>

</tasks>

<verification>
1. Navigate to /app/tags - page renders with table or empty state
2. Click "Nova Tag" - modal opens with name input and color picker
3. Create a tag - appears in table with correct color
4. Edit a tag - modal pre-fills existing values
5. Reorder tags (if >1) - drag-and-drop works, order persists
6. Sidebar shows Tags link and navigates correctly
</verification>

<success_criteria>
- /app/tags page renders tags table
- Create tag modal has name field and color picker palette
- Edit tag modal pre-fills values
- Reorder modal has drag-and-drop functionality
- Sidebar includes Tags navigation item
- No delete functionality (per REQ-02)
</success_criteria>

<output>
After completion, create `.planning/phases/05.2-tags-revisao-condicional/05.2-02-SUMMARY.md`
</output>
