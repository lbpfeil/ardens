---
phase: 12-modelo-de-status
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - arden/lib/supabase/queries/verificacoes.ts
  - arden/lib/validations/verificacao.ts
  - arden/lib/supabase/actions/verificacoes.ts
  - arden/lib/supabase/actions/itens-verificacao.ts
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx
autonomous: true

must_haves:
  truths:
    - "O tipo TypeScript de status da verificação usa os novos nomes: pendente | em_andamento | verificado_com_pendencias | verificacao_finalizada"
    - "O schema Zod de status aceita os novos valores e rejeita os antigos"
    - "A função isVerificacaoTravada usa verificacao_finalizada em vez de concluida"
    - "A função deriveMatrizCellStatus mapeia verificado_com_pendencias e verificacao_finalizada corretamente"
    - "O projeto compila sem erros (npm run build passa)"
    - "Dashboard e matriz funcionam sem regressão"
  artifacts:
    - path: "arden/lib/supabase/queries/verificacoes.ts"
      provides: "Tipo MatrizVerificacao com novo status union"
      contains: "verificado_com_pendencias"
    - path: "arden/lib/validations/verificacao.ts"
      provides: "Schema Zod com novos valores de ENUM"
      contains: "verificacao_finalizada"
    - path: "arden/lib/supabase/actions/verificacoes.ts"
      provides: "Helper isVerificacaoTravada com novo ENUM"
      contains: "verificacao_finalizada"
    - path: "arden/lib/supabase/actions/itens-verificacao.ts"
      provides: "Helper isVerificacaoTravada com novo ENUM"
      contains: "verificacao_finalizada"
    - path: "arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts"
      provides: "Função deriveMatrizCellStatus com novos ENUMs"
      contains: "verificado_com_pendencias"
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx"
      provides: "isLocked check com verificacao_finalizada"
      contains: "verificacao_finalizada"
  key_links:
    - from: "arden/lib/supabase/queries/verificacoes.ts"
      to: "arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts"
      via: "MatrizVerificacao type com campo status"
      pattern: "MatrizVerificacao"
    - from: "arden/lib/validations/verificacao.ts"
      to: "arden/lib/supabase/actions/verificacoes.ts"
      via: "atualizarStatusSchema importado pela action"
      pattern: "atualizarStatusSchema"
---

<objective>
Atualizar todas as referências TypeScript aos valores antigos do ENUM (concluida → verificacao_finalizada, com_nc → verificado_com_pendencias) para que o frontend compile e funcione corretamente com o novo modelo de banco.

Purpose: Garantir que o portal web funciona sem regressão após a migration de banco, com tipos, validações e lógica de status atualizados.
Output: 6 arquivos TypeScript atualizados, build passando sem erros.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-modelo-de-status/12-CONTEXT.md
@.planning/phases/12-modelo-de-status/12-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Atualizar tipos e validações (queries + Zod)</name>
  <files>arden/lib/supabase/queries/verificacoes.ts, arden/lib/validations/verificacao.ts</files>
  <action>
**Arquivo 1: arden/lib/supabase/queries/verificacoes.ts**

Na interface `MatrizVerificacao` (linha 32), alterar o union type de status:
- DE: `status: 'pendente' | 'em_andamento' | 'concluida' | 'com_nc'`
- PARA: `status: 'pendente' | 'em_andamento' | 'verificado_com_pendencias' | 'verificacao_finalizada'`

Nenhuma outra alteração necessária neste arquivo. A interface `VerificacaoComItens` usa `status: string` (linha 75), então não precisa mudar.

**Arquivo 2: arden/lib/validations/verificacao.ts**

No schema `atualizarStatusSchema` (linha 48-54):
- Atualizar o comentário (linha 47): `Status: pendente, em_andamento, verificado_com_pendencias, verificacao_finalizada.`
- Atualizar o z.enum (linha 50):
  - DE: `z.enum(['pendente', 'em_andamento', 'concluida', 'com_nc']`
  - PARA: `z.enum(['pendente', 'em_andamento', 'verificado_com_pendencias', 'verificacao_finalizada']`

Nenhuma outra alteração nos schemas de validação. Os schemas `marcarItemSchema` e `marcarItemReinspecaoSchema` operam no nível de item (status_inspecao / status_reinspecao), que NÃO mudou.
  </action>
  <verify>
Executar `cd arden && npx tsc --noEmit` para verificar que os tipos estão consistentes. Sem erros de tipo.
  </verify>
  <done>
- MatrizVerificacao usa novos nomes de ENUM no tipo TypeScript
- Schema Zod aceita verificado_com_pendencias e verificacao_finalizada
- Schema Zod rejeita concluida e com_nc
  </done>
</task>

<task type="auto">
  <name>Task 2: Atualizar lógica de status (actions + matriz + UI)</name>
  <files>arden/lib/supabase/actions/verificacoes.ts, arden/lib/supabase/actions/itens-verificacao.ts, arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts, arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx</files>
  <action>
**Arquivo 3: arden/lib/supabase/actions/verificacoes.ts**

Na função `isVerificacaoTravada` (linha 31):
- DE: `verif.status === 'concluida'`
- PARA: `verif.status === 'verificacao_finalizada'`

Nenhuma outra alteração neste arquivo. A action `criarVerificacao` insere `status: 'pendente'` (não mudou). A action `atualizarStatusVerificacao` usa o schema Zod (já atualizado na Task 1).

**Arquivo 4: arden/lib/supabase/actions/itens-verificacao.ts**

Na função `isVerificacaoTravada` (linha 47):
- DE: `verificacao.status === 'concluida'`
- PARA: `verificacao.status === 'verificacao_finalizada'`

Nenhuma outra alteração. As actions de item (`marcarItemVerificacao`, `marcarItemReinspecao`) operam no nível de `itens_verificacao` com status_inspecao / status_reinspecao, que NÃO mudaram.

**Arquivo 5: arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts**

Na função `deriveMatrizCellStatus` (linhas 45-59):
- Linha 47: DE `if (status === 'concluida')` → PARA `if (status === 'verificacao_finalizada')`
- Linha 53: DE `if (status === 'com_nc')` → PARA `if (status === 'verificado_com_pendencias')`

A lógica interna de cada bloco (itens_excecao, tem_reinspecao) permanece idêntica. O tratamento de `em_andamento` como `pendente` visualmente (linha 59) também não muda.

**Arquivo 6: arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx**

No cálculo de `isLocked` (linha 51):
- DE: `verificacao.status === 'concluida'`
- PARA: `verificacao.status === 'verificacao_finalizada'`

Nenhuma outra alteração neste componente.

**IMPORTANTE — O que NÃO muda:**
- `arden/lib/supabase/queries/dashboard.ts`: A propriedade `concluidas` no dashboard é um nome de métrica (conta itens concluídos), NÃO é um valor de ENUM. Não precisa ser alterada.
- `arden/app/app/obras/[id]/_components/kpi-section.tsx`: Exibe KPI `concluidas` como label, sem referência ao ENUM.
- Nenhum arquivo de UI do dashboard referencia os valores do ENUM diretamente.
  </action>
  <verify>
1. Executar `cd arden && npm run build` — deve completar sem erros.
2. Verificar via grep que NENHUMA referência aos valores antigos existe no código TypeScript:
   ```bash
   grep -rn "=== 'concluida'" arden/lib/ arden/app/
   grep -rn "=== 'com_nc'" arden/lib/ arden/app/
   grep -rn "'concluida'" arden/lib/validations/
   grep -rn "'com_nc'" arden/lib/validations/
   ```
   Exceções aceitas: dashboard.ts pode ter `concluidas` como nome de propriedade (NÃO é valor de ENUM).
3. Abrir `http://localhost:3000` e navegar para uma obra → verificações → matriz. O heatmap deve renderizar corretamente.
  </verify>
  <done>
- Todas as comparações `=== 'concluida'` substituídas por `=== 'verificacao_finalizada'`
- Todas as comparações `=== 'com_nc'` substituídas por `=== 'verificado_com_pendencias'`
- Build do Next.js passa sem erros
- Matriz e dashboard funcionam sem regressão visual
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passa sem erros no diretório arden/
2. Grep confirma zero referências a valores antigos do ENUM em código de lógica (exceto dashboard `concluidas` que é nome de métrica)
3. Tipos TypeScript consistentes com o banco de dados
4. Matriz exibe heatmap corretamente com novos ENUMs
5. Verificação individual exibe estado locked/unlocked corretamente
</verification>

<success_criteria>
- Projeto compila sem erros
- Zero referências a 'concluida' como valor de ENUM no código TypeScript
- Zero referências a 'com_nc' como valor de ENUM no código TypeScript
- MatrizVerificacao.status typed como union dos 4 novos valores
- deriveMatrizCellStatus mapeia os novos ENUMs para os 6 estados visuais do heatmap
- Dashboard e KPIs continuam funcionando (sem regressão)
</success_criteria>

<output>
After completion, create `.planning/phases/12-modelo-de-status/12-02-SUMMARY.md`
</output>
