---
phase: 12-modelo-de-status
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/schema.sql
  - database/rls-policies.sql
autonomous: true

must_haves:
  truths:
    - "O ENUM status_verificacao possui os valores: pendente, em_andamento, verificado_com_pendencias, verificacao_finalizada"
    - "O trigger atualizar_contadores_verificacao calcula o status com prioridade: NC aberta > Todos finalizados > Progresso > Pendente"
    - "Exceção NÃO conta como progresso (verificação com apenas Exceção + Não Verificado permanece Pendente)"
    - "A RPC bulk_verificar referencia os novos nomes de ENUM (verificacao_finalizada em vez de concluida, verificado_com_pendencias em vez de com_nc)"
    - "Todas as verificações existentes têm status recalculado pela nova lógica"
    - "Trigger dispara automaticamente ao alterar itens_verificacao e recalcula verificacoes.status"
  artifacts:
    - path: "database/schema.sql"
      provides: "Documentação do ENUM renomeado e trigger refatorado"
      contains: "verificado_com_pendencias"
    - path: "database/rls-policies.sql"
      provides: "Política RLS atualizada com novo nome de ENUM"
      contains: "verificacao_finalizada"
  key_links:
    - from: "trigger atualizar_contadores_verificacao"
      to: "verificacoes.status"
      via: "CASE com prioridade NC > Finalizado > Em Andamento > Pendente"
      pattern: "verificado_com_pendencias.*verificacao_finalizada.*em_andamento.*pendente"
    - from: "INSERT/UPDATE itens_verificacao"
      to: "verificacoes.status recalculado via trigger"
      via: "trigger atualizar_contadores_verificacao dispara em AFTER INSERT OR UPDATE OR DELETE"
      pattern: "AFTER INSERT OR UPDATE OR DELETE ON itens_verificacao"
    - from: "bulk_verificar"
      to: "verificacoes.status"
      via: "Comparação de status existente"
      pattern: "verificacao_finalizada|verificado_com_pendencias"
---

<objective>
Migrar o banco de dados para o novo modelo de status de 4 estados, renomeando o ENUM, refatorando o trigger de cálculo automático com lógica de prioridade, atualizando a RPC bulk_verificar, e recalculando todos os dados existentes.

Purpose: Estabelecer a fundação de dados para que verificações tenham status calculado automaticamente a partir dos itens, com semântica de negócio correta (NC domina, Exceção não conta como progresso).
Output: ENUM renomeado, trigger refatorado, RPC atualizada, dados migrados, documentação SQL atualizada.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-modelo-de-status/12-CONTEXT.md
@.planning/phases/12-modelo-de-status/12-RESEARCH.md
@database/schema.sql
@database/rls-policies.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration de ENUM + Trigger + bulk_verificar + Dados</name>
  <files>database/schema.sql, database/rls-policies.sql</files>
  <action>
Aplicar UMA ÚNICA migration via Supabase MCP (`apply_migration`) com nome `refactor_status_model_v12` contendo TODOS os passos em sequência:

**Passo 1 — Renomear valores do ENUM:**
```sql
ALTER TYPE status_verificacao RENAME VALUE 'com_nc' TO 'verificado_com_pendencias';
ALTER TYPE status_verificacao RENAME VALUE 'concluida' TO 'verificacao_finalizada';
```
Os valores `pendente` e `em_andamento` permanecem inalterados.

**Passo 2 — Refatorar trigger function:**
Usar `CREATE OR REPLACE FUNCTION atualizar_contadores_verificacao()` com a nova lógica de 4 estados. A função deve:
1. Obter `v_verificacao_id` via `COALESCE(NEW.verificacao_id, OLD.verificacao_id)`
2. Calcular contadores com SELECT + FILTER aggregation (uma query, não múltiplas subqueries):
   - `v_total`: COUNT(*) total
   - `v_nc_abertas`: COUNT(*) FILTER WHERE (status = 'nao_conforme' AND status_reinspecao IS NULL) OR status_reinspecao = 'reprovado_apos_retrabalho'
   - `v_finalizados`: COUNT(*) FILTER WHERE status IN ('conforme', 'excecao') OR status_reinspecao IN ('conforme_apos_reinspecao', 'retrabalho', 'aprovado_com_concessao')
   - `v_conformes`: COUNT(*) FILTER WHERE status = 'conforme'
   - `v_verificados`: COUNT(*) FILTER WHERE status != 'nao_verificado'
   - `v_excecao`: COUNT(*) FILTER WHERE status = 'excecao'
   - `v_tem_reinspecao`: bool_or(status_reinspecao IS NOT NULL)
3. Calcular status com IF/ELSIF (prioridade estrita):
   - NC aberta > 0 → `verificado_com_pendencias`
   - Finalizados = Total → `verificacao_finalizada`
   - Conformes > 0 → `em_andamento` (Exceção NÃO conta como progresso)
   - ELSE → `pendente`
4. UPDATE verificacoes SET todos os contadores + status + updated_at = NOW()

IMPORTANTE: Manter os contadores existentes (`total_itens`, `itens_verificados`, `itens_conformes`, `itens_nc`, `itens_excecao`, `tem_reinspecao`) e atualizar `itens_nc` para contar NC abertas (não apenas `nao_conforme`).

**Passo 3 — Atualizar bulk_verificar:**
Na RPC `bulk_verificar`, substituir as duas referências de status antigos:
- Linha ~892: `IF v_existing_status = 'concluida'` → `IF v_existing_status = 'verificacao_finalizada'`
- Linha ~897: `ELSIF v_existing_status = 'com_nc'` → `ELSIF v_existing_status = 'verificado_com_pendencias'`
- Atualizar também os comentários que mencionam os nomes antigos

Copiar a função bulk_verificar completa (do schema.sql linhas 833-960) e aplicar as substituições. NÃO mudar a lógica, apenas os nomes de ENUM.

**Passo 4 — Recalcular dados existentes:**
```sql
UPDATE verificacoes SET updated_at = updated_at WHERE TRUE;
```
Isso força o trigger a recalcular todos os status com a nova lógica.

**Passo 5 — Atualizar RLS policy:**
Na policy `verificacoes_update` (rls-policies.sql linha ~443):
- `status != 'concluida'` → `status != 'verificacao_finalizada'`
Aplicar via migration separada ou incluir no mesmo bloco.

**Após aplicar migrations**, atualizar os arquivos de documentação:

1. **database/schema.sql**: Atualizar o ENUM (linhas 62-67) para os novos nomes com comentários atualizados. Atualizar a função trigger (linhas 1008-1031) com a nova implementação. Atualizar bulk_verificar (linhas 892, 897) com os novos nomes.

2. **database/rls-policies.sql**: Atualizar a policy (linha ~443) de `concluida` para `verificacao_finalizada`.
  </action>
  <verify>
Após aplicar a migration, executar via `execute_sql` do MCP Supabase:

**1. Verificar ENUM renomeado:**
```sql
SELECT enumlabel FROM pg_enum WHERE enumtypid = 'status_verificacao'::regtype ORDER BY enumsortorder;
```
Deve retornar: pendente, em_andamento, verificado_com_pendencias, verificacao_finalizada (SEM concluida ou com_nc).

**2. Verificar distribuição de status:**
```sql
SELECT status, COUNT(*) FROM verificacoes GROUP BY status ORDER BY status;
```
Deve mostrar apenas os novos nomes de ENUM.

**3. Verificar consistência NC:**
```sql
SELECT v.id, v.status
FROM verificacoes v
WHERE v.status = 'verificado_com_pendencias'
  AND NOT EXISTS (
    SELECT 1 FROM itens_verificacao iv
    WHERE iv.verificacao_id = v.id
      AND ((iv.status = 'nao_conforme' AND iv.status_reinspecao IS NULL)
           OR iv.status_reinspecao = 'reprovado_apos_retrabalho')
  );
```
Deve retornar 0 linhas (nenhuma inconsistência).

**4. Verificar que schema.sql e rls-policies.sql foram atualizados** (grep por `verificado_com_pendencias` e `verificacao_finalizada`).

**5. Testar disparo do trigger com cenários de transição (STAT-03):**

Executar os seguintes testes via `execute_sql` para confirmar que o trigger recalcula o status da verificação ao alterar itens. Usar uma verificação existente com itens para os testes:

```sql
-- 5a. Obter uma verificação de teste com itens (guardar IDs)
SELECT v.id as verificacao_id, v.status, iv.id as item_id, iv.status as item_status
FROM verificacoes v
JOIN itens_verificacao iv ON iv.verificacao_id = v.id
LIMIT 5;
```

```sql
-- 5b. Cenário: Item Pendente → NC (deve resultar em verificado_com_pendencias)
-- Selecionar um item nao_verificado e marcar como nao_conforme
UPDATE itens_verificacao
SET status = 'nao_conforme', status_reinspecao = NULL, updated_at = NOW()
WHERE id = '<item_id_do_5a>'
RETURNING verificacao_id;

-- Confirmar que a verificação pai ficou com status correto
SELECT id, status, itens_nc
FROM verificacoes
WHERE id = '<verificacao_id_do_5a>';
-- ESPERADO: status = 'verificado_com_pendencias', itens_nc >= 1
```

```sql
-- 5c. Cenário: NC → Conforme após reinspeção (deve recalcular)
-- Resolver a NC aplicando reinspeção conforme
UPDATE itens_verificacao
SET status_reinspecao = 'conforme_apos_reinspecao', updated_at = NOW()
WHERE id = '<item_id_do_5b>';

-- Verificar status do pai
SELECT id, status
FROM verificacoes
WHERE id = '<verificacao_id>';
-- ESPERADO: status NÃO deve ser 'verificado_com_pendencias' (a NC foi resolvida)
-- O status final depende dos outros itens da verificação
```

```sql
-- 5d. Cenário: Todos itens finalizados → verificacao_finalizada
-- Marcar TODOS os itens de uma verificação como conforme
UPDATE itens_verificacao
SET status = 'conforme', status_reinspecao = NULL, updated_at = NOW()
WHERE verificacao_id = '<verificacao_id>';

SELECT id, status
FROM verificacoes
WHERE id = '<verificacao_id>';
-- ESPERADO: status = 'verificacao_finalizada'
```

```sql
-- 5e. Cenário: Exceção NÃO conta como progresso
-- Resetar itens: 1 como exceção, resto como nao_verificado
UPDATE itens_verificacao
SET status = 'nao_verificado', status_reinspecao = NULL, updated_at = NOW()
WHERE verificacao_id = '<verificacao_id>';

UPDATE itens_verificacao
SET status = 'excecao', updated_at = NOW()
WHERE id = '<item_id_do_5a>';

SELECT id, status
FROM verificacoes
WHERE id = '<verificacao_id>';
-- ESPERADO: status = 'pendente' (Exceção NÃO gera em_andamento)
```

```sql
-- 5f. Restaurar dados originais ao término dos testes
-- Recalcular todas as verificações afetadas
UPDATE verificacoes SET updated_at = updated_at WHERE TRUE;
```

IMPORTANTE: Os IDs usados nos testes 5b-5f devem vir do resultado de 5a. Executar sequencialmente e substituir os placeholders pelos IDs reais. Após os testes, executar 5f para restaurar consistência.
  </verify>
  <done>
- ENUM status_verificacao contém 4 valores com nomes de negócio corretos
- Trigger calcula status automaticamente com prioridade NC > Finalizado > Em Andamento > Pendente
- Trigger DISPARA corretamente ao inserir/atualizar itens_verificacao (confirmado pelos cenários 5b-5e)
- NC aberta domina o status (cenário 5b confirmado)
- Resolução de NC recalcula status (cenário 5c confirmado)
- Todos finalizados resulta em verificacao_finalizada (cenário 5d confirmado)
- Exceção não conta como progresso (cenário 5e confirmado)
- bulk_verificar referencia novos nomes de ENUM
- Todos os dados existentes recalculados pela nova lógica
- RLS policy atualizada
- Arquivos schema.sql e rls-policies.sql refletem o estado atual do banco
  </done>
</task>

</tasks>

<verification>
1. ENUM possui apenas: pendente, em_andamento, verificado_com_pendencias, verificacao_finalizada
2. Query de consistência NC retorna 0 linhas
3. Trigger recalcula corretamente ao inserir/atualizar itens (testado via cenários 5b-5e)
4. Transições STAT-03 validadas: Pendente→NC→Reinspeção→Finalizada e Exceção não gera progresso
5. bulk_verificar funciona sem erro de ENUM inválido
6. Arquivos SQL de documentação atualizados
</verification>

<success_criteria>
- Banco de dados opera com novo modelo de 4 estados
- Status de verificação é calculado automaticamente pelo trigger com regras de prioridade corretas
- Exceção não conta como progresso
- NC aberta (nao_conforme sem reinspeção OU reprovado_apos_retrabalho) domina o status
- Trigger dispara e recalcula ao alterar itens_verificacao (provado por cenários de transição)
- RPC bulk_verificar funciona com novos nomes
- Zero inconsistências na query de auditoria
</success_criteria>

<output>
After completion, create `.planning/phases/12-modelo-de-status/12-01-SUMMARY.md`
</output>
