---
phase: 05.1-revisoes-servico
plan: 03
type: execute
wave: 2
depends_on: ["05.1-01"]
files_modified:
  - arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx
  - arden/app/app/biblioteca/[id]/_components/revision-history-panel.tsx
  - arden/app/app/biblioteca/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Servico detail page shows revision history panel"
    - "History shows list of revisions with dates and descriptions"
    - "Revisions ordered from most recent to oldest"
    - "History loads from servico_revisoes table"
  artifacts:
    - path: "arden/app/app/biblioteca/[id]/_components/revision-history-panel.tsx"
      provides: "Revision history display component"
      contains: "ServicoRevisao"
    - path: "arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx"
      provides: "Client component with history loading"
      contains: "listServicoRevisoes"
  key_links:
    - from: "servico-detail-client.tsx"
      to: "listServicoRevisoes"
      via: "import and fetch"
      pattern: "listServicoRevisoes"
    - from: "revision-history-panel.tsx"
      to: "ServicoRevisao[]"
      via: "props"
      pattern: "revisoes.*ServicoRevisao"
---

<objective>
Implement revision history display on servico detail page

Purpose: Users need to see the complete history of changes made to a servico. This enables auditing and traceability for PBQP-H compliance. The history panel shows revision number, date, description, and optionally who made the change.

Output:
- New RevisionHistoryPanel component for displaying revision list
- Updated servico detail page to include history panel
- Data fetching for revision history
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05.1-revisoes-servico/05.1-RESEARCH.md

# Existing code to modify
@arden/app/app/biblioteca/[id]/page.tsx
@arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx
@arden/app/app/biblioteca/[id]/_components/servico-info-panel.tsx
@arden/lib/supabase/queries/servico-revisoes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create revision history panel component</name>
  <files>arden/app/app/biblioteca/[id]/_components/revision-history-panel.tsx</files>
  <action>
Create new file arden/app/app/biblioteca/[id]/_components/revision-history-panel.tsx:

```typescript
'use client'

import { Badge } from '@/components/ui/badge'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import type { ServicoRevisao } from '@/lib/supabase/queries/servico-revisoes'

interface RevisionHistoryPanelProps {
  revisoes: ServicoRevisao[]
  isLoading?: boolean
}

/**
 * Formata data para exibicao: "15 jan 2026, 14:30"
 */
function formatDate(dateString: string): string {
  const date = new Date(dateString)
  return date.toLocaleDateString('pt-BR', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  })
}

export function RevisionHistoryPanel({
  revisoes,
  isLoading = false,
}: RevisionHistoryPanelProps) {
  return (
    <Card className="bg-surface-100 border-border">
      <CardHeader className="pb-3">
        <CardTitle className="text-sm font-medium text-foreground">
          Historico de Revisoes
        </CardTitle>
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <div className="space-y-3">
            {[1, 2, 3].map((i) => (
              <div key={i} className="animate-pulse">
                <div className="flex items-start gap-3">
                  <div className="h-5 w-14 bg-surface-200 rounded" />
                  <div className="flex-1 space-y-2">
                    <div className="h-4 w-3/4 bg-surface-200 rounded" />
                    <div className="h-3 w-1/3 bg-surface-200 rounded" />
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : revisoes.length === 0 ? (
          <p className="text-sm text-foreground-muted">
            Nenhuma revisao registrada
          </p>
        ) : (
          <div className="space-y-4">
            {revisoes.map((rev, index) => (
              <div
                key={rev.id}
                className={`flex items-start gap-3 ${
                  index !== revisoes.length - 1 ? 'pb-4 border-b border-border' : ''
                }`}
              >
                <Badge
                  variant={index === 0 ? 'secondary' : 'outline'}
                  className="font-mono text-xs shrink-0"
                >
                  Rev. {rev.revisao}
                </Badge>
                <div className="min-w-0 flex-1">
                  <p className="text-sm text-foreground">{rev.descricao}</p>
                  <p className="text-xs text-foreground-muted mt-1">
                    {formatDate(rev.created_at)}
                  </p>
                </div>
              </div>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

Features:
- Shows loading skeleton while fetching
- Empty state when no revisions
- Latest revision (index 0) highlighted with secondary badge
- Dates formatted in PT-BR locale
- Border separator between revisions
  </action>
  <verify>File exists and exports RevisionHistoryPanel component</verify>
  <done>RevisionHistoryPanel component displays revision history list</done>
</task>

<task type="auto">
  <name>Task 2: Update servico detail to include history panel</name>
  <files>arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx, arden/app/app/biblioteca/[id]/page.tsx</files>
  <action>
**Update servico-detail-client.tsx:**

1. Add imports:
```typescript
import { useEffect, useState } from 'react'
import { listServicoRevisoes, type ServicoRevisao } from '@/lib/supabase/queries/servico-revisoes'
import { RevisionHistoryPanel } from './revision-history-panel'
```

2. Add state for revisions:
```typescript
const [revisoes, setRevisoes] = useState<ServicoRevisao[]>([])
const [isLoadingRevisoes, setIsLoadingRevisoes] = useState(true)
```

3. Add useEffect to load revisions:
```typescript
useEffect(() => {
  async function loadRevisoes() {
    setIsLoadingRevisoes(true)
    try {
      const data = await listServicoRevisoes(servico.id)
      setRevisoes(data)
    } catch (error) {
      console.error('Error loading revisoes:', error)
    } finally {
      setIsLoadingRevisoes(false)
    }
  }
  loadRevisoes()
}, [servico.id])
```

4. Also refresh revisions when servico is updated (after edit):
```typescript
const handleEditSuccess = () => {
  setIsEditModalOpen(false)
  router.refresh()
  // Reload revisions to show new entry
  loadRevisoes()
}
```

Extract loadRevisoes to a named function that can be called from both useEffect and handleEditSuccess.

5. Update the layout to show history panel below or beside info panel:

Currently the page has two columns on desktop:
- Left: ServicoInfoPanel (lg:w-80)
- Right: ItensServicoPanel (flex-1)

Add RevisionHistoryPanel below ServicoInfoPanel:

```typescript
return (
  <div className="flex flex-col lg:flex-row gap-6">
    {/* Left column: Info + History */}
    <div className="lg:w-80 shrink-0 space-y-6">
      <ServicoInfoPanel
        servico={servico}
        onEditClick={() => setIsEditModalOpen(true)}
      />
      <RevisionHistoryPanel
        revisoes={revisoes}
        isLoading={isLoadingRevisoes}
      />
    </div>

    {/* Right column: Itens */}
    <div className="flex-1">
      <ItensServicoPanel
        servicoId={servico.id}
        itens={itens}
        onItensChange={handleItensChange}
      />
    </div>

    {/* Edit Modal */}
    <ServicoFormModal
      open={isEditModalOpen}
      onOpenChange={setIsEditModalOpen}
      onSuccess={handleEditSuccess}
      mode="edit"
      servico={servico}
    />
  </div>
)
```

**Alternative layout if space is tight:**

If the left column becomes too tall, consider putting history in a collapsible section or below the main content on mobile. For now, keeping it simple with stacked panels in the left column.

**Note on page.tsx:**

The page.tsx is a Server Component that fetches servico and itens. It passes them to ServicoDetailClient. No changes needed to page.tsx unless we want to prefetch revisions server-side. For now, let the client fetch revisions to keep the pattern simple and allow refresh after edits.
  </action>
  <verify>
- Servico detail page shows RevisionHistoryPanel below info panel
- Revisions load when page opens
- After editing, new revision appears in history
  </verify>
  <done>Servico detail page displays revision history with all entries</done>
</task>

</tasks>

<verification>
1. Navigate to /app/biblioteca/{id} - history panel appears below info panel
2. History shows all revisions from most recent to oldest
3. Each revision shows: Rev. XX badge, description, formatted date
4. Empty state shows "Nenhuma revisao registrada" for servicos without history
5. After editing servico, new revision appears in history list
6. `npm run build` passes
</verification>

<success_criteria>
- RevisionHistoryPanel component exists and renders revision list
- Servico detail page includes RevisionHistoryPanel
- History loads from listServicoRevisoes on mount
- History refreshes after edit
- Most recent revision is visually highlighted
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-revisoes-servico/05.1-03-SUMMARY.md`
</output>
