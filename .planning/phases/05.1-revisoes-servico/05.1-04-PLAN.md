---
phase: 05.1-revisoes-servico
plan: 04
type: execute
wave: 2
depends_on: ["05.1-01"]
files_modified:
  - arden/app/app/obras/[id]/servicos/page.tsx
  - arden/app/app/obras/[id]/servicos/_components/servicos-activation-client.tsx
  - arden/app/app/obras/[id]/servicos/_components/servicos-activation-table.tsx
autonomous: true

must_haves:
  truths:
    - "Obra servicos page shows revision column for each servico"
    - "Servicos with newer revision available show indicator badge"
    - "Update button appears for servicos with newer revision"
    - "Clicking update button updates obra to latest revision"
  artifacts:
    - path: "arden/app/app/obras/[id]/servicos/_components/servicos-activation-table.tsx"
      provides: "Table with revision columns and update button"
      contains: "has_newer_revision"
    - path: "arden/app/app/obras/[id]/servicos/_components/servicos-activation-client.tsx"
      provides: "Client with revision update handler"
      contains: "updateObraServicoRevision"
  key_links:
    - from: "servicos-activation-client.tsx"
      to: "updateObraServicoRevision"
      via: "import and call"
      pattern: "updateObraServicoRevision"
    - from: "page.tsx"
      to: "listServicosForObraWithRevision"
      via: "server fetch or client fetch"
      pattern: "listServicosForObraWithRevision|revisao_ativa"
---

<objective>
Implement obra revision tracking with update indicator

Purpose: Each obra uses a specific revision of each servico. When a newer revision is available in the library, the user sees an indicator and can choose to update. This ensures obras can work at their own pace while being notified of updates.

Output:
- Obra servicos page shows revision columns (current, library)
- Visual indicator when newer revision available
- "Atualizar" button to update to latest revision
- Revision captured when activating new servicos
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05.1-revisoes-servico/05.1-RESEARCH.md

# Existing code to modify
@arden/app/app/obras/[id]/servicos/page.tsx
@arden/app/app/obras/[id]/servicos/_components/servicos-activation-client.tsx
@arden/app/app/obras/[id]/servicos/_components/servicos-activation-table.tsx
@arden/lib/supabase/queries/obra-servicos.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update page to use revision-aware data fetching</name>
  <files>arden/app/app/obras/[id]/servicos/page.tsx</files>
  <action>
Update page.tsx to include revision information in the data fetch:

Currently the page fetches servicos and obra_servicos separately and merges them. Update to include revision fields.

```typescript
import { notFound } from 'next/navigation'
import { getObra } from '@/lib/supabase/queries/obras'
import { ServicosActivationClient } from './_components/servicos-activation-client'
import { createClient } from '@/lib/supabase/server'
import type { ServicoWithRevisionStatus } from '@/lib/supabase/queries/obra-servicos'

interface PageProps {
  params: Promise<{ id: string }>
}

export default async function ObraServicosPage({ params }: PageProps) {
  const { id: obraId } = await params

  // Verify obra exists
  try {
    await getObra(obraId)
  } catch {
    notFound()
  }

  const supabase = await createClient()

  // Fetch all non-archived servicos with revision info
  const { data: servicos, error: servicosError } = await supabase
    .from('servicos')
    .select('*')
    .eq('arquivado', false)
    .order('categoria', { ascending: true })
    .order('nome', { ascending: true })

  if (servicosError) {
    console.error('Error fetching servicos:', servicosError)
  }

  // Fetch obra_servicos with revision info for this obra
  const { data: obraServicos, error: obraServicosError } = await supabase
    .from('obra_servicos')
    .select('id, servico_id, ativo, revisao_ativa')
    .eq('obra_id', obraId)

  if (obraServicosError) {
    console.error('Error fetching obra_servicos:', obraServicosError)
  }

  // Merge to get activation and revision status
  const obraServicoMap = new Map(
    (obraServicos || []).map(os => [os.servico_id, {
      id: os.id,
      ativo: os.ativo,
      revisao_ativa: os.revisao_ativa || '00',
    }])
  )

  const servicosWithRevision: ServicoWithRevisionStatus[] = (servicos || []).map(s => {
    const obraServico = obraServicoMap.get(s.id)
    const revisaoAtiva = obraServico?.revisao_ativa ?? null
    const revisaoAtual = s.revisao || '00'
    // Compare as integers to handle "09" < "10" correctly
    const hasNewer = revisaoAtiva !== null &&
      parseInt(revisaoAtiva, 10) < parseInt(revisaoAtual, 10)

    return {
      ...s,
      obra_servico_id: obraServico?.id || null,
      ativo_na_obra: !!obraServico?.ativo,
      revisao_ativa: revisaoAtiva,
      revisao_atual: revisaoAtual,
      has_newer_revision: hasNewer,
    }
  })

  return (
    <div className="p-6 bg-background min-h-full">
      <div className="max-w-5xl mx-auto">
        <div className="mb-6">
          <h1 className="text-2xl font-normal text-foreground">Servicos da Obra</h1>
          <p className="text-sm text-foreground-light mt-1">
            Selecione os servicos que serao verificados nesta obra
          </p>
        </div>
        <ServicosActivationClient
          obraId={obraId}
          initialServicos={servicosWithRevision}
        />
      </div>
    </div>
  )
}
```

Note: max-w increased from 4xl to 5xl to accommodate extra revision columns.
  </action>
  <verify>Page compiles and passes ServicoWithRevisionStatus[] to client component</verify>
  <done>Page fetches and merges revision data for display</done>
</task>

<task type="auto">
  <name>Task 2: Add revision update handler to client component</name>
  <files>arden/app/app/obras/[id]/servicos/_components/servicos-activation-client.tsx</files>
  <action>
Update servicos-activation-client.tsx to handle revision updates:

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { ServicosActivationTable } from './servicos-activation-table'
import type { ServicoWithRevisionStatus } from '@/lib/supabase/queries/obra-servicos'
import {
  activateServico,
  deactivateServico,
  updateObraServicoRevision,
} from '@/lib/supabase/queries/obra-servicos'
import { toast } from 'sonner'

interface ServicosActivationClientProps {
  obraId: string
  initialServicos: ServicoWithRevisionStatus[]
}

export function ServicosActivationClient({
  obraId,
  initialServicos,
}: ServicosActivationClientProps) {
  const router = useRouter()
  const [isUpdating, setIsUpdating] = useState<string | null>(null)

  const handleToggle = async (servico: ServicoWithRevisionStatus, checked: boolean) => {
    setIsUpdating(servico.id)
    try {
      if (checked) {
        await activateServico(obraId, servico.id)
        toast.success(`Servico "${servico.nome}" ativado (Rev. ${servico.revisao_atual})`)
      } else {
        await deactivateServico(obraId, servico.id)
        toast.success(`Servico "${servico.nome}" desativado`)
      }
      router.refresh()
    } catch (error) {
      const message = error instanceof Error ? error.message : 'Erro ao atualizar servico'
      toast.error(message)
    } finally {
      setIsUpdating(null)
    }
  }

  const handleUpdateRevision = async (servico: ServicoWithRevisionStatus) => {
    setIsUpdating(servico.id)
    try {
      await updateObraServicoRevision(obraId, servico.id)
      toast.success(
        `Servico "${servico.nome}" atualizado para Rev. ${servico.revisao_atual}`
      )
      router.refresh()
    } catch (error) {
      const message = error instanceof Error ? error.message : 'Erro ao atualizar revisao'
      toast.error(message)
    } finally {
      setIsUpdating(null)
    }
  }

  return (
    <ServicosActivationTable
      servicos={initialServicos}
      onToggle={handleToggle}
      onUpdateRevision={handleUpdateRevision}
      updatingId={isUpdating}
    />
  )
}
```
  </action>
  <verify>Client component exports handleUpdateRevision handler</verify>
  <done>Client component handles revision update action</done>
</task>

<task type="auto">
  <name>Task 3: Update table to show revision columns and update button</name>
  <files>arden/app/app/obras/[id]/servicos/_components/servicos-activation-table.tsx</files>
  <action>
Update servicos-activation-table.tsx to display revision status:

```typescript
'use client'

import { Library, RefreshCw } from 'lucide-react'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Checkbox } from '@/components/ui/checkbox'
import { Badge } from '@/components/ui/badge'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import type { ServicoWithRevisionStatus } from '@/lib/supabase/queries/obra-servicos'
import { categoriaServicoOptions } from '@/lib/validations/servico'

interface ServicosActivationTableProps {
  servicos: ServicoWithRevisionStatus[]
  onToggle: (servico: ServicoWithRevisionStatus, checked: boolean) => void
  onUpdateRevision: (servico: ServicoWithRevisionStatus) => void
  updatingId: string | null
}

function getCategoryLabel(categoria: string | null): string {
  if (!categoria) return 'Sem categoria'
  const option = categoriaServicoOptions.find(opt => opt.value === categoria)
  return option?.label ?? categoria
}

export function ServicosActivationTable({
  servicos,
  onToggle,
  onUpdateRevision,
  updatingId,
}: ServicosActivationTableProps) {
  const activeCount = servicos.filter(s => s.ativo_na_obra).length
  const outdatedCount = servicos.filter(s => s.ativo_na_obra && s.has_newer_revision).length

  // Empty state: no servicos available
  if (servicos.length === 0) {
    return (
      <div className="rounded-md border border-border bg-surface-100">
        <div className="flex flex-col items-center justify-center py-16 px-4 text-center">
          <Library className="h-12 w-12 text-foreground-muted mb-4" />
          <p className="text-foreground-light mb-2">Nenhum servico disponivel</p>
          <p className="text-sm text-foreground-muted mb-4">
            Crie servicos na Biblioteca FVS primeiro.
          </p>
          <Button asChild variant="outline" size="sm">
            <Link href="/app/biblioteca">
              Ir para Biblioteca FVS
            </Link>
          </Button>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {/* Summary */}
      <div className="flex items-center gap-4 text-sm text-foreground-light">
        <span>{activeCount} de {servicos.length} servicos ativos nesta obra</span>
        {outdatedCount > 0 && (
          <Badge variant="warning" className="text-xs">
            {outdatedCount} com revisao desatualizada
          </Badge>
        )}
      </div>

      {/* Servicos table */}
      <div className="rounded-md border border-border bg-surface-100">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-[50px]">Ativo</TableHead>
              <TableHead className="w-[100px]">Codigo</TableHead>
              <TableHead>Nome</TableHead>
              <TableHead className="w-[130px]">Categoria</TableHead>
              <TableHead className="w-[80px]">Rev. Obra</TableHead>
              <TableHead className="w-[80px]">Rev. Atual</TableHead>
              <TableHead className="w-[100px]">Acoes</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {servicos.map((servico) => {
              const isUpdating = updatingId === servico.id
              const showUpdateButton = servico.ativo_na_obra && servico.has_newer_revision

              return (
                <TableRow
                  key={servico.id}
                  className={servico.has_newer_revision && servico.ativo_na_obra ? 'bg-warning/5' : ''}
                >
                  <TableCell>
                    <Checkbox
                      checked={servico.ativo_na_obra}
                      onCheckedChange={(checked) => onToggle(servico, checked === true)}
                      disabled={isUpdating}
                      aria-label={`Ativar ${servico.nome}`}
                      className={isUpdating ? 'disabled:cursor-wait' : ''}
                    />
                  </TableCell>
                  <TableCell className="font-mono text-sm text-foreground-light">
                    {servico.codigo}
                  </TableCell>
                  <TableCell className="font-medium text-foreground">
                    {servico.nome}
                  </TableCell>
                  <TableCell>
                    <Badge variant="secondary" className="text-xs">
                      {getCategoryLabel(servico.categoria)}
                    </Badge>
                  </TableCell>
                  <TableCell>
                    {servico.ativo_na_obra ? (
                      <Badge
                        variant={servico.has_newer_revision ? 'outline' : 'secondary'}
                        className={`font-mono text-xs ${
                          servico.has_newer_revision ? 'text-foreground-muted' : ''
                        }`}
                      >
                        Rev. {servico.revisao_ativa || '00'}
                      </Badge>
                    ) : (
                      <span className="text-xs text-foreground-muted">-</span>
                    )}
                  </TableCell>
                  <TableCell>
                    <Badge variant="secondary" className="font-mono text-xs">
                      Rev. {servico.revisao_atual}
                    </Badge>
                  </TableCell>
                  <TableCell>
                    {showUpdateButton && (
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => onUpdateRevision(servico)}
                        disabled={isUpdating}
                        className="text-brand-link hover:text-brand h-7 px-2"
                      >
                        <RefreshCw className={`h-3.5 w-3.5 mr-1 ${isUpdating ? 'animate-spin' : ''}`} />
                        Atualizar
                      </Button>
                    )}
                  </TableCell>
                </TableRow>
              )
            })}
          </TableBody>
        </Table>
      </div>
    </div>
  )
}
```

Key features:
- Two revision columns: "Rev. Obra" (what obra is using) and "Rev. Atual" (library version)
- Rows with outdated revision have subtle warning background (bg-warning/5)
- "Atualizar" button appears only for active servicos with newer revision
- Summary shows count of outdated servicos
- RefreshCw icon spins while updating
  </action>
  <verify>
- Table shows Rev. Obra and Rev. Atual columns
- Outdated servicos show warning indicator
- Atualizar button appears and works
- `npm run build` passes
  </verify>
  <done>Obra servicos page shows revision status with update option</done>
</task>

</tasks>

<verification>
1. Navigate to /app/obras/{id}/servicos - table shows revision columns
2. For servicos with newer revision available:
   - Row has subtle warning background
   - "Atualizar" button visible
   - Click updates to latest revision
3. For servicos at latest revision:
   - No warning background
   - No update button
4. Activating new servico captures current library revision
5. Summary shows count of outdated servicos
6. `npm run build` passes
</verification>

<success_criteria>
- Table has Rev. Obra and Rev. Atual columns
- has_newer_revision triggers warning indicator and update button
- updateObraServicoRevision called on button click
- Toast confirms update with new revision number
- Page refreshes to show updated revision
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-revisoes-servico/05.1-04-SUMMARY.md`
</output>
