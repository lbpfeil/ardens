---
phase: 05.1-revisoes-servico
plan: 02
subsystem: ui
tags: [react-hook-form, zod, revision-control, biblioteca-fvs]

# Dependency graph
requires:
  - phase: 05.1-01
    provides: updateServicoWithRevision function, Servico type with revision fields
provides:
  - Edit form with descricao_mudanca requirement
  - Revision badge display in list and detail
  - Automatic revision increment on edit
affects: [05.1-03, 05.1-04]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Conditional schema selection based on form mode (create vs edit)
    - Inline type definition for union form data

key-files:
  created: []
  modified:
    - arden/lib/validations/servico.ts
    - arden/app/app/biblioteca/_components/servico-form-modal.tsx
    - arden/app/app/biblioteca/_components/servicos-table.tsx
    - arden/app/app/biblioteca/[id]/_components/servico-info-panel.tsx

key-decisions:
  - "servicoEditFormSchema extends base schema with descricao_mudanca"
  - "Conditional resolver: zodResolver(isEditMode ? servicoEditFormSchema : servicoFormSchema)"
  - "Badge variant='outline' for table revision, variant='secondary' for detail page"
  - "Last revision description shown only if revisao_descricao exists"

patterns-established:
  - "Dual schema pattern: separate create and edit schemas when edit requires additional fields"
  - "Mode-aware form reset: include mode-specific fields in reset defaults"

# Metrics
duration: 4min
completed: 2026-01-22
---

# Phase 5.1 Plan 02: Service Edit with Revision Increment Summary

**Edit modal requires change description, automatically increments revision, and displays revision badges in biblioteca list and detail pages**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-22T10:00:00Z
- **Completed:** 2026-01-22T10:04:00Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments

- Edit form now requires descricao_mudanca field with validation
- Edit mode uses updateServicoWithRevision (revision increments automatically)
- Servicos table displays "Rev. XX" badge for each servico
- Detail page shows revision badge and last change description

## Task Commits

Each task was committed atomically:

1. **Task 1: Add edit-specific validation schema** - `e2a4dd4` (feat)
2. **Task 2: Update form modal to handle revision increment** - `fe9b744` (feat)
3. **Task 3: Display revision in list and detail** - `f2c4e7b` (feat)

## Files Created/Modified

- `arden/lib/validations/servico.ts` - Added servicoEditFormSchema with descricao_mudanca
- `arden/app/app/biblioteca/_components/servico-form-modal.tsx` - Conditional schema, descricao_mudanca field, updateServicoWithRevision call
- `arden/app/app/biblioteca/_components/servicos-table.tsx` - Revisao column with badge
- `arden/app/app/biblioteca/[id]/_components/servico-info-panel.tsx` - Revision badge and last change description

## Decisions Made

- **Dual schema pattern:** servicoEditFormSchema extends base schema with required descricao_mudanca field (3-500 chars)
- **Conditional resolver:** Form uses zodResolver(isEditMode ? servicoEditFormSchema : servicoFormSchema) for mode-aware validation
- **Badge variants:** outline for table (consistent with existing codigo style), secondary for detail (visual distinction)
- **Conditional display:** revisao_descricao only shown if present (initial creation has no description to show)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Revision display complete in biblioteca
- Ready for Plan 03: Revision history timeline
- Ready for Plan 04: Obra activation revision tracking

---
*Phase: 05.1-revisoes-servico*
*Completed: 2026-01-22*
