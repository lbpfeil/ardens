---
phase: 05.1-revisoes-servico
plan: 01
subsystem: database, api
tags: [postgres, supabase, revision-control, pbqp-h, typescript]

# Dependency graph
requires:
  - phase: 05-biblioteca-fvs
    provides: servicos and obra-servicos data access layer
provides:
  - SQL migration for revision schema (servico_revisoes table)
  - Revision tracking columns on servicos and obra_servicos
  - servico-revisoes.ts data access layer
  - Revision-aware queries for servicos and obra-servicos
affects: [05.1-02, 05.1-03, 05.1-04, biblioteca-fvs-ui, obra-servicos-ui]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Snapshot pattern for revision history (capturing full state at revision time)
    - Revision increment with zero-padded string format (00, 01, 02...)
    - has_newer_revision computed field for UI upgrade indicators

key-files:
  created:
    - database/migrations/001_servico_revisoes.sql
    - arden/lib/supabase/queries/servico-revisoes.ts
  modified:
    - database/schema.sql
    - arden/lib/supabase/queries/servicos.ts
    - arden/lib/supabase/queries/obra-servicos.ts

key-decisions:
  - "Revision stored as VARCHAR(5) with zero-padding (00-99) for sortability"
  - "Snapshot pattern captures codigo, nome, categoria, referencia_normativa at each revision"
  - "createServico automatically creates initial revision record (rev 00)"
  - "updateServicoWithRevision requires descricao_mudanca for audit trail"
  - "activateServico captures current servico revision at activation time"
  - "has_newer_revision computed by comparing revisao_ativa vs revisao_atual"

patterns-established:
  - "Revision history with snapshot: servico_revisoes stores full field snapshot per revision"
  - "Revision-aware activation: obra_servicos tracks which revision each obra is using"
  - "Upgrade indicator pattern: has_newer_revision boolean for UI prompts"

# Metrics
duration: 5min
completed: 2026-01-22
---

# Phase 5.1 Plan 01: Schema and Data Access Layer Summary

**SQL migration and TypeScript queries for revision tracking on servicos and obra_servicos with snapshot-based history**

## Performance

- **Duration:** 5 min
- **Started:** 2026-01-22T12:00:00Z
- **Completed:** 2026-01-22T12:05:00Z
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments
- Created SQL migration with revision columns, servico_revisoes table, and RLS policies
- Implemented servico-revisoes.ts with CRUD operations for revision history
- Updated servicos.ts with revision fields and updateServicoWithRevision function
- Updated obra-servicos.ts with revision tracking and upgrade detection

## Task Commits

Each task was committed atomically:

1. **Task 1: Create SQL migration for revision schema** - `c09d93f` (feat)
2. **Task 2: Create servico-revisoes data access layer** - `a3e4896` (feat)
3. **Task 3: Update servicos and obra-servicos with revision support** - `7890098` (feat)

## Files Created/Modified
- `database/migrations/001_servico_revisoes.sql` - SQL migration with schema changes and RLS
- `database/schema.sql` - Added revision columns and servico_revisoes table definition
- `arden/lib/supabase/queries/servico-revisoes.ts` - New file for revision history operations
- `arden/lib/supabase/queries/servicos.ts` - Added revision fields and updateServicoWithRevision
- `arden/lib/supabase/queries/obra-servicos.ts` - Added revision tracking and upgrade detection

## Decisions Made

1. **Revision format as VARCHAR(5)**: Zero-padded strings (00, 01, 02) allow natural sorting and display
2. **Snapshot pattern**: Each revision stores full snapshot of servico fields for historical accuracy
3. **Automatic initial revision**: createServico creates rev 00 automatically for consistency
4. **Required change description**: updateServicoWithRevision enforces descricao_mudanca for audit
5. **Revision capture on activation**: When a servico is activated for an obra, the current revision is captured
6. **Computed upgrade indicator**: has_newer_revision allows UI to show upgrade prompts

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

**Database migration required.** The migration file must be applied to the database:

```bash
# If using Supabase local
npx supabase db push

# Or manually run
psql -f database/migrations/001_servico_revisoes.sql
```

## Next Phase Readiness
- Schema and data layer ready for UI implementation
- Plan 02 (Revision UI components) can proceed
- All exported types and functions are available for consumption

---
*Phase: 05.1-revisoes-servico*
*Completed: 2026-01-22*
