---
phase: 05.1-revisoes-servico
plan: 02
type: execute
wave: 2
depends_on: ["05.1-01"]
files_modified:
  - arden/lib/validations/servico.ts
  - arden/app/app/biblioteca/_components/servico-form-modal.tsx
  - arden/app/app/biblioteca/_components/servicos-table.tsx
  - arden/app/app/biblioteca/[id]/_components/servico-info-panel.tsx
autonomous: true

must_haves:
  truths:
    - "Edit modal shows descricao_mudanca field (required)"
    - "Edit modal calls updateServicoWithRevision instead of updateServico"
    - "Servico list shows revision badge (Rev. 00, Rev. 01, etc)"
    - "Servico detail page shows current revision"
  artifacts:
    - path: "arden/lib/validations/servico.ts"
      provides: "Edit schema with descricao_mudanca"
      exports: ["servicoEditFormSchema", "ServicoEditFormData"]
    - path: "arden/app/app/biblioteca/_components/servico-form-modal.tsx"
      provides: "Form modal with revision increment"
      contains: "descricao_mudanca"
    - path: "arden/app/app/biblioteca/_components/servicos-table.tsx"
      provides: "Table with revision column"
      contains: "Rev."
  key_links:
    - from: "servico-form-modal.tsx"
      to: "updateServicoWithRevision"
      via: "import and call"
      pattern: "updateServicoWithRevision"
    - from: "servico-form-modal.tsx"
      to: "servicoEditFormSchema"
      via: "zodResolver"
      pattern: "servicoEditFormSchema"
---

<objective>
Implement service edit with revision increment and description requirement

Purpose: When editing a servico, the user must provide a change description. The system automatically increments the revision number and records the change in history. The revision is displayed in the library list and detail pages.

Output:
- Updated validation schema with edit-specific schema requiring descricao_mudanca
- Modified form modal to require change description in edit mode
- Revision badge displayed in servicos table and detail page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05.1-revisoes-servico/05.1-RESEARCH.md

# Existing code to modify
@arden/lib/validations/servico.ts
@arden/app/app/biblioteca/_components/servico-form-modal.tsx
@arden/app/app/biblioteca/_components/servicos-table.tsx
@arden/app/app/biblioteca/[id]/_components/servico-info-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edit-specific validation schema</name>
  <files>arden/lib/validations/servico.ts</files>
  <action>
Update arden/lib/validations/servico.ts to add edit-specific schema:

Keep existing servicoFormSchema for create mode. Add new schema for edit mode that requires descricao_mudanca:

```typescript
import { z } from 'zod'
import { requiredString, optionalString } from './common'

// ... existing categoriaServicoOptions ...

// ... existing servicoFormSchema (unchanged for create) ...

/**
 * Schema de validacao para edicao de servico.
 * Requer descricao da mudanca para controle de revisao.
 */
export const servicoEditFormSchema = z.object({
  codigo: requiredString(1, 50, 'Codigo'),
  nome: requiredString(3, 255, 'Nome'),
  categoria: z.enum([
    'fundacao',
    'estrutura',
    'alvenaria',
    'revestimento',
    'acabamento',
    'instalacoes',
    'cobertura',
    'esquadrias',
    'pintura',
    'impermeabilizacao',
    'outros',
  ]).optional().nullable(),
  referencia_normativa: optionalString(500),
  descricao_mudanca: requiredString(3, 500, 'Descricao da mudanca'),
})

export type ServicoEditFormData = z.infer<typeof servicoEditFormSchema>
```

Note: requiredString helper from common.ts generates PT-BR error messages.
  </action>
  <verify>File exports servicoEditFormSchema and ServicoEditFormData</verify>
  <done>Validation schema for edit mode requires descricao_mudanca field</done>
</task>

<task type="auto">
  <name>Task 2: Update form modal to handle revision increment</name>
  <files>arden/app/app/biblioteca/_components/servico-form-modal.tsx</files>
  <action>
Modify servico-form-modal.tsx to:

1. Import both schemas and updateServicoWithRevision:
```typescript
import {
  servicoFormSchema,
  servicoEditFormSchema,
  type ServicoFormData,
  type ServicoEditFormData,
  categoriaServicoOptions,
} from '@/lib/validations/servico'
import { createServico, updateServicoWithRevision, type Servico } from '@/lib/supabase/queries/servicos'
```

2. Use conditional schema based on mode:
```typescript
// Type for form data that works for both modes
type FormData = ServicoFormData | ServicoEditFormData

const {
  register,
  handleSubmit,
  formState: { errors },
  reset,
  setValue,
  watch,
} = useForm<FormData>({
  resolver: zodResolver(isEditMode ? servicoEditFormSchema : servicoFormSchema),
  defaultValues: {
    codigo: servico?.codigo ?? '',
    nome: servico?.nome ?? '',
    categoria: servico?.categoria ?? undefined,
    referencia_normativa: servico?.referencia_normativa ?? '',
    ...(isEditMode ? { descricao_mudanca: '' } : {}),
  },
})
```

3. Add descricao_mudanca field (only in edit mode):
```typescript
{/* Descricao da Mudanca (only in edit mode, required) */}
{isEditMode && (
  <div className="space-y-2">
    <Label htmlFor="descricao_mudanca">Descricao da Mudanca *</Label>
    <Textarea
      id="descricao_mudanca"
      placeholder="Descreva o que foi alterado nesta revisao"
      {...register('descricao_mudanca')}
      className={errors.descricao_mudanca ? 'border-destructive' : ''}
    />
    {errors.descricao_mudanca && (
      <p className="text-destructive text-xs">{errors.descricao_mudanca.message}</p>
    )}
    <p className="text-xs text-foreground-muted">
      Uma nova revisao sera criada ao salvar
    </p>
  </div>
)}
```

4. Update onSubmit to use updateServicoWithRevision:
```typescript
const onSubmit = async (data: FormData) => {
  setIsSubmitting(true)
  try {
    if (mode === 'edit' && servico) {
      // Edit mode: use revision-aware update
      const editData = data as ServicoEditFormData
      await updateServicoWithRevision(servico.id, {
        codigo: editData.codigo,
        nome: editData.nome,
        categoria: editData.categoria || null,
        referencia_normativa: editData.referencia_normativa || null,
        descricao_mudanca: editData.descricao_mudanca,
      })
      toast.success('Servico atualizado com sucesso')
    } else {
      // Create mode: normal create
      const createData = data as ServicoFormData
      await createServico({
        codigo: createData.codigo,
        nome: createData.nome,
        categoria: createData.categoria || null,
        referencia_normativa: createData.referencia_normativa || null,
      })
      toast.success('Servico criado com sucesso')
    }
    onSuccess()
  } catch (error) {
    const message = error instanceof Error
      ? error.message
      : (mode === 'edit' ? 'Erro ao atualizar servico' : 'Erro ao criar servico')
    toast.error(message)
  } finally {
    setIsSubmitting(false)
  }
}
```

5. Reset form properly when switching modes:
```typescript
useEffect(() => {
  const newDefaults = {
    codigo: servico?.codigo ?? '',
    nome: servico?.nome ?? '',
    categoria: servico?.categoria ?? undefined,
    referencia_normativa: servico?.referencia_normativa ?? '',
    ...(mode === 'edit' ? { descricao_mudanca: '' } : {}),
  }
  reset(newDefaults)
}, [servico?.id, mode, reset])
```
  </action>
  <verify>
- Modal shows descricao_mudanca field in edit mode only
- Create mode still works without descricao_mudanca
- Edit mode calls updateServicoWithRevision
  </verify>
  <done>Form modal requires change description and increments revision on edit</done>
</task>

<task type="auto">
  <name>Task 3: Display revision in list and detail</name>
  <files>arden/app/app/biblioteca/_components/servicos-table.tsx, arden/app/app/biblioteca/[id]/_components/servico-info-panel.tsx</files>
  <action>
**Update servicos-table.tsx:**

1. Add Revisao column to table header (after Codigo):
```typescript
<SortableTableHeader
  field="codigo"
  currentField={sortField}
  currentDirection={sortDirection}
  onSort={onSort}
  className="w-[120px]"
>
  Codigo
</SortableTableHeader>
<TableHead className="w-[80px]">Revisao</TableHead>
```

2. Add Revisao cell to table body (after codigo cell):
```typescript
<TableCell className="font-medium">
  <span className={servico.arquivado ? 'text-foreground-muted' : ''}>
    {servico.codigo}
  </span>
</TableCell>
<TableCell>
  <Badge variant="outline" className="font-mono text-xs">
    Rev. {servico.revisao || '00'}
  </Badge>
</TableCell>
```

Note: The revisao field should be available from Servico type (updated in Plan 01). If showing issues, check that listServicos returns the revision field.

**Update servico-info-panel.tsx:**

1. Add revision badge next to codigo badge in header:
```typescript
<CardHeader className="flex flex-row items-start justify-between space-y-0 pb-2">
  <div className="space-y-1">
    <div className="flex items-center gap-2">
      <Badge variant="outline" className="font-mono text-xs">
        {servico.codigo}
      </Badge>
      <Badge variant="secondary" className="font-mono text-xs">
        Rev. {servico.revisao || '00'}
      </Badge>
    </div>
    <CardTitle className="text-lg font-medium text-foreground">
      {servico.nome}
    </CardTitle>
  </div>
  <Button variant="ghost" size="icon-sm" onClick={onEditClick}>
    <Pencil className="h-4 w-4" />
  </Button>
</CardHeader>
```

2. Add last revision description if available:
```typescript
{/* Ultima Revisao */}
{servico.revisao_descricao && (
  <div className="space-y-1">
    <p className="text-xs text-foreground-muted">Ultima Alteracao</p>
    <p className="text-sm text-foreground-light">
      {servico.revisao_descricao}
    </p>
  </div>
)}
```
  </action>
  <verify>
- Servicos table shows Revisao column with "Rev. XX" badge
- Servico detail page shows revision badge next to codigo
- Detail page shows last revision description if available
  </verify>
  <done>Revision displayed in biblioteca list and detail pages</done>
</task>

</tasks>

<verification>
1. Edit servico modal shows "Descricao da Mudanca" field (required)
2. Create servico modal does NOT show descricao_mudanca field
3. Saving edit increments revision (visible in list after refresh)
4. Servicos table shows "Rev. XX" badge for each servico
5. Servico detail page shows revision badge and last change description
6. `npm run build` passes
</verification>

<success_criteria>
- Edit modal requires descricao_mudanca (validation error if empty)
- Edit calls updateServicoWithRevision (revision increments)
- Create calls createServico (starts at Rev. 00)
- Table shows Revisao column with badge
- Detail page shows revision badge and description
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-revisoes-servico/05.1-02-SUMMARY.md`
</output>
