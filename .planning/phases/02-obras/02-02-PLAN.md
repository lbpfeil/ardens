---
phase: 02-obras
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - arden/app/app/obras/page.tsx
  - arden/app/app/obras/_components/obras-table.tsx
  - arden/app/app/obras/_components/obra-form-modal.tsx
  - arden/app/app/obras/_components/status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "Usuario ve lista de todas as obras do cliente na pagina /app/obras"
    - "Usuario pode criar nova obra preenchendo formulario e obra aparece na lista"
    - "Tabela mostra Nome, Status, Progresso, Data criacao, Acoes"
    - "Toolbar tem campo de busca e filtro de status"
  artifacts:
    - path: "arden/app/app/obras/page.tsx"
      provides: "Obras list page with Server Component data fetching"
      min_lines: 40
    - path: "arden/app/app/obras/_components/obras-table.tsx"
      provides: "Client component table with columns and row click navigation"
      min_lines: 80
    - path: "arden/app/app/obras/_components/obra-form-modal.tsx"
      provides: "Modal form for creating obras using RHF + Zod"
      min_lines: 100
  key_links:
    - from: "arden/app/app/obras/page.tsx"
      to: "listObras query"
      via: "server-side data fetch"
      pattern: "listObras"
    - from: "arden/app/app/obras/_components/obras-table.tsx"
      to: "/app/obras/[id]"
      via: "router.push on row click"
      pattern: "router.push.*obras"
    - from: "arden/app/app/obras/_components/obra-form-modal.tsx"
      to: "createObra mutation"
      via: "form onSubmit handler"
      pattern: "createObra"
---

<objective>
Create obras list page with table display and create functionality. Users can view all their obras in a table and create new ones via modal.

Purpose: Core listing and creation - the primary interface for obras management in "Visao Global" context.
Output: Working /app/obras page with table and functional "Nova Obra" modal.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-obras/02-RESEARCH.md
@.planning/phases/02-obras/02-CONTEXT.md
@.planning/phases/02-obras/02-01-SUMMARY.md
@arden/lib/validations/obra.ts
@arden/lib/supabase/queries/obras.ts
@arden/components/ui/table.tsx
@arden/components/ui/dialog.tsx
@docs/design/DESIGN-SYSTEM.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create obras list page with table</name>
  <files>
    arden/app/app/obras/page.tsx
    arden/app/app/obras/_components/obras-table.tsx
    arden/app/app/obras/_components/status-badge.tsx
  </files>
  <action>
    Create the obras route directory and page:

    **1. Create arden/app/app/obras/_components/status-badge.tsx:**
    Simple component using Badge to show Ativa (green) or Arquivada (gray):
    ```typescript
    'use client'

    import { Badge } from '@/components/ui/badge'

    interface StatusBadgeProps {
      arquivada: boolean
    }

    export function StatusBadge({ arquivada }: StatusBadgeProps) {
      return (
        <Badge variant={arquivada ? 'secondary' : 'default'}>
          {arquivada ? 'Arquivada' : 'Ativa'}
        </Badge>
      )
    }
    ```

    **2. Create arden/app/app/obras/_components/obras-table.tsx:**
    Client component with:
    - Props: obras array, onCreateClick callback
    - Local state for search filter and status filter (Ativas/Arquivadas/Todas)
    - Toolbar: Input for search + Select for status filter + Button "Nova Obra"
    - Table with columns: Nome, Status (badge), Progresso (placeholder 0% for now), Data criacao, Acoes (DropdownMenu)
    - Row click navigates to /app/obras/[id] using router.push
    - Dropdown actions: "Editar" (disabled for now), "Arquivar" (disabled for now)
    - Use e.stopPropagation() on dropdown trigger to prevent row click
    - Empty state: "Nenhuma obra encontrada" with suggestion to create first obra
    - Use Skeleton components while loading (accept isLoading prop)

    Filter logic:
    - Search filters by nome (case-insensitive includes)
    - Status filter: "ativas" = arquivada false, "arquivadas" = arquivada true, "todas" = no filter

    **3. Create arden/app/app/obras/page.tsx:**
    Server Component that:
    - Calls listObras({ includeArchived: true }) to get all obras
    - Passes data to ObrasTable client component
    - Page title: "Gerenciar Obras"
    - Uses bg-background for page background

    Important: Use design system variables (bg-surface-100 for cards, text-foreground, etc.)
  </action>
  <verify>
    - Route exists: `curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/app/obras` returns 200
    - Table renders: Visit /app/obras and verify table structure is visible
    - Empty state shows if no obras in database
  </verify>
  <done>
    /app/obras page renders with table showing obras list, toolbar with search/filter, and empty state when no data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create obra form modal with validation</name>
  <files>
    arden/app/app/obras/_components/obra-form-modal.tsx
    arden/app/app/obras/_components/obras-table.tsx
    arden/app/app/obras/page.tsx
  </files>
  <action>
    **1. Create arden/app/app/obras/_components/obra-form-modal.tsx:**

    Modal form component with:
    - Props: open, onOpenChange, onSuccess callback
    - Uses Dialog from shadcn
    - Uses useForm with zodResolver(obraFormSchema)
    - Fields:
      - nome (required): Input with Label "Nome *"
      - tipologia (optional): Select with tipologiaOptions
      - cidade (optional): Input
      - estado (optional): Input with maxLength={2}
      - responsavel_tecnico (optional): Input "Responsavel Tecnico"
    - Footer: Cancel button (variant="outline") + Submit button "Criar Obra"
    - On submit:
      - Set loading state
      - Call createObra from queries/obras.ts
      - On success: toast.success("Obra criada com sucesso"), call onSuccess(), close modal
      - On error: toast.error with error message
    - Reset form when modal opens (use key prop or form.reset in useEffect)
    - defaultValues for all fields to prevent controlled/uncontrolled warnings

    Layout per CONTEXT.md: Dialog sm:max-w-[425px], form fields stacked with space-y-4

    **2. Update obras-table.tsx:**
    - Accept onCreateClick prop
    - Wire "Nova Obra" button onClick to onCreateClick

    **3. Update page.tsx:**
    - Import ObraFormModal
    - Add client wrapper component or use 'use client' directive
    - Manage modal open state
    - On modal success: call router.refresh() to refetch data
    - Pass onCreateClick to ObrasTable that opens modal

    Pattern for Server Component + Client modal:
    Create a client wrapper component (ObrasPageClient) that:
    - Receives initial obras data as prop
    - Manages modal state
    - Handles router.refresh() after mutations
  </action>
  <verify>
    - Modal opens: Click "Nova Obra" button, modal appears
    - Validation works: Submit empty form, see "Nome e obrigatorio" error
    - Create works: Fill nome, submit, see success toast, modal closes
    - List refreshes: New obra appears in table after creation
  </verify>
  <done>
    "Nova Obra" button opens modal with validated form, successful submission creates obra and refreshes list.
  </done>
</task>

</tasks>

<verification>
- [ ] /app/obras route responds with 200
- [ ] Table displays with correct columns (Nome, Status, Progresso, Data, Acoes)
- [ ] Search filter reduces visible rows
- [ ] Status filter toggles between Ativas/Arquivadas/Todas
- [ ] "Nova Obra" opens Dialog modal
- [ ] Form validates nome as required
- [ ] Form validates estado as 2 chars if provided
- [ ] Submit creates obra in database (check Supabase)
- [ ] Toast shows success message
- [ ] Table refreshes after creation
</verification>

<success_criteria>
1. User visits /app/obras and sees table with any existing obras
2. User clicks "Nova Obra", sees modal form
3. User fills only nome (required), clicks "Criar Obra"
4. Toast shows "Obra criada com sucesso"
5. Modal closes, new obra appears in table
</success_criteria>

<output>
After completion, create `.planning/phases/02-obras/02-02-SUMMARY.md`
</output>
