---
phase: 05-biblioteca-fvs
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - arden/app/app/biblioteca/page.tsx
  - arden/app/app/biblioteca/_components/biblioteca-page-client.tsx
  - arden/app/app/biblioteca/_components/servicos-table.tsx
  - arden/app/app/biblioteca/_components/servico-form-modal.tsx
  - arden/app/app/biblioteca/_components/archive-confirmation.tsx
autonomous: true

must_haves:
  truths:
    - "User sees list of all servicos at /app/biblioteca"
    - "User can create new servico with codigo, nome, and categoria"
    - "User can edit existing servico"
    - "User can archive servico and it disappears from active list"
  artifacts:
    - path: "arden/app/app/biblioteca/page.tsx"
      provides: "Server component that fetches servicos"
      min_lines: 20
    - path: "arden/app/app/biblioteca/_components/biblioteca-page-client.tsx"
      provides: "Client wrapper managing modal/archive state"
      exports: ["BibliotecaPageClient"]
    - path: "arden/app/app/biblioteca/_components/servicos-table.tsx"
      provides: "Table component with category badges and actions"
      exports: ["ServicosTable"]
    - path: "arden/app/app/biblioteca/_components/servico-form-modal.tsx"
      provides: "Create/edit form modal"
      exports: ["ServicoFormModal"]
    - path: "arden/app/app/biblioteca/_components/archive-confirmation.tsx"
      provides: "Archive confirmation dialog"
      exports: ["ArchiveConfirmation"]
  key_links:
    - from: "arden/app/app/biblioteca/page.tsx"
      to: "listServicos"
      via: "server-side fetch"
      pattern: "listServicos"
    - from: "arden/app/app/biblioteca/_components/servico-form-modal.tsx"
      to: "createServico/updateServico"
      via: "form submission"
      pattern: "(createServico|updateServico)"
---

<objective>
Build Biblioteca FVS listing page with CRUD operations

Purpose: Allow users to view, create, edit, and archive servicos from the global biblioteca. This is the main management interface for the FVS service library.

Output:
- /app/biblioteca page with servicos table
- Create/edit modal for servicos
- Archive confirmation dialog
- Category badges in table
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-biblioteca-fvs/05-RESEARCH.md
@.planning/phases/05-biblioteca-fvs/05-01-SUMMARY.md

# Pattern references (Server Component + Client Wrapper)
@arden/app/app/obras/page.tsx
@arden/app/app/obras/_components/obras-page-client.tsx
@arden/app/app/obras/_components/obras-table.tsx
@arden/app/app/obras/_components/obra-form-modal.tsx
@arden/app/app/obras/_components/archive-confirmation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create biblioteca page and client wrapper</name>
  <files>arden/app/app/biblioteca/page.tsx, arden/app/app/biblioteca/_components/biblioteca-page-client.tsx</files>
  <action>
**page.tsx** - Server Component:
```typescript
import { createClient } from '@/lib/supabase/server'
import { BibliotecaPageClient } from './_components/biblioteca-page-client'

export default async function BibliotecaPage() {
  const supabase = await createClient()

  const { data: servicos, error } = await supabase
    .from('servicos')
    .select('*')
    .eq('arquivado', false)
    .order('created_at', { ascending: false })

  if (error) {
    console.error('Error fetching servicos:', error)
  }

  return (
    <div className="p-6 bg-background min-h-full">
      <div className="max-w-6xl mx-auto">
        <div className="mb-6">
          <h1 className="text-2xl font-normal text-foreground">Biblioteca FVS</h1>
          <p className="text-sm text-foreground-light mt-1">
            Gerencie os servicos de verificacao da construtora
          </p>
        </div>
        <BibliotecaPageClient initialServicos={servicos || []} />
      </div>
    </div>
  )
}
```

**biblioteca-page-client.tsx** - Follow obras-page-client.tsx pattern:
- State: isModalOpen, editingServico, archivingServico
- Handlers: handleCreateClick, handleEditClick, handleArchiveClick, handleModalSuccess, handleArchiveSuccess
- Renders: ServicosTable, ServicoFormModal, ArchiveConfirmation
- Use router.refresh() after mutations
  </action>
  <verify>Navigate to /app/biblioteca - page renders without errors</verify>
  <done>Biblioteca page loads and shows empty state or servicos list</done>
</task>

<task type="auto">
  <name>Task 2: Create servicos table with category badges</name>
  <files>arden/app/app/biblioteca/_components/servicos-table.tsx</files>
  <action>
Create ServicosTable following obras-table.tsx pattern:

1. Props:
```typescript
interface ServicosTableProps {
  servicos: Servico[]
  onCreateClick: () => void
  onEditClick: (servico: Servico) => void
  onArchiveClick: (servico: Servico) => void
  onRowClick?: (servico: Servico) => void  // For navigation to detail
}
```

2. Table columns:
- Codigo (font-medium)
- Nome
- Categoria (Badge with category label, use categoriaServicoOptions to map value to label)
- Acoes (DropdownMenu with Editar, Arquivar)

3. Features:
- "Novo Servico" button in header
- Empty state when servicos.length === 0: "Nenhum servico cadastrado. Clique em 'Novo Servico' para comecar."
- Row click navigates to detail page: onClick={() => router.push(`/app/biblioteca/${servico.id}`)}
- Cursor pointer on rows

4. Category badge styling:
```typescript
const getCategoryVariant = (cat: string | null) => {
  if (!cat) return 'secondary'
  // All categories use default variant for now, can customize later
  return 'default'
}
```

Use Badge component from @/components/ui/badge.
  </action>
  <verify>Table renders with correct columns, category badges display properly</verify>
  <done>Servicos table shows all servicos with category badges and action dropdown</done>
</task>

<task type="auto">
  <name>Task 3: Create form modal and archive confirmation</name>
  <files>arden/app/app/biblioteca/_components/servico-form-modal.tsx, arden/app/app/biblioteca/_components/archive-confirmation.tsx</files>
  <action>
**servico-form-modal.tsx** - Follow obra-form-modal.tsx pattern:

1. Props:
```typescript
interface ServicoFormModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
  mode?: 'create' | 'edit'
  servico?: Servico | null
}
```

2. Form fields (using React Hook Form + Zod):
- codigo: Input (required)
- nome: Input (required)
- categoria: Select with categoriaServicoOptions (optional)
- referencia_normativa: Textarea (optional, placeholder: "Ex: NBR 15575, PBQP-H SiAC")

3. Submit handler:
- Create mode: call createServico()
- Edit mode: call updateServico(servico.id, data)
- Handle error 23505: "Ja existe um servico com este codigo"
- Success toast: "Servico {criado|atualizado} com sucesso"

4. Modal title:
- Create: "Novo Servico"
- Edit: "Editar Servico"

5. Use sr-only DialogDescription for accessibility (decision from 04-04)

**archive-confirmation.tsx** - Follow obras/archive-confirmation.tsx pattern:

1. Props:
```typescript
interface ArchiveConfirmationProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  servico: Servico | null
  onSuccess: () => void
}
```

2. AlertDialog content:
- Title: "Arquivar servico?"
- Description: "O servico '{servico.nome}' sera arquivado e nao aparecera mais na lista ativa. Voce podera restaura-lo depois."
- Actions: Cancelar (outline), Arquivar (destructive)

3. Archive handler: call archiveServico(servico.id), toast success, onSuccess()
  </action>
  <verify>
- Modal opens for create/edit
- Form validates (codigo required, nome min 3 chars)
- Archive confirmation shows servico name
  </verify>
  <done>Create, edit, and archive operations work correctly</done>
</task>

</tasks>

<verification>
1. Navigate to /app/biblioteca
2. Click "Novo Servico" - modal opens
3. Fill form with codigo: "TEST-001", nome: "Teste Servico", categoria: "alvenaria"
4. Submit - toast shows success, modal closes, servico appears in table
5. Click row - navigates to /app/biblioteca/{id} (404 expected, detail page in Plan 03)
6. Click Edit in dropdown - modal opens with pre-filled data
7. Change nome and submit - toast shows success
8. Click Arquivar in dropdown - confirmation shows
9. Confirm archive - servico disappears from list
</verification>

<success_criteria>
- /app/biblioteca page loads without errors
- Servicos table displays codigo, nome, categoria (badge), actions
- Create modal validates form and creates servico
- Edit modal pre-fills data and updates servico
- Archive confirmation archives servico and removes from list
- Category badges render correctly from categoriaServicoOptions
- SERV-01, SERV-02, SERV-03, SERV-04 requirements fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/05-biblioteca-fvs/05-02-SUMMARY.md`
</output>
