---
phase: 05-biblioteca-fvs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - arden/lib/supabase/queries/servicos.ts
  - arden/lib/supabase/queries/itens-servico.ts
  - arden/lib/supabase/queries/obra-servicos.ts
  - arden/lib/validations/servico.ts
  - arden/lib/validations/item-servico.ts
  - arden/lib/validations/index.ts
  - arden/components/navigation/sidebar-global.tsx
autonomous: true

must_haves:
  truths:
    - "Servico types and CRUD functions exist and are callable"
    - "ItemServico types and CRUD functions exist and are callable"
    - "ObraServico types and activation functions exist and are callable"
    - "Validation schemas validate servico and item-servico forms"
    - "Biblioteca FVS nav item no longer shows 'Em breve' badge"
  artifacts:
    - path: "arden/lib/supabase/queries/servicos.ts"
      provides: "Servico CRUD operations"
      exports: ["Servico", "ServicoInsert", "ServicoUpdate", "listServicos", "getServico", "createServico", "updateServico", "archiveServico"]
    - path: "arden/lib/supabase/queries/itens-servico.ts"
      provides: "ItemServico CRUD operations"
      exports: ["ItemServico", "ItemServicoInsert", "ItemServicoUpdate", "listItensServico", "createItemServico", "updateItemServico", "deleteItemServico"]
    - path: "arden/lib/supabase/queries/obra-servicos.ts"
      provides: "Obra-Servico activation operations"
      exports: ["ObraServico", "listObraServicos", "listServicosForObra", "activateServico", "deactivateServico", "bulkActivateServicos"]
    - path: "arden/lib/validations/servico.ts"
      provides: "Servico form validation"
      exports: ["servicoFormSchema", "categoriaServicoOptions"]
    - path: "arden/lib/validations/item-servico.ts"
      provides: "ItemServico form validation"
      exports: ["itemServicoFormSchema"]
  key_links:
    - from: "arden/lib/supabase/queries/servicos.ts"
      to: "supabase.from('servicos')"
      via: "createClient"
      pattern: "from\\('servicos'\\)"
    - from: "arden/lib/validations/index.ts"
      to: "servico.ts, item-servico.ts"
      via: "re-export"
      pattern: "export.*from.*servico"
---

<objective>
Setup data access layer and validation schemas for Biblioteca FVS

Purpose: Establish typed interfaces and CRUD operations for servicos, itens_servico, and obra_servicos tables, following established patterns from obras.ts and agrupamentos.ts. Enable Biblioteca FVS in navigation.

Output:
- Query files for all three tables with typed interfaces
- Validation schemas with PT-BR error messages
- Navigation updated to show Biblioteca FVS as active
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-biblioteca-fvs/05-RESEARCH.md

# Pattern references
@arden/lib/supabase/queries/obras.ts
@arden/lib/supabase/queries/agrupamentos.ts
@arden/lib/validations/obra.ts
@arden/lib/validations/common.ts
@arden/components/navigation/sidebar-global.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create servicos data access layer</name>
  <files>arden/lib/supabase/queries/servicos.ts</files>
  <action>
Create servicos.ts following obras.ts pattern:

1. Type definitions:
```typescript
export interface Servico {
  id: string
  cliente_id: string
  codigo: string
  nome: string
  categoria: CategoriaServico | null
  referencia_normativa: string | null
  ativo: boolean
  arquivado: boolean
  created_at: string
  updated_at: string
}

export type CategoriaServico =
  | 'fundacao' | 'estrutura' | 'alvenaria' | 'revestimento'
  | 'acabamento' | 'instalacoes' | 'cobertura' | 'esquadrias'
  | 'pintura' | 'impermeabilizacao' | 'outros'

export interface ServicoInsert {
  codigo: string
  nome: string
  categoria?: CategoriaServico | null
  referencia_normativa?: string | null
}

export interface ServicoUpdate {
  codigo?: string
  nome?: string
  categoria?: CategoriaServico | null
  referencia_normativa?: string | null
  arquivado?: boolean
}
```

2. CRUD functions:
- `listServicos(options?: { includeArchived?: boolean })` - list all with optional archived filter
- `getServico(id: string)` - get by ID with .single()
- `createServico(data: ServicoInsert)` - insert with DEV_CLIENTE_ID
- `updateServico(id: string, updates: ServicoUpdate)` - update by ID
- `archiveServico(id: string)` - soft delete (arquivado: true)
- `restoreServico(id: string)` - restore (arquivado: false)

3. Error handling:
- Error code 23505 (unique_violation) -> "Ja existe um servico com este codigo"
- Error code 42501 -> "Voce nao tem permissao..."
- Default -> "Erro ao {action} servico: {message}"

Use same DEV_CLIENTE_ID pattern as obras.ts.
  </action>
  <verify>File exists and exports all types/functions. No TypeScript errors.</verify>
  <done>Servico CRUD operations available for use in components</done>
</task>

<task type="auto">
  <name>Task 2: Create itens-servico and obra-servicos data access layers</name>
  <files>arden/lib/supabase/queries/itens-servico.ts, arden/lib/supabase/queries/obra-servicos.ts</files>
  <action>
**itens-servico.ts:**

1. Type definitions:
```typescript
export interface ItemServico {
  id: string
  servico_id: string
  observacao: string
  metodo: string | null
  tolerancia: string | null
  ordem: number
  created_at: string
  updated_at: string
}

export interface ItemServicoInsert {
  servico_id: string
  observacao: string
  metodo?: string | null
  tolerancia?: string | null
  ordem?: number
}

export interface ItemServicoUpdate {
  observacao?: string
  metodo?: string | null
  tolerancia?: string | null
  ordem?: number
}
```

2. CRUD functions:
- `listItensServico(servicoId: string)` - list by servico_id, ordered by ordem
- `createItemServico(data: ItemServicoInsert)` - insert, auto-calculate ordem if not provided (same pattern as agrupamentos)
- `updateItemServico(id: string, updates: ItemServicoUpdate)` - update by ID
- `deleteItemServico(id: string)` - hard delete (no soft delete for items)
- `updateItensOrder(items: { id: string; ordem: number }[])` - batch reorder (Promise.all pattern)

**obra-servicos.ts:**

1. Type definitions:
```typescript
export interface ObraServico {
  id: string
  obra_id: string
  servico_id: string
  ativo: boolean
  created_at: string
}

export interface ServicoWithActivation extends Servico {
  obra_servico_id: string | null
  ativo_na_obra: boolean
}
```

2. Functions:
- `listObraServicos(obraId: string)` - get all active servicos for an obra
- `listServicosForObra(obraId: string)` - list ALL servicos with activation status for obra (join query)
- `activateServico(obraId: string, servicoId: string)` - upsert into obra_servicos
- `deactivateServico(obraServicoId: string)` - delete from obra_servicos OR set ativo=false
- `bulkActivateServicos(obraId: string, servicoIds: string[])` - bulk activate multiple

For listServicosForObra, use LEFT JOIN pattern:
```typescript
const { data } = await supabase
  .from('servicos')
  .select(`
    *,
    obra_servicos!left(id, ativo)
  `)
  .eq('arquivado', false)
  .eq('obra_servicos.obra_id', obraId)
```

Then map to add `ativo_na_obra` and `obra_servico_id` fields.
  </action>
  <verify>Both files exist and export all types/functions. No TypeScript errors.</verify>
  <done>ItemServico and ObraServico operations available for components</done>
</task>

<task type="auto">
  <name>Task 3: Create validation schemas and update navigation</name>
  <files>arden/lib/validations/servico.ts, arden/lib/validations/item-servico.ts, arden/lib/validations/index.ts, arden/components/navigation/sidebar-global.tsx</files>
  <action>
**servico.ts:**
```typescript
import { z } from 'zod'
import { requiredString, optionalString } from './common'

export const categoriaServicoOptions = [
  { value: 'fundacao', label: 'Fundacao' },
  { value: 'estrutura', label: 'Estrutura' },
  { value: 'alvenaria', label: 'Alvenaria' },
  { value: 'revestimento', label: 'Revestimento' },
  { value: 'acabamento', label: 'Acabamento' },
  { value: 'instalacoes', label: 'Instalacoes' },
  { value: 'cobertura', label: 'Cobertura' },
  { value: 'esquadrias', label: 'Esquadrias' },
  { value: 'pintura', label: 'Pintura' },
  { value: 'impermeabilizacao', label: 'Impermeabilizacao' },
  { value: 'outros', label: 'Outros' },
] as const

export type CategoriaServicoOption = typeof categoriaServicoOptions[number]['value']

export const servicoFormSchema = z.object({
  codigo: requiredString(1, 50, 'Codigo'),
  nome: requiredString(3, 255, 'Nome'),
  categoria: z.enum([
    'fundacao', 'estrutura', 'alvenaria', 'revestimento',
    'acabamento', 'instalacoes', 'cobertura', 'esquadrias',
    'pintura', 'impermeabilizacao', 'outros'
  ]).optional().nullable(),
  referencia_normativa: optionalString(500),
})

export type ServicoFormData = z.infer<typeof servicoFormSchema>
```

**item-servico.ts:**
```typescript
import { z } from 'zod'
import { requiredString, optionalString } from './common'

export const itemServicoFormSchema = z.object({
  observacao: requiredString(3, 1000, 'Observacao'),
  metodo: optionalString(1000),
  tolerancia: optionalString(500),
})

export type ItemServicoFormData = z.infer<typeof itemServicoFormSchema>
```

**index.ts:** Add exports:
```typescript
export * from './servico'
export * from './item-servico'
```

**sidebar-global.tsx:** Remove badge from Biblioteca FVS:
```typescript
const globalNavItems = [
  { icon: Home, label: 'Home', href: '/app', exact: true },
  { icon: LayoutDashboard, label: 'Dashboard', href: '/app/dashboard', badge: 'Em breve' },
  { icon: Building2, label: 'Obras', href: '/app/obras' },
  { icon: Library, label: 'Biblioteca FVS', href: '/app/biblioteca' },  // Remove badge
]
```
  </action>
  <verify>
- `npm run build` succeeds with no TypeScript errors
- Sidebar shows Biblioteca FVS without badge
  </verify>
  <done>Validation schemas export correctly, navigation shows Biblioteca as active</done>
</task>

</tasks>

<verification>
1. All query files exist in arden/lib/supabase/queries/
2. All validation files exist in arden/lib/validations/
3. `npm run build` passes without errors
4. Navigation sidebar shows Biblioteca FVS without "Em breve" badge
</verification>

<success_criteria>
- servicos.ts exports: Servico, ServicoInsert, ServicoUpdate, listServicos, getServico, createServico, updateServico, archiveServico, restoreServico
- itens-servico.ts exports: ItemServico, ItemServicoInsert, ItemServicoUpdate, listItensServico, createItemServico, updateItemServico, deleteItemServico
- obra-servicos.ts exports: ObraServico, ServicoWithActivation, listObraServicos, listServicosForObra, activateServico, deactivateServico, bulkActivateServicos
- servico.ts exports: servicoFormSchema, categoriaServicoOptions, ServicoFormData
- item-servico.ts exports: itemServicoFormSchema, ItemServicoFormData
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-biblioteca-fvs/05-01-SUMMARY.md`
</output>
