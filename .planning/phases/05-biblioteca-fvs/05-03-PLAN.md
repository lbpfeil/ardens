---
phase: 05-biblioteca-fvs
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - arden/app/app/biblioteca/[id]/page.tsx
  - arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx
  - arden/app/app/biblioteca/[id]/_components/servico-info-panel.tsx
  - arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx
  - arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx
  - arden/app/app/biblioteca/[id]/_components/item-delete-confirmation.tsx
autonomous: true

must_haves:
  truths:
    - "User sees servico details at /app/biblioteca/[id]"
    - "User can add itens de verificacao to a servico"
    - "User can edit existing item de verificacao"
    - "User can delete item de verificacao"
  artifacts:
    - path: "arden/app/app/biblioteca/[id]/page.tsx"
      provides: "Server component fetching servico and itens"
      min_lines: 25
    - path: "arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx"
      provides: "Client wrapper managing item modals"
      exports: ["ServicoDetailClient"]
    - path: "arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx"
      provides: "List of itens with CRUD actions"
      exports: ["ItensServicoPanel"]
    - path: "arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx"
      provides: "Create/edit modal for item"
      exports: ["ItemServicoFormModal"]
  key_links:
    - from: "arden/app/app/biblioteca/[id]/page.tsx"
      to: "getServico, listItensServico"
      via: "parallel server fetch"
      pattern: "(getServico|listItensServico)"
    - from: "arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx"
      to: "item-servico-form-modal.tsx"
      via: "onCreateClick, onEditClick"
      pattern: "onEditClick"
---

<objective>
Build servico detail page with itens de verificacao management

Purpose: Allow users to view a servico's details and manage its verification items (itens_servico). Each servico contains multiple items that define what to verify, how to verify, and acceptance criteria.

Output:
- /app/biblioteca/[id] detail page with split view
- Left panel: servico info (codigo, nome, categoria, referencia)
- Right panel: itens de verificacao list with CRUD
- Create/edit modal for itens
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-biblioteca-fvs/05-RESEARCH.md
@.planning/phases/05-biblioteca-fvs/05-01-SUMMARY.md
@.planning/phases/05-biblioteca-fvs/05-02-SUMMARY.md

# Pattern references (split view, panels)
@arden/app/app/obras/[id]/unidades/page.tsx
@arden/app/app/obras/[id]/unidades/_components/unidades-panel.tsx
@arden/app/app/obras/[id]/unidades/_components/unidade-form-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create servico detail page and info panel</name>
  <files>arden/app/app/biblioteca/[id]/page.tsx, arden/app/app/biblioteca/[id]/_components/servico-info-panel.tsx, arden/app/app/biblioteca/[id]/_components/servico-detail-client.tsx</files>
  <action>
**page.tsx** - Server Component:
```typescript
import { createClient } from '@/lib/supabase/server'
import { notFound } from 'next/navigation'
import { ServicoDetailClient } from './_components/servico-detail-client'

interface PageProps {
  params: Promise<{ id: string }>
}

export default async function ServicoDetailPage({ params }: PageProps) {
  const { id } = await params
  const supabase = await createClient()

  // Fetch servico
  const { data: servico, error: servicoError } = await supabase
    .from('servicos')
    .select('*')
    .eq('id', id)
    .single()

  if (servicoError || !servico) {
    notFound()
  }

  // Fetch itens
  const { data: itens, error: itensError } = await supabase
    .from('itens_servico')
    .select('*')
    .eq('servico_id', id)
    .order('ordem', { ascending: true })

  if (itensError) {
    console.error('Error fetching itens:', itensError)
  }

  return (
    <div className="p-6 bg-background min-h-full">
      <div className="max-w-6xl mx-auto">
        <ServicoDetailClient servico={servico} initialItens={itens || []} />
      </div>
    </div>
  )
}
```

**servico-info-panel.tsx:**
Display servico info in a card:
- Header with codigo badge and nome
- Info rows: Categoria, Referencia Normativa (if exists)
- Edit button (opens edit modal from biblioteca-page-client pattern)
- Back link to /app/biblioteca

```typescript
interface ServicoInfoPanelProps {
  servico: Servico
  onEditClick: () => void
}
```

Use Card component, Badge for codigo, categoria labels from categoriaServicoOptions.

**servico-detail-client.tsx:**
Client wrapper managing state:
- Props: servico, initialItens
- State: isItemModalOpen, editingItem, deletingItem, isServicoModalOpen
- Renders: ServicoInfoPanel (left), ItensServicoPanel (right)
- Layout: flex-col on mobile, lg:flex-row on desktop (split view pattern)
- Include ServicoFormModal for inline editing
- router.refresh() after mutations
  </action>
  <verify>Navigate to /app/biblioteca/{valid-id} - page renders with servico info</verify>
  <done>Detail page shows servico info panel with edit capability</done>
</task>

<task type="auto">
  <name>Task 2: Create itens de verificacao panel</name>
  <files>arden/app/app/biblioteca/[id]/_components/itens-servico-panel.tsx</files>
  <action>
Create ItensServicoPanel following unidades-panel.tsx pattern:

1. Props:
```typescript
interface ItensServicoPanelProps {
  servico: Servico
  itens: ItemServico[]
  onCreateClick: () => void
  onEditClick: (item: ItemServico) => void
  onDeleteClick: (item: ItemServico) => void
}
```

2. Panel structure:
- Header: "Itens de Verificacao" title + "Novo Item" button
- Table with columns:
  - # (ordem number)
  - Observacao (main content, possibly truncated)
  - Metodo (secondary, text-foreground-light, truncated)
  - Acoes (dropdown: Editar, Excluir)

3. Empty state:
- Icon: ClipboardList or ListChecks
- Text: "Nenhum item de verificacao cadastrado"
- Subtext: "Adicione itens que definem o que verificar neste servico."
- "Criar primeiro item" button

4. Table styling:
- Observacao: font-medium, max-w-[300px] truncate
- Metodo: text-sm text-foreground-light, max-w-[200px] truncate
- Tolerancia: Could show as tooltip or skip for table (show in modal/detail only)

5. Row hover state for edit-in-place feel

Note: No checkbox selection needed for items (unlike unidades). Simple list management.
  </action>
  <verify>Panel renders with "Novo Item" button and empty state or items list</verify>
  <done>Itens panel displays all items with edit/delete actions</done>
</task>

<task type="auto">
  <name>Task 3: Create item form modal and delete confirmation</name>
  <files>arden/app/app/biblioteca/[id]/_components/item-servico-form-modal.tsx, arden/app/app/biblioteca/[id]/_components/item-delete-confirmation.tsx</files>
  <action>
**item-servico-form-modal.tsx:**

1. Props:
```typescript
interface ItemServicoFormModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
  servicoId: string
  mode?: 'create' | 'edit'
  item?: ItemServico | null
}
```

2. Form fields (using itemServicoFormSchema):
- observacao: Textarea (required, placeholder: "O que deve ser verificado")
- metodo: Textarea (optional, placeholder: "Como verificar (medicao, visual, etc.)")
- tolerancia: Input (optional, placeholder: "Criterio de aceitacao (ex: +/- 5mm)")

3. Submit handler:
- Create: createItemServico({ servico_id: servicoId, ...data })
- Edit: updateItemServico(item.id, data)
- Toast: "Item {criado|atualizado} com sucesso"

4. Modal title:
- Create: "Novo Item de Verificacao"
- Edit: "Editar Item de Verificacao"

**item-delete-confirmation.tsx:**

1. Props:
```typescript
interface ItemDeleteConfirmationProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  item: ItemServico | null
  onSuccess: () => void
}
```

2. AlertDialog:
- Title: "Excluir item de verificacao?"
- Description: "Este item sera excluido permanentemente. Esta acao nao pode ser desfeita."
- Show item.observacao (first 100 chars) for context
- Actions: Cancelar (outline), Excluir (destructive)

3. Delete handler: deleteItemServico(item.id), toast "Item excluido com sucesso", onSuccess()

Note: Items use hard delete (not soft delete like servicos).
  </action>
  <verify>
- Click "Novo Item" - modal opens
- Fill observacao and submit - item appears in list
- Click Edit on item - modal opens with pre-filled data
- Click Excluir - confirmation shows, confirm deletes item
  </verify>
  <done>Full CRUD for itens de verificacao works correctly</done>
</task>

</tasks>

<verification>
1. Navigate to /app/biblioteca - click on a servico row
2. Detail page loads with servico info on left, itens panel on right
3. Click "Novo Item" - modal opens
4. Fill observacao: "Verificar alinhamento vertical", metodo: "Nivel de bolha", tolerancia: "+/- 2mm"
5. Submit - item appears in list with ordem #1
6. Add second item - appears with ordem #2
7. Click Edit on first item - modal shows pre-filled data
8. Change observacao, submit - list updates
9. Click Excluir on second item - confirmation shows
10. Confirm - item removed from list
11. Click Edit on servico info panel - modal opens, can edit servico
</verification>

<success_criteria>
- /app/biblioteca/[id] loads servico detail page
- Info panel shows codigo, nome, categoria, referencia_normativa
- Itens panel lists all itens_servico ordered by ordem
- Create modal adds new item with auto-calculated ordem
- Edit modal updates existing item
- Delete confirmation removes item permanently
- SERV-05, SERV-06 requirements fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/05-biblioteca-fvs/05-03-SUMMARY.md`
</output>
