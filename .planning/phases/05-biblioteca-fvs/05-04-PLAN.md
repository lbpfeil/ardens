---
phase: 05-biblioteca-fvs
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - arden/app/app/obras/[id]/servicos/page.tsx
  - arden/app/app/obras/[id]/servicos/_components/servicos-activation-client.tsx
  - arden/app/app/obras/[id]/servicos/_components/servicos-activation-table.tsx
  - arden/components/navigation/sidebar-obra.tsx
autonomous: true

must_haves:
  truths:
    - "User sees activation page at /app/obras/[id]/servicos"
    - "User can activate servicos for an obra via checkbox"
    - "User can deactivate servicos from an obra"
    - "Servicos nav item in obra sidebar is active (no badge)"
  artifacts:
    - path: "arden/app/app/obras/[id]/servicos/page.tsx"
      provides: "Server component fetching servicos with activation status"
      min_lines: 25
    - path: "arden/app/app/obras/[id]/servicos/_components/servicos-activation-client.tsx"
      provides: "Client wrapper managing checkbox state"
      exports: ["ServicosActivationClient"]
    - path: "arden/app/app/obras/[id]/servicos/_components/servicos-activation-table.tsx"
      provides: "Table with activation checkboxes"
      exports: ["ServicosActivationTable"]
  key_links:
    - from: "arden/app/app/obras/[id]/servicos/page.tsx"
      to: "listServicosForObra"
      via: "server-side fetch"
      pattern: "listServicosForObra"
    - from: "arden/app/app/obras/[id]/servicos/_components/servicos-activation-table.tsx"
      to: "activateServico/deactivateServico"
      via: "checkbox toggle"
      pattern: "(activateServico|deactivateServico)"
---

<objective>
Build obra servicos activation page

Purpose: Allow users to activate/deactivate servicos for a specific obra. This connects the biblioteca (global) with the obra context, enabling per-obra service customization.

Output:
- /app/obras/[id]/servicos page with checkbox table
- Toggle activation via checkbox click
- Update obra sidebar to show Servicos as active
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-biblioteca-fvs/05-RESEARCH.md
@.planning/phases/05-biblioteca-fvs/05-01-SUMMARY.md

# Pattern references
@arden/app/app/obras/[id]/page.tsx
@arden/app/app/obras/[id]/unidades/_components/unidades-panel.tsx
@arden/components/navigation/sidebar-obra.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create servicos activation page</name>
  <files>arden/app/app/obras/[id]/servicos/page.tsx, arden/app/app/obras/[id]/servicos/_components/servicos-activation-client.tsx</files>
  <action>
**page.tsx** - Server Component:
```typescript
import { createClient } from '@/lib/supabase/server'
import { notFound } from 'next/navigation'
import { ServicosActivationClient } from './_components/servicos-activation-client'

interface PageProps {
  params: Promise<{ id: string }>
}

export default async function ObraServicosPage({ params }: PageProps) {
  const { id: obraId } = await params
  const supabase = await createClient()

  // Verify obra exists
  const { data: obra, error: obraError } = await supabase
    .from('obras')
    .select('id, nome')
    .eq('id', obraId)
    .single()

  if (obraError || !obra) {
    notFound()
  }

  // Fetch all servicos with activation status for this obra
  // Using LEFT JOIN pattern from research
  const { data: servicos, error: servicosError } = await supabase
    .from('servicos')
    .select(`
      *,
      obra_servicos!left(id, ativo)
    `)
    .eq('arquivado', false)
    .order('categoria', { ascending: true })
    .order('nome', { ascending: true })

  if (servicosError) {
    console.error('Error fetching servicos:', servicosError)
  }

  // Filter by obra_id in the join and transform data
  const servicosWithActivation = (servicos || []).map((s) => {
    const obraServico = s.obra_servicos?.find(
      (os: { id: string; ativo: boolean }) => true  // Already filtered by left join
    )
    // Note: Supabase left join returns array, need to filter by obra_id client-side
    // Actually, need to pass obra_id to the eq filter...
    return {
      ...s,
      obra_servico_id: obraServico?.id || null,
      ativo_na_obra: obraServico?.ativo ?? false,
    }
  })

  return (
    <div className="p-6 bg-background min-h-full">
      <div className="max-w-4xl mx-auto">
        <div className="mb-6">
          <h1 className="text-2xl font-normal text-foreground">Servicos da Obra</h1>
          <p className="text-sm text-foreground-light mt-1">
            Selecione os servicos que serao verificados nesta obra
          </p>
        </div>
        <ServicosActivationClient
          obraId={obraId}
          initialServicos={servicosWithActivation}
        />
      </div>
    </div>
  )
}
```

NOTE: The LEFT JOIN approach in Supabase needs adjustment. Better approach:

```typescript
// Fetch servicos
const { data: servicos } = await supabase
  .from('servicos')
  .select('*')
  .eq('arquivado', false)
  .order('categoria')
  .order('nome')

// Fetch obra_servicos for this obra
const { data: obraServicos } = await supabase
  .from('obra_servicos')
  .select('id, servico_id, ativo')
  .eq('obra_id', obraId)

// Merge
const activeIds = new Map(
  (obraServicos || []).map(os => [os.servico_id, { id: os.id, ativo: os.ativo }])
)
const servicosWithActivation = (servicos || []).map(s => ({
  ...s,
  obra_servico_id: activeIds.get(s.id)?.id || null,
  ativo_na_obra: activeIds.get(s.id)?.ativo ?? false,
}))
```

**servicos-activation-client.tsx:**
```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { ServicosActivationTable } from './servicos-activation-table'
import type { ServicoWithActivation } from '@/lib/supabase/queries/obra-servicos'
import { activateServico, deactivateServico } from '@/lib/supabase/queries/obra-servicos'
import { toast } from 'sonner'

interface ServicosActivationClientProps {
  obraId: string
  initialServicos: ServicoWithActivation[]
}

export function ServicosActivationClient({
  obraId,
  initialServicos,
}: ServicosActivationClientProps) {
  const router = useRouter()
  const [isUpdating, setIsUpdating] = useState<string | null>(null)

  const handleToggle = async (servico: ServicoWithActivation, checked: boolean) => {
    setIsUpdating(servico.id)
    try {
      if (checked) {
        await activateServico(obraId, servico.id)
        toast.success(`Servico "${servico.nome}" ativado`)
      } else {
        if (servico.obra_servico_id) {
          await deactivateServico(servico.obra_servico_id)
          toast.success(`Servico "${servico.nome}" desativado`)
        }
      }
      router.refresh()
    } catch (error) {
      const message = error instanceof Error ? error.message : 'Erro ao atualizar servico'
      toast.error(message)
    } finally {
      setIsUpdating(null)
    }
  }

  return (
    <ServicosActivationTable
      servicos={initialServicos}
      onToggle={handleToggle}
      updatingId={isUpdating}
    />
  )
}
```
  </action>
  <verify>Navigate to /app/obras/{id}/servicos - page renders with servicos list</verify>
  <done>Activation page loads showing all servicos with activation status</done>
</task>

<task type="auto">
  <name>Task 2: Create activation table with checkboxes</name>
  <files>arden/app/app/obras/[id]/servicos/_components/servicos-activation-table.tsx</files>
  <action>
Create ServicosActivationTable:

1. Props:
```typescript
interface ServicosActivationTableProps {
  servicos: ServicoWithActivation[]
  onToggle: (servico: ServicoWithActivation, checked: boolean) => void
  updatingId: string | null
}
```

2. Table structure:
```typescript
<Table>
  <TableHeader>
    <TableRow>
      <TableHead className="w-[50px]">Ativo</TableHead>
      <TableHead className="w-[120px]">Codigo</TableHead>
      <TableHead>Nome</TableHead>
      <TableHead className="w-[150px]">Categoria</TableHead>
    </TableRow>
  </TableHeader>
  <TableBody>
    {servicos.map((servico) => (
      <TableRow key={servico.id}>
        <TableCell>
          <Checkbox
            checked={servico.ativo_na_obra}
            onCheckedChange={(checked) => onToggle(servico, checked === true)}
            disabled={updatingId === servico.id}
            aria-label={`Ativar ${servico.nome}`}
          />
        </TableCell>
        <TableCell className="font-mono text-sm">{servico.codigo}</TableCell>
        <TableCell className="font-medium">{servico.nome}</TableCell>
        <TableCell>
          <Badge variant="secondary">
            {getCategoryLabel(servico.categoria)}
          </Badge>
        </TableCell>
      </TableRow>
    ))}
  </TableBody>
</Table>
```

3. Empty state:
- If servicos.length === 0: "Nenhum servico disponivel. Crie servicos na Biblioteca FVS primeiro."
- Link to /app/biblioteca

4. Category grouping (optional enhancement):
- Group rows by categoria with section headers
- Or just show badge per row (simpler, do this first)

5. Active count summary:
- Show "X de Y servicos ativos" above table
```typescript
const activeCount = servicos.filter(s => s.ativo_na_obra).length
<p className="text-sm text-foreground-light mb-4">
  {activeCount} de {servicos.length} servicos ativos nesta obra
</p>
```

6. Loading state during toggle:
- Disable checkbox while updatingId matches
- Could show spinner but disabled is enough
  </action>
  <verify>
- Table shows all servicos with checkbox
- Checkbox reflects ativo_na_obra state
- Clicking checkbox triggers onToggle
  </verify>
  <done>Activation table renders with working checkboxes</done>
</task>

<task type="auto">
  <name>Task 3: Update obra sidebar navigation</name>
  <files>arden/components/navigation/sidebar-obra.tsx</files>
  <action>
Remove 'Em breve' badge from Servicos item in sidebar-obra.tsx:

```typescript
operacao: [
  { icon: Wrench, label: 'Servicos', href: `/app/obras/${obraId}/servicos` },  // Remove badge
  { icon: Building2, label: 'Unidades', href: `/app/obras/${obraId}/unidades` },
  { icon: ClipboardCheck, label: 'Verificacoes', href: `/app/obras/${obraId}/verificacoes`, badge: 'Em breve' },
  { icon: AlertTriangle, label: 'NCs', href: `/app/obras/${obraId}/ncs`, badge: 'Em breve' },
],
```

This enables the Servicos link in the obra context sidebar.
  </action>
  <verify>
- Navigate to obra context
- Sidebar shows Servicos without "Em breve" badge
- Clicking Servicos navigates to /app/obras/{id}/servicos
  </verify>
  <done>Obra sidebar shows Servicos as active navigation item</done>
</task>

</tasks>

<verification>
1. Navigate to /app/obras/{id}
2. Click Servicos in sidebar - navigates to /app/obras/{id}/servicos
3. Page shows all servicos from biblioteca with checkboxes
4. Check a servico - toast shows "Servico X ativado"
5. Uncheck same servico - toast shows "Servico X desativado"
6. Refresh page - activation state persists
7. Check multiple servicos - all persist after refresh
8. Summary shows correct "X de Y servicos ativos"
</verification>

<success_criteria>
- /app/obras/[id]/servicos page loads without errors
- Table shows all non-archived servicos
- Checkbox click activates/deactivates servico for obra
- State persists after page refresh
- Sidebar shows Servicos without badge
- SERV-07, SERV-08 requirements fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/05-biblioteca-fvs/05-04-SUMMARY.md`
</output>
