---
phase: 03-agrupamentos
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - database/rls-policies.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Engenheiros can create agrupamentos (not just admins)"
    - "Engenheiros can update agrupamentos"
    - "Engenheiros can delete agrupamentos"
  artifacts:
    - path: "database/rls-policies.sql"
      provides: "Updated RLS policies for agrupamentos"
  key_links:
    - from: "database/rls-policies.sql"
      to: "agrupamentos table"
      via: "RLS policies"
      pattern: "agrupamentos_(insert|update|delete)"
---

<objective>
Fix RLS policies to allow engenheiros to manage agrupamentos.

Purpose: Engenheiros (not just admins) should be able to create, edit, and delete agrupamentos per the PRD.
Output: Updated database/rls-policies.sql with is_admin_or_engenheiro() for agrupamentos CRUD.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-agrupamentos/03-UAT.md

# Root cause from UAT
RLS policy agrupamentos_insert requires is_admin() but engenheiros also need access per PRD.
Lines 226-244 in database/rls-policies.sql need to change is_admin() to is_admin_or_engenheiro().
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update agrupamentos RLS policies</name>
  <files>database/rls-policies.sql</files>
  <action>
Update the following policies in database/rls-policies.sql:

1. `agrupamentos_insert` (lines 226-230):
   Change `is_admin()` to `is_admin_or_engenheiro()`

2. `agrupamentos_update` (lines 233-237):
   Change `is_admin()` to `is_admin_or_engenheiro()`

3. `agrupamentos_delete` (lines 240-244):
   Change `is_admin()` to `is_admin_or_engenheiro()`

This allows both admins and engenheiros to manage agrupamentos, which aligns with the PRD where engenheiros configure obras.
  </action>
  <verification>
Verify:
1. All three policies now use is_admin_or_engenheiro()
2. No other agrupamentos policies were affected
3. Comment above policies still accurate (update if needed)
  </verification>
</task>

</tasks>

<user_action_required>
After this plan executes, the user must apply the migration to their Supabase instance:

```bash
# If using Supabase CLI with local database
npx supabase db push

# Or run the SQL directly in Supabase Dashboard > SQL Editor
```

This is a database change that cannot be applied by code alone.
</user_action_required>
