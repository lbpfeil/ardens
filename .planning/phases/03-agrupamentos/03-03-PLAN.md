---
phase: 03-agrupamentos
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-page-client.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-table.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/delete-confirmation.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/sortable-agrupamento-row.tsx
autonomous: true

must_haves:
  truths:
    - "Usuario pode excluir agrupamento com confirmacao"
    - "Confirmacao de exclusao mostra quantidade de unidades que serao excluidas"
    - "Usuario pode entrar em modo de reordenacao"
    - "Usuario pode arrastar agrupamentos para reordenar"
    - "Usuario pode salvar ou cancelar nova ordem"
  artifacts:
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/delete-confirmation.tsx"
      provides: "AlertDialog for delete confirmation"
      exports: ["DeleteConfirmation"]
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/sortable-agrupamento-row.tsx"
      provides: "Draggable table row for reorder mode"
      exports: ["SortableAgrupamentoRow"]
  key_links:
    - from: "arden/app/app/obras/[id]/agrupamentos/_components/delete-confirmation.tsx"
      to: "lib/supabase/queries/agrupamentos.ts"
      via: "deleteAgrupamento"
      pattern: "deleteAgrupamento"
    - from: "arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-table.tsx"
      to: "lib/supabase/queries/agrupamentos.ts"
      via: "updateAgrupamentosOrder"
      pattern: "updateAgrupamentosOrder"
    - from: "arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-table.tsx"
      to: "@dnd-kit/sortable"
      via: "DndContext, SortableContext"
      pattern: "DndContext|SortableContext"
---

<objective>
Add delete confirmation and drag-and-drop reordering to agrupamentos.

Purpose: Complete agrupamentos management with deletion and reordering capabilities.
Output: Delete confirmation dialog, drag-and-drop reorder mode with explicit save/cancel.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agrupamentos/03-CONTEXT.md
@.planning/phases/03-agrupamentos/03-RESEARCH.md

# Prior plan outputs
@.planning/phases/03-agrupamentos/03-01-SUMMARY.md
@.planning/phases/03-agrupamentos/03-02-SUMMARY.md

# Patterns to follow
@arden/app/app/obras/_components/archive-confirmation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delete confirmation dialog</name>
  <files>
    arden/app/app/obras/[id]/agrupamentos/_components/delete-confirmation.tsx
    arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-page-client.tsx
  </files>
  <action>
1. Create delete-confirmation.tsx following archive-confirmation.tsx pattern:
   - Props: open, onOpenChange, agrupamento (AgrupamentoWithCount | null), onSuccess
   - Use AlertDialog from components/ui/alert-dialog
   - Title: "Excluir Agrupamento"
   - Description varies based on unidades_count:
     - If 0: "Tem certeza que deseja excluir o agrupamento '{nome}'?"
     - If > 0: "Tem certeza que deseja excluir o agrupamento '{nome}' e suas {count} unidade(s)? Esta acao nao pode ser desfeita."
   - Cancel button: "Cancelar"
   - Confirm button: "Excluir" with variant="destructive"
   - On confirm: call deleteAgrupamento(agrupamento.id), toast success, call onSuccess()
   - Handle errors with toast.error

2. Update agrupamentos-page-client.tsx:
   - Add useState for deletingAgrupamento
   - Add handleDeleteClick(agrupamento) that sets deletingAgrupamento
   - Add handleDeleteClose, handleDeleteSuccess handlers
   - Pass onDeleteClick to AgrupamentosTable
   - Render DeleteConfirmation component with proper props
  </action>
  <verify>
TypeScript compiles: `cd arden && npx tsc --noEmit`
Build passes: `cd arden && npm run build`
  </verify>
  <done>
Delete option in dropdown triggers confirmation dialog, dialog shows unidades count warning, deletion works with cascade.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add drag-and-drop reorder mode</name>
  <files>
    arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-table.tsx
    arden/app/app/obras/[id]/agrupamentos/_components/sortable-agrupamento-row.tsx
  </files>
  <action>
1. Create sortable-agrupamento-row.tsx:
   - Use useSortable from @dnd-kit/sortable
   - Use CSS from @dnd-kit/utilities for transform
   - Props: id, agrupamento (AgrupamentoWithCount)
   - Render TableRow with ref={setNodeRef} and style with transform/transition
   - First cell: drag handle (GripVertical icon from lucide-react) with {...attributes} {...listeners}
   - Remaining cells: Nome, Unidades count
   - No actions dropdown in reorder mode
   - Visual feedback: opacity 0.5 when isDragging

2. Update agrupamentos-table.tsx for reorder mode:
   - Add props: obraId, isReorderMode, onReorderStart, onReorderSave, onReorderCancel
   - Add local state for pendingOrder (string[] of ids)
   - When isReorderMode becomes true: setPendingOrder(agrupamentos.map(a => a.id))

   Import from @dnd-kit:
   - DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent from @dnd-kit/core
   - arrayMove, SortableContext, sortableKeyboardCoordinates, verticalListSortingStrategy from @dnd-kit/sortable

   Configure sensors:
   - PointerSensor
   - KeyboardSensor with sortableKeyboardCoordinates

   handleDragEnd:
   - Get active.id and over.id
   - If different: setPendingOrder(arrayMove(pendingOrder, oldIndex, newIndex))

   Toolbar changes:
   - Normal mode: "Novo Agrupamento" button + "Reordenar" button (outline variant)
   - Reorder mode: "Cancelar" button (outline) + "Salvar Ordem" button (primary)

   Table rendering:
   - Normal mode: render regular rows with actions dropdown
   - Reorder mode: wrap table body with DndContext and SortableContext, render SortableAgrupamentoRow for each item based on pendingOrder

   Save handler:
   - onReorderSave calls updateAgrupamentosOrder(obraId, pendingOrder) then router.refresh()

3. Update agrupamentos-page-client.tsx:
   - Add isReorderMode state
   - Add handlers: handleReorderStart, handleReorderSave, handleReorderCancel
   - handleReorderSave: call updateAgrupamentosOrder, set isReorderMode false, router.refresh()
   - Pass reorder props to AgrupamentosTable
  </action>
  <verify>
TypeScript compiles: `cd arden && npx tsc --noEmit`
Build passes: `cd arden && npm run build`
  </verify>
  <done>
Reordenar button enters reorder mode, drag handles appear, rows can be dragged, Salvar saves new order, Cancelar discards changes.
  </done>
</task>

</tasks>

<verification>
1. Build passes without errors
2. Delete shows confirmation with unidades count
3. Delete removes agrupamento and refreshes list
4. Reordenar button toggles reorder mode
5. Drag handles appear and allow dragging
6. Salvar persists new order to database
7. Cancelar discards pending changes
8. Keyboard navigation works for accessibility
</verification>

<success_criteria>
- User can delete agrupamento with proper warning about cascading unidades
- User can enter reorder mode via "Reordenar" button
- User can drag agrupamentos to new positions
- User can save new order with "Salvar Ordem" button
- User can cancel reorder with "Cancelar" button
- Reorder is accessible via keyboard (Tab + Space/Enter)
</success_criteria>

<output>
After completion, create `.planning/phases/03-agrupamentos/03-03-SUMMARY.md`
</output>
