---
phase: 03-agrupamentos
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - arden/app/app/obras/[id]/agrupamentos/page.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-page-client.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-table.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/agrupamento-form-modal.tsx
autonomous: true

must_haves:
  truths:
    - "Usuario pode acessar /app/obras/[id]/agrupamentos e ver lista de agrupamentos"
    - "Usuario pode criar novo agrupamento via modal"
    - "Usuario pode criar agrupamentos em lote via toggle no modal"
    - "Usuario pode editar agrupamento existente via dropdown menu"
  artifacts:
    - path: "arden/app/app/obras/[id]/agrupamentos/page.tsx"
      provides: "Server Component with data fetching"
      min_lines: 15
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-page-client.tsx"
      provides: "Client wrapper managing modal state"
      exports: ["AgrupamentosPageClient"]
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-table.tsx"
      provides: "Table with toolbar and actions dropdown"
      exports: ["AgrupamentosTable"]
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/agrupamento-form-modal.tsx"
      provides: "Create/Edit modal with batch toggle"
      exports: ["AgrupamentoFormModal"]
  key_links:
    - from: "arden/app/app/obras/[id]/agrupamentos/page.tsx"
      to: "lib/supabase/queries/agrupamentos.ts"
      via: "listAgrupamentos(id)"
      pattern: "await listAgrupamentos"
    - from: "arden/app/app/obras/[id]/agrupamentos/_components/agrupamento-form-modal.tsx"
      to: "lib/supabase/queries/agrupamentos.ts"
      via: "createAgrupamento, createAgrupamentosBatch, updateAgrupamento"
      pattern: "(createAgrupamento|createAgrupamentosBatch|updateAgrupamento)"
---

<objective>
Create agrupamentos list page with table and create/edit modal including batch creation.

Purpose: Enable users to view and manage agrupamentos within an obra.
Output: /app/obras/[id]/agrupamentos page with table, create/edit modal with batch support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agrupamentos/03-CONTEXT.md
@.planning/phases/03-agrupamentos/03-RESEARCH.md

# Prior plan output
@.planning/phases/03-agrupamentos/03-01-SUMMARY.md

# Patterns to follow
@arden/app/app/obras/page.tsx
@arden/app/app/obras/_components/obras-page-client.tsx
@arden/app/app/obras/_components/obras-table.tsx
@arden/app/app/obras/_components/obra-form-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agrupamentos list page with Server Component and table</name>
  <files>
    arden/app/app/obras/[id]/agrupamentos/page.tsx
    arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-page-client.tsx
    arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-table.tsx
  </files>
  <action>
1. Create page.tsx (Server Component):
   - Use async params pattern: `const { id } = await params` (Next.js 15)
   - Fetch agrupamentos with `listAgrupamentos(id)`
   - Also fetch obra with `getObra(id)` for the page header (obra name)
   - Handle not found with `notFound()`
   - Return AgrupamentosPageClient with obraId, obraNome, initialAgrupamentos props

2. Create agrupamentos-page-client.tsx:
   - Follow ObrasPageClient pattern exactly
   - useState for isModalOpen, editingAgrupamento
   - Handler functions: handleCreateClick, handleEditClick, handleModalClose, handleModalSuccess
   - Render AgrupamentosTable and AgrupamentoFormModal
   - router.refresh() after successful mutations

3. Create agrupamentos-table.tsx:
   - Follow ObrasTable pattern
   - Header with page title "Agrupamentos" and obra name subtitle
   - "Novo Agrupamento" button that calls onCreateClick
   - Table columns: Nome, Unidades (count), Acoes (dropdown)
   - DropdownMenu in each row with: Editar, Excluir options
   - Editar calls onEditClick(agrupamento)
   - Excluir calls onDeleteClick(agrupamento) - wire to prop, implement deletion in Plan 03
   - Empty state: "Nenhum agrupamento cadastrado. Clique em 'Novo Agrupamento' para comecar."
   - Props: agrupamentos, obraNome, onCreateClick, onEditClick, onDeleteClick
  </action>
  <verify>
Build passes: `cd arden && npm run build`
Route exists: Check build output shows /app/obras/[id]/agrupamentos as dynamic route
  </verify>
  <done>
Page renders with table showing agrupamentos, "Novo Agrupamento" button visible, dropdown actions in each row.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agrupamento form modal with batch creation toggle</name>
  <files>arden/app/app/obras/[id]/agrupamentos/_components/agrupamento-form-modal.tsx</files>
  <action>
Create modal following ObraFormModal pattern with batch creation extension:

1. Props interface:
   - open, onOpenChange, onSuccess (standard)
   - mode: 'create' | 'edit' (default 'create')
   - agrupamento: Agrupamento | null (for edit mode)
   - obraId: string (required for creation)

2. Form modes:
   - Single mode: uses agrupamentoFormSchema, just nome field
   - Batch mode: uses agrupamentoBatchSchema, prefixo + quantidade + numeroInicial fields

3. UI structure:
   - Dialog with DialogContent, DialogHeader, DialogTitle, DialogFooter
   - Toggle/checkbox for batch mode (only visible in create mode)
   - Title: "Novo Agrupamento" / "Editar Agrupamento" / "Novos Agrupamentos (Lote)" based on mode

4. Single mode form:
   - Nome field (Input) with validation error display

5. Batch mode form:
   - Prefixo field (Input): "Ex: Bloco"
   - Quantidade field (Input type="number"): "Ex: 5"
   - Numero Inicial field (Input type="number"): "Ex: 1"
   - Preview text showing what will be created: "Sera criado: Bloco 1, Bloco 2, Bloco 3..."
   - Use generateBatchNames from validations to generate preview

6. Submit handler:
   - Single create: call createAgrupamento(obraId, { nome })
   - Batch create: call generateBatchNames then createAgrupamentosBatch(obraId, names)
   - Edit: call updateAgrupamento(agrupamento.id, { nome })
   - Toast success/error in Portuguese
   - Call onSuccess() after success

7. Button text:
   - Create single: "Criar Agrupamento"
   - Create batch: "Criar X Agrupamentos"
   - Edit: "Salvar"
   - Loading states with "Criando..." / "Salvando..."
  </action>
  <verify>
TypeScript compiles: `cd arden && npx tsc --noEmit`
Build passes: `cd arden && npm run build`
  </verify>
  <done>
Modal opens for create/edit, batch toggle works in create mode, preview shows batch names, form validates and submits correctly.
  </done>
</task>

</tasks>

<verification>
1. Build passes without errors
2. /app/obras/[id]/agrupamentos route is accessible
3. Table shows agrupamentos with correct columns
4. Create modal opens and validates form
5. Batch toggle shows/hides batch fields
6. Batch preview generates correct names
7. Edit modal pre-fills agrupamento name
</verification>

<success_criteria>
- User can navigate to /app/obras/[id]/agrupamentos and see list
- User can create single agrupamento via modal
- User can create multiple agrupamentos via batch mode
- User can edit existing agrupamento name
- Toast notifications show success/error messages in Portuguese
</success_criteria>

<output>
After completion, create `.planning/phases/03-agrupamentos/03-02-SUMMARY.md`
</output>
