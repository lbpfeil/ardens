---
phase: 03-agrupamentos
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - arden/lib/supabase/queries/agrupamentos.ts
  - arden/lib/validations/agrupamento.ts
  - arden/package.json
autonomous: true

must_haves:
  truths:
    - "Data access layer can list agrupamentos for a given obra"
    - "Data access layer can create, update, and delete agrupamentos"
    - "Zod schema validates agrupamento form data"
    - "@dnd-kit packages are installed and importable"
  artifacts:
    - path: "arden/lib/supabase/queries/agrupamentos.ts"
      provides: "CRUD operations for agrupamentos"
      exports: ["Agrupamento", "AgrupamentoWithCount", "listAgrupamentos", "getAgrupamento", "createAgrupamento", "createAgrupamentosBatch", "updateAgrupamento", "updateAgrupamentosOrder", "deleteAgrupamento"]
    - path: "arden/lib/validations/agrupamento.ts"
      provides: "Form validation schema"
      exports: ["agrupamentoFormSchema", "agrupamentoBatchSchema", "AgrupamentoFormData", "AgrupamentoBatchData"]
  key_links:
    - from: "arden/lib/supabase/queries/agrupamentos.ts"
      to: "supabase agrupamentos table"
      via: "Supabase client queries"
      pattern: "supabase\\.from\\('agrupamentos'\\)"
---

<objective>
Setup data access layer and validation for agrupamentos, install @dnd-kit for drag-and-drop.

Purpose: Establish foundation for agrupamentos CRUD - queries, types, validation, and reorder library.
Output: Data access layer in lib/supabase/queries/agrupamentos.ts, Zod schema in lib/validations/agrupamento.ts, @dnd-kit packages installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agrupamentos/03-CONTEXT.md
@.planning/phases/03-agrupamentos/03-RESEARCH.md

# Existing patterns to follow
@arden/lib/supabase/queries/obras.ts
@arden/lib/validations/obra.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agrupamentos data access layer</name>
  <files>arden/lib/supabase/queries/agrupamentos.ts</files>
  <action>
Create data access layer following the established pattern from obras.ts:

1. Define TypeScript interfaces:
   - `Agrupamento`: id, obra_id, nome, ordem, created_at, updated_at
   - `AgrupamentoWithCount`: extends Agrupamento with unidades_count
   - `AgrupamentoInsert`: nome required, ordem optional
   - `AgrupamentoUpdate`: nome optional, ordem optional

2. Implement functions:
   - `listAgrupamentos(obraId: string)`: Returns AgrupamentoWithCount[], ordered by ordem ASC. Use Supabase aggregation for unidades count: `.select('*, unidades_count:unidades(count)')`.
   - `getAgrupamento(id: string)`: Returns single Agrupamento by ID.
   - `createAgrupamento(obraId: string, data: AgrupamentoInsert)`: Creates single agrupamento. Auto-assigns ordem as max(existing ordem) + 1.
   - `createAgrupamentosBatch(obraId: string, names: string[])`: Creates multiple agrupamentos. Get max ordem, then insert all with sequential ordem values.
   - `updateAgrupamento(id: string, data: AgrupamentoUpdate)`: Updates agrupamento.
   - `updateAgrupamentosOrder(obraId: string, orderedIds: string[])`: Updates ordem for all agrupamentos based on array order. Use Promise.all for parallel updates.
   - `deleteAgrupamento(id: string)`: Hard deletes agrupamento (cascade deletes unidades per DB schema).

3. Error messages in Portuguese: "Erro ao listar agrupamentos", "Erro ao criar agrupamento", etc.

Reference the RESEARCH.md code examples for batch creation and order update patterns.
  </action>
  <verify>
TypeScript compiles: `cd arden && npx tsc --noEmit`
File exports all expected functions: grep for each export name
  </verify>
  <done>
All CRUD functions exported, TypeScript types defined, error messages in Portuguese.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agrupamento validation schema and install @dnd-kit</name>
  <files>arden/lib/validations/agrupamento.ts, arden/package.json</files>
  <action>
Part A - Create Zod validation schema following obra.ts pattern:

1. Create `agrupamentoFormSchema`:
   - nome: z.string().min(1, 'Nome e obrigatorio').max(100, 'Nome deve ter no maximo 100 caracteres')

2. Create `agrupamentoBatchSchema` for batch creation:
   - prefixo: z.string().min(1, 'Prefixo e obrigatorio').max(50)
   - quantidade: z.number().int().min(1, 'Quantidade minima e 1').max(100, 'Quantidade maxima e 100')
   - numeroInicial: z.number().int().min(0, 'Numero inicial deve ser 0 ou maior')

3. Export types: `AgrupamentoFormData`, `AgrupamentoBatchData`

4. Export helper function `generateBatchNames(prefixo: string, quantidade: number, numeroInicial: number): string[]` that generates names like "Bloco 1", "Bloco 2", etc.

Part B - Install @dnd-kit packages:

Run: `npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`

Verify packages are in package.json dependencies.
  </action>
  <verify>
TypeScript compiles: `cd arden && npx tsc --noEmit`
Zod schema exports work: grep for exported names
@dnd-kit in package.json: `grep "@dnd-kit" arden/package.json`
  </verify>
  <done>
Zod schemas exported with Portuguese error messages, generateBatchNames helper works, @dnd-kit packages installed.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes without errors
2. All expected exports are present in both files
3. @dnd-kit packages are installed in package.json
4. Error messages are in Portuguese
</verification>

<success_criteria>
- Data access layer can perform all CRUD operations on agrupamentos table
- Zod schemas validate form input with Portuguese error messages
- Batch creation helper generates correct name sequences
- @dnd-kit packages are installed and ready for use in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/03-agrupamentos/03-01-SUMMARY.md`
</output>
