---
phase: 11-navegacao-integracao
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-grid.tsx
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx
  - arden/components/navigation/breadcrumb.tsx
  - arden/app/globals.css
autonomous: true

must_haves:
  truths:
    - "Clicking a cell in the matriz navigates to the individual verification page with servicoId and unidadeId as searchParams"
    - "The individual verification page shows a 'Voltar à matriz' back button that returns to the matriz page"
    - "Returning from dashboard (from=dashboard) navigates back to the obra dashboard"
    - "Matriz scroll position and expanded groups are preserved when returning from individual page"
    - "A temporary highlight animation plays on the cell that was just visited when returning to the matriz"
    - "Breadcrumb on individual verification page shows 'Obra > Verificações > Serviço - Unidade'"
  artifacts:
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx"
      provides: "Back button with context-aware navigation (dashboard vs matriz)"
      contains: "Voltar"
    - path: "arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx"
      provides: "State preservation via sessionStorage and highlight animation on return"
      contains: "sessionStorage"
    - path: "arden/components/navigation/breadcrumb.tsx"
      provides: "Extended breadcrumb for verification individual page"
      contains: "verificacaoId"
    - path: "arden/app/globals.css"
      provides: "CSS keyframe animation for highlight flash"
      contains: "highlight-flash"
  key_links:
    - from: "arden/app/app/obras/[id]/verificacoes/_components/matriz-grid.tsx"
      to: "/app/obras/[id]/verificacoes/[verificacaoId]"
      via: "router.push with servicoId and unidadeId searchParams"
      pattern: "servicoId.*unidadeId"
    - from: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx"
      to: "/app/obras/[id]/verificacoes"
      via: "router.push with highlight searchParam"
      pattern: "highlight"
    - from: "arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx"
      to: "sessionStorage"
      via: "Save before nav, restore on mount"
      pattern: "sessionStorage"
---

<objective>
Implement bi-directional navigation between the matriz and individual verification pages, with state preservation, highlight animation, and contextual breadcrumbs.

Purpose: The engineer can fluidly navigate from the matriz to inspect a specific verification and return to exactly where they were, with visual feedback showing what changed. This completes the integration of all verification features into a cohesive navigation flow.

Output: Back button, state preservation, highlight animation, extended breadcrumb, and updated cell click with context passing.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-navegacao-integracao/11-CONTEXT.md
@.planning/phases/11-navegacao-integracao/11-RESEARCH.md

Key existing files to read before modifying:
@arden/app/app/obras/[id]/verificacoes/_components/matriz-grid.tsx
@arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx
@arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx
@arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx
@arden/components/navigation/breadcrumb.tsx
@arden/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cell click context + back button + state preservation</name>
  <files>
    arden/app/app/obras/[id]/verificacoes/_components/matriz-grid.tsx
    arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx
  </files>
  <action>
  Four coordinated changes:

  **1. matriz-grid.tsx — Update cell click to pass context via searchParams:**

  In the `handleClick` callback, update the navigation mode (non-selection) to pass servicoId and unidadeId as searchParams. Also find the servico name and unidade code from the component's data to pass for breadcrumb context:

  ```typescript
  // Modo normal: navegação
  const key = `${servicoId}:${unidadeId}`
  const verificacao = verificacoesMap[key]
  // Find servico/unidade names for breadcrumb
  const servico = servicos.find(s => s.id === servicoId)
  const unidade = visibleUnits.find(u => u.id === unidadeId)
  const params = new URLSearchParams()
  params.set('servicoId', servicoId)
  params.set('unidadeId', unidadeId)
  if (servico) params.set('servico', servico.nome)
  if (unidade) params.set('unidade', unidade.codigo || unidade.nome)

  if (verificacao) {
    router.push(`/app/obras/${obraId}/verificacoes/${verificacao.id}?${params.toString()}`)
  } else {
    router.push(`/app/obras/${obraId}/verificacoes/nova?servico=${servicoId}&unidade=${unidadeId}`)
  }
  ```

  This requires adding `servicos` and `visibleUnits` to the `handleClick` dependency array. They are already available as props — add them to the `useCallback` deps.

  **2. matriz-client.tsx — Save state before navigation + restore on mount + highlight:**

  Add these capabilities to the MatrizClient component:

  a) **Import `useSearchParams` from 'next/navigation'** and add `useEffect` to existing imports.

  b) **Read highlight param on mount:**
  ```typescript
  const searchParams = useSearchParams()
  const highlightParam = searchParams.get('highlight')
  const [highlightCell, setHighlightCell] = useState<string | null>(highlightParam)
  ```

  c) **Clear highlight after animation (useEffect):**
  ```typescript
  useEffect(() => {
    if (highlightCell) {
      const timer = setTimeout(() => setHighlightCell(null), 1500)
      return () => clearTimeout(timer)
    }
  }, [highlightCell])
  ```

  d) **Restore state from sessionStorage on mount:**
  ```typescript
  useEffect(() => {
    const key = `matriz-state-${obraId}`
    const saved = sessionStorage.getItem(key)
    if (saved) {
      try {
        const { scrollY, expandedGroups: savedGroups } = JSON.parse(saved)
        if (savedGroups) {
          setExpandedGroups(new Set(savedGroups))
        }
        if (typeof scrollY === 'number') {
          setTimeout(() => window.scrollTo(0, scrollY), 0)
        }
      } catch {
        // Ignore parse errors
      }
      sessionStorage.removeItem(key)
    }
  }, [obraId])
  ```

  e) **Add a saveState callback** that saves current state to sessionStorage:
  ```typescript
  const saveMatrizState = useCallback(() => {
    const key = `matriz-state-${obraId}`
    sessionStorage.setItem(key, JSON.stringify({
      scrollY: window.scrollY,
      expandedGroups: Array.from(expandedGroups),
    }))
  }, [obraId, expandedGroups])
  ```

  f) **Pass `highlightCell` and `saveMatrizState` to MatrizGrid** as new props.

  g) **Update MatrizGrid props interface** to accept `highlightCell: string | null` and `onBeforeNavigate: () => void`.

  h) **In MatrizGrid**, before calling `router.push` in the navigation mode of handleClick, call `onBeforeNavigate()` to save state.

  i) **In MatrizGrid**, apply the highlight class: on the inner `<div>` of each data cell, if `highlightCell === key`, add the CSS class `highlight-flash`.

  **3. verificacao-header.tsx — Add back button with context-aware navigation:**

  Complete rewrite of VerificacaoHeader to include back button:

  - Add `import { useRouter, useSearchParams } from 'next/navigation'`
  - Add `import { ArrowLeft } from 'lucide-react'`
  - Add `obraId: string` to the props interface
  - Inside the component, read `from`, `servicoId`, `unidadeId` from searchParams
  - Add `handleBack` function:
    ```typescript
    const handleBack = () => {
      if (from === 'dashboard') {
        router.push(`/app/obras/${obraId}`)
      } else {
        // Default: go back to matriz with highlight
        const highlight = servicoId && unidadeId ? `${servicoId}:${unidadeId}` : null
        const params = new URLSearchParams()
        if (highlight) params.set('highlight', highlight)
        const url = `/app/obras/${obraId}/verificacoes`
        router.push(highlight ? `${url}?${params.toString()}` : url)
      }
    }
    ```
  - Add a back button BEFORE the existing header content:
    ```tsx
    <Button
      variant="ghost"
      size="sm"
      onClick={handleBack}
      className="mb-2 -ml-2 gap-1.5 text-foreground-light hover:text-foreground"
    >
      <ArrowLeft className="w-4 h-4" />
      {from === 'dashboard' ? 'Voltar ao painel' : 'Voltar à matriz'}
    </Button>
    ```
  - Keep the existing breadcrumb line (`obraNome / unidadeNome`) and all existing header content unchanged.

  **4. verificacao-individual-client.tsx — Pass obraId to header:**

  - Add `obraId: string` to VerificacaoIndividualClientProps
  - Pass `obraId={obraId}` to `<VerificacaoHeader>`

  **5. page.tsx of verificacao individual — Pass obraId:**

  - Pass `obraId={obraId}` to `<VerificacaoIndividualClient>`
  </action>
  <verify>
  Run `cd arden && npx tsc --noEmit` to verify no type errors.
  </verify>
  <done>
  Cell click in matriz passes servicoId/unidadeId/servico/unidade as searchParams. Back button in verification header navigates context-aware (dashboard or matriz with highlight). Matriz saves scroll+expandedGroups to sessionStorage before navigation and restores on mount. Highlight cell key is read from searchParams on mount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Highlight animation CSS + breadcrumb extension</name>
  <files>
    arden/app/globals.css
    arden/components/navigation/breadcrumb.tsx
  </files>
  <action>
  Two changes:

  **1. globals.css — Add highlight-flash keyframe animation:**

  Add at the end of the file (or in the appropriate animation section):

  ```css
  /* Highlight flash animation for matriz cell after returning from individual page */
  @keyframes highlight-flash {
    0%, 100% {
      box-shadow: none;
    }
    25%, 75% {
      box-shadow: 0 0 0 2px hsl(var(--brand));
    }
  }

  .highlight-flash {
    animation: highlight-flash 1.5s ease-in-out;
  }
  ```

  This creates a pulsing border glow effect using the brand color that lasts 1.5 seconds.

  **2. breadcrumb.tsx — Extend for verification individual context:**

  In the breadcrumb component, extend the logic inside the `if (obraId)` block to handle the verification individual route. The current code handles one level deep (section). We need to handle two levels: section + detail.

  After the existing section detection block (`if (section && sectionLabels[section]) { crumbs.push(...) }`), add:

  ```typescript
  // Handle verification individual route: /obras/[id]/verificacoes/[verificacaoId]
  if (section === 'verificacoes') {
    const verificacaoId = pathSegments[idIndex + 2]
    if (verificacaoId && verificacaoId !== 'nova') {
      // Make "Verificações" a link to the matriz
      const lastCrumb = crumbs[crumbs.length - 1]
      if (lastCrumb && lastCrumb.label === 'Verificações') {
        lastCrumb.href = `/app/obras/${obraId}/verificacoes`
      }

      // Add context crumb from searchParams
      const servicoName = searchParams.get('servico')
      const unidadeName = searchParams.get('unidade')
      if (servicoName && unidadeName) {
        crumbs.push({
          label: `${servicoName} — ${unidadeName}`,
        })
      } else {
        crumbs.push({
          label: 'Verificação',
        })
      }
    }
  }
  ```

  This requires:
  - Add `useSearchParams` to the import from 'next/navigation' (currently only imports `usePathname` and `useParams`)
  - Add `const searchParams = useSearchParams()` inside the component

  Important: The `searchParams` import is `useSearchParams` (the hook), NOT the page-level searchParams prop.

  The breadcrumb flow for `/app/obras/123/verificacoes/456?servico=Alvenaria&unidade=101`:
  - Pfeil > Obra Name > Verificações > Alvenaria — 101

  Where "Verificações" is a link back to the matriz and "Alvenaria — 101" is the current page (no link).
  </action>
  <verify>
  Run `cd arden && npm run build` to verify no build errors. Check that globals.css contains the highlight-flash keyframe. Check that breadcrumb.tsx imports useSearchParams.
  </verify>
  <done>
  CSS highlight-flash animation defined in globals.css with brand color pulse. Breadcrumb shows "Obra > Verificações > Serviço — Unidade" on individual verification pages, with "Verificações" as a link to the matriz. Falls back to "Verificação" label if searchParams not available.
  </done>
</task>

</tasks>

<verification>
1. `cd arden && npm run build` succeeds without errors
2. globals.css contains `@keyframes highlight-flash` animation
3. Breadcrumb shows contextual path on verification individual pages
4. Back button exists in verification header with context-aware text
5. Cell click passes servicoId/unidadeId/servico/unidade as searchParams
6. Matriz state (scroll, expandedGroups) saved to sessionStorage before navigation
7. Matriz restores state from sessionStorage on mount
8. Highlight animation applies to cell matching `highlight` searchParam
</verification>

<success_criteria>
- Bi-directional navigation between matriz and individual page works
- Back button context-aware: "Voltar ao painel" (from dashboard) or "Voltar à matriz" (from matriz)
- State preservation: scroll position and expanded groups restored on return
- Highlight animation plays on the cell that was visited
- Breadcrumb shows "Obra > Verificações > Serviço — Unidade"
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-navegacao-integracao/11-02-SUMMARY.md`
</output>
