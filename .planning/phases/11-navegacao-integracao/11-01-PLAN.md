---
phase: 11-navegacao-integracao
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - arden/lib/supabase/queries/dashboard.ts
  - arden/app/app/obras/[id]/_components/nc-feed.tsx
  - arden/app/app/obras/[id]/_components/obra-dashboard.tsx
  - arden/app/app/obras/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "NC feed items display format 'Agrupamento > Unidade' on the main line"
    - "Clicking an NC feed item navigates to the individual verification page"
    - "'Ver todas as NCs' button is removed from the feed"
    - "NCFeedItem type includes verificacaoId and agrupamentoNome"
  artifacts:
    - path: "arden/lib/supabase/queries/dashboard.ts"
      provides: "Extended getRecentNCs query with verificacao_id and agrupamento join"
      contains: "verificacaoId"
    - path: "arden/app/app/obras/[id]/_components/nc-feed.tsx"
      provides: "Clickable NC feed with navigation and agrupamento display"
      contains: "router.push"
  key_links:
    - from: "arden/app/app/obras/[id]/_components/nc-feed.tsx"
      to: "/app/obras/[id]/verificacoes/[verificacaoId]"
      via: "router.push with searchParams (from=dashboard, servico, unidade)"
      pattern: "router\\.push.*verificacoes"
    - from: "arden/app/app/obras/[id]/page.tsx"
      to: "arden/app/app/obras/[id]/_components/obra-dashboard.tsx"
      via: "obraId prop threaded through to NCFeed"
      pattern: "obraId"
---

<objective>
Enhance the NC Feed on the obra dashboard to show agrupamento context and enable click-through navigation to individual verification pages.

Purpose: The NC feed becomes an actionable shortcut — the engineer sees an open NC and clicks to navigate directly to the verification where they can resolve it. Currently the feed shows data but has no navigation and lacks agrupamento context.

Output: Updated query, type, and component files that make the NC feed fully functional as a navigation entry point to verification individual pages.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-navegacao-integracao/11-CONTEXT.md
@.planning/phases/11-navegacao-integracao/11-RESEARCH.md

Key existing files to read before modifying:
@arden/lib/supabase/queries/dashboard.ts
@arden/app/app/obras/[id]/_components/nc-feed.tsx
@arden/app/app/obras/[id]/_components/obra-dashboard.tsx
@arden/app/app/obras/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend getRecentNCs query and NCFeedItem type</name>
  <files>arden/lib/supabase/queries/dashboard.ts</files>
  <action>
  Modify the `NCFeedItem` interface and `getRecentNCs` function in dashboard.ts:

  1. **Extend NCFeedItem interface** — add two new fields:
     ```typescript
     export interface NCFeedItem {
       id: string
       verificacaoId: string           // NEW — the verificacao UUID for navigation
       servicoNome: string
       unidadeCodigo: string
       agrupamentoNome: string | null  // NEW — agrupamento name for display
       observacao: string | null
       createdAt: string
     }
     ```

  2. **Update getRecentNCs query** — extend the select to include `verificacao_id` from the join and `agrupamento.nome` via unidade. The join path is:
     - itens_verificacao -> verificacoes (has `id` for verificacaoId)
     - verificacoes -> unidades -> agrupamentos (has `nome` for agrupamentoNome)

     Update the select string to include:
     ```
     verificacao:verificacoes!inner(
       id,
       obra_id,
       servico:servicos(nome),
       unidade:unidades(
         nome,
         codigo,
         agrupamento:agrupamentos(nome)
       )
     )
     ```

  3. **Update the return mapping** to extract `verificacaoId` from `verificacao.id` and `agrupamentoNome` from `verificacao.unidade.agrupamento.nome`.

     The mapping should be:
     ```typescript
     return {
       id: item.id,
       verificacaoId: (verificacao as any).id || item.id,
       servicoNome: verificacao.servico?.nome || 'Serviço desconhecido',
       unidadeCodigo: verificacao.unidade?.codigo || verificacao.unidade?.nome || 'Unidade desconhecida',
       agrupamentoNome: (verificacao.unidade as any)?.agrupamento?.nome || null,
       observacao: item.observacao,
       createdAt: item.created_at
     }
     ```

  Note: The `verificacao` type assertion is already present. Extend the assertion type to include `id: string` and the nested `agrupamento`.
  </action>
  <verify>
  Run `cd arden && npx tsc --noEmit` to verify no type errors. Check that the NCFeedItem interface exports correctly.
  </verify>
  <done>
  NCFeedItem type includes verificacaoId (string) and agrupamentoNome (string | null). getRecentNCs query joins through agrupamentos to fetch the agrupamento name and returns verificacao.id as verificacaoId.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update NC feed component with navigation and agrupamento display</name>
  <files>
    arden/app/app/obras/[id]/_components/nc-feed.tsx
    arden/app/app/obras/[id]/_components/obra-dashboard.tsx
    arden/app/app/obras/[id]/page.tsx
  </files>
  <action>
  Make three coordinated changes to thread obraId and enable navigation:

  **1. nc-feed.tsx — Full update:**
  - Add `import { useRouter } from 'next/navigation'`
  - Add `obraId: string` to the NCFeedProps interface
  - Add `const router = useRouter()` inside the component
  - Add a `handleNCClick` function:
    ```typescript
    const handleNCClick = (nc: NCFeedItem) => {
      const params = new URLSearchParams({
        servico: nc.servicoNome,
        unidade: nc.unidadeCodigo,
        from: 'dashboard',
      })
      router.push(`/app/obras/${obraId}/verificacoes/${nc.verificacaoId}?${params.toString()}`)
    }
    ```
  - On each NC item div, add `onClick={() => handleNCClick(nc)}`
  - Change the display format from `{nc.servicoNome} - {nc.unidadeCodigo}` to show agrupamento context:
    ```tsx
    <p className="text-sm font-medium text-foreground">
      {nc.agrupamentoNome ? `${nc.agrupamentoNome} > ${nc.unidadeCodigo}` : nc.unidadeCodigo}
    </p>
    <p className="text-xs text-foreground-lighter mt-0.5">
      {nc.servicoNome}
    </p>
    ```
    This shows "Agrupamento > Unidade" on the main line, with the servico name below it.
  - **Remove** the entire "Ver todas link" section at the bottom (the `<div className="p-3 border-t...">` with the "Ver todas as NCs" button)

  **2. obra-dashboard.tsx — Thread obraId:**
  - Add `obraId: string` to ObraDashboardProps
  - Pass `obraId` to NCFeed: `<NCFeed ncs={ncs} obraId={obraId} />`

  **3. page.tsx — Pass obraId:**
  - Add `obraId={id}` to the `<ObraDashboard>` component call (the `id` variable is already available from params)
  </action>
  <verify>
  Run `cd arden && npx tsc --noEmit` to verify no type errors. Run `cd arden && npm run build` to verify no build errors.
  </verify>
  <done>
  NC feed items display "Agrupamento > Unidade" on the main line with serviço name below. Clicking an NC item navigates to `/app/obras/{obraId}/verificacoes/{verificacaoId}?servico=X&unidade=Y&from=dashboard`. The "Ver todas as NCs" button is removed. obraId is threaded from page.tsx through ObraDashboard to NCFeed.
  </done>
</task>

</tasks>

<verification>
1. `cd arden && npm run build` succeeds without errors
2. NCFeedItem type exports `verificacaoId` and `agrupamentoNome` fields
3. NC feed component has no "Ver todas as NCs" button
4. NC feed items show "Agrupamento > Unidade" format
5. Clicking NC item navigates with correct URL pattern including `from=dashboard` param
</verification>

<success_criteria>
- getRecentNCs returns NCFeedItem with verificacaoId and agrupamentoNome
- NC feed displays agrupamento context and navigates on click
- "Ver todas as NCs" button removed
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-navegacao-integracao/11-01-SUMMARY.md`
</output>
