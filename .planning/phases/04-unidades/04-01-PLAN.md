---
phase: 04-unidades
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - arden/lib/supabase/queries/unidades.ts
  - arden/lib/validations/unidade.ts
autonomous: true

must_haves:
  truths:
    - "Unidades can be fetched from Supabase for a given agrupamento"
    - "Unidades can be created, updated, and deleted via data layer"
    - "Batch creation generates sequential names from numeric range"
    - "Natural sort orders Apto 2 before Apto 10"
  artifacts:
    - path: "arden/lib/supabase/queries/unidades.ts"
      provides: "CRUD operations for unidades table"
      exports: ["Unidade", "UnidadeInsert", "UnidadeUpdate", "listUnidades", "createUnidade", "createUnidadesBatch", "updateUnidade", "deleteUnidade"]
    - path: "arden/lib/validations/unidade.ts"
      provides: "Zod schemas and batch name generation"
      exports: ["unidadeFormSchema", "UnidadeFormData", "unidadeBatchSchema", "UnidadeBatchData", "parseNumericRange", "generateUnidadeNames"]
  key_links:
    - from: "arden/lib/supabase/queries/unidades.ts"
      to: "supabase.unidades"
      via: "Supabase client queries"
      pattern: "from\\('unidades'\\)"
---

<objective>
Create the data access layer and validation schemas for unidades (units within agrupamentos).

Purpose: Foundation for all unidades CRUD operations. Similar to agrupamentos data layer but with numeric range batch creation (e.g., "Apto 101-110") instead of prefix+count batch.

Output: Two files - unidades.ts (Supabase queries) and unidade.ts (Zod schemas + helpers)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-unidades/04-CONTEXT.md
@.planning/phases/04-unidades/04-RESEARCH.md

# Existing patterns to follow
@arden/lib/supabase/queries/agrupamentos.ts
@arden/lib/validations/agrupamento.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unidades data access layer</name>
  <files>arden/lib/supabase/queries/unidades.ts</files>
  <action>
Create data access layer following the agrupamentos.ts pattern exactly.

**Interfaces:**
- `Unidade`: id, agrupamento_id, nome, codigo (nullable), ordem, created_at, updated_at
- `UnidadeInsert`: nome required, codigo optional, ordem optional
- `UnidadeUpdate`: all fields optional

**Functions:**
1. `listUnidades(agrupamentoId: string)`:
   - Select all from unidades where agrupamento_id matches
   - Order by ordem ASC from DB
   - Apply natural sort client-side using `new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' })`
   - Return sorted Unidade[]

2. `createUnidade(agrupamentoId: string, data: UnidadeInsert)`:
   - Get max ordem for this agrupamento
   - Insert with ordem = max + 1 (or data.ordem if provided)
   - Return created Unidade

3. `createUnidadesBatch(agrupamentoId: string, names: string[])`:
   - Get max ordem for this agrupamento
   - Insert all with sequential ordem starting from max + 1
   - Return Unidade[]

4. `updateUnidade(id: string, updates: UnidadeUpdate)`:
   - Update by ID
   - Return updated Unidade

5. `deleteUnidade(id: string)`:
   - Hard delete by ID
   - Return void

**Error messages in Portuguese:** "Erro ao listar unidades", "Erro ao criar unidade", etc.
  </action>
  <verify>
- File exists at arden/lib/supabase/queries/unidades.ts
- TypeScript compiles: `cd arden && npx tsc --noEmit`
- All 5 functions exported
  </verify>
  <done>Data access layer provides full CRUD for unidades with natural sort and batch support</done>
</task>

<task type="auto">
  <name>Task 2: Create unidade validation schemas with numeric range parser</name>
  <files>arden/lib/validations/unidade.ts</files>
  <action>
Create validation schemas following agrupamento.ts pattern but with DIFFERENT batch approach.

**Schemas:**

1. `unidadeFormSchema`: For single unidade create/edit
   - nome: required, min 1, max 100 chars
   - Error messages in Portuguese

2. `unidadeBatchSchema`: For batch creation with numeric range
   - rangeInput: string that validates against pattern "Prefixo inicio-fim" or "inicio-fim"
   - Use .refine() to validate:
     - Matches regex `^(.+?\s)?(\d+)-(\d+)$`
     - start <= end
     - end - start + 1 <= 500 (max 500 units per batch)
   - Error message: "Formato invalido. Use \"Prefixo inicio-fim\" (ex: Apto 101-110). Maximo 500 unidades."

**Helper functions:**

3. `parseNumericRange(input: string)`:
   - Returns `{ prefix: string, start: number, end: number } | null`
   - Regex: `^(.+?\s)?(\d+)-(\d+)$`
   - prefix is trimmed (empty string if no prefix)
   - Returns null if invalid format or start > end or range > 500

4. `generateUnidadeNames(parsed: { prefix: string, start: number, end: number })`:
   - Returns string[] of generated names
   - Format: `${prefix} ${i}` if prefix exists, else `${i}` (just number)
   - Example: parseNumericRange("Apto 101-103") -> generateUnidadeNames -> ["Apto 101", "Apto 102", "Apto 103"]

**Export types:** UnidadeFormData, UnidadeBatchData
  </action>
  <verify>
- File exists at arden/lib/validations/unidade.ts
- TypeScript compiles: `cd arden && npx tsc --noEmit`
- parseNumericRange("Apto 101-103") returns { prefix: "Apto", start: 101, end: 103 }
- parseNumericRange("101-105") returns { prefix: "", start: 101, end: 105 }
- parseNumericRange("invalid") returns null
- generateUnidadeNames({ prefix: "Apto", start: 101, end: 103 }) returns ["Apto 101", "Apto 102", "Apto 103"]
  </verify>
  <done>Validation schemas ready with numeric range parsing for batch creation</done>
</task>

</tasks>

<verification>
All verification passes:
1. Both files compile without TypeScript errors
2. Exports match expected interfaces
3. Helper functions produce correct output for edge cases
</verification>

<success_criteria>
- unidades.ts provides all CRUD operations matching agrupamentos.ts pattern
- unidade.ts provides validation with numeric range batch (different from agrupamentos prefix+count)
- Natural sort implemented using Intl.Collator
- All error messages in Portuguese
- Ready for UI integration in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/04-unidades/04-01-SUMMARY.md`
</output>
