---
phase: 04-unidades
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - arden/app/app/obras/[id]/agrupamentos/page.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-page-client.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/split-view-layout.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-panel.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/unidades-panel.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/unidade-form-modal.tsx
  - arden/app/app/obras/[id]/agrupamentos/_components/unidade-delete-confirmation.tsx
autonomous: true

must_haves:
  truths:
    - "User sees split-view layout with agrupamentos on left and unidades on right"
    - "User can click an agrupamento to see its unidades in the right panel"
    - "User can create a new unidade (single or batch) and it appears in the list"
    - "User can edit an existing unidade name"
    - "User can delete a unidade with confirmation"
    - "Mobile layout stacks panels vertically"
    - "Badge count shows inline with agrupamento name"
  artifacts:
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/split-view-layout.tsx"
      provides: "Master-detail container with responsive widths"
      min_lines: 15
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-panel.tsx"
      provides: "Left panel with selectable agrupamentos list"
      min_lines: 50
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/unidades-panel.tsx"
      provides: "Right panel showing unidades for selected agrupamento"
      min_lines: 80
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/unidade-form-modal.tsx"
      provides: "Create/edit modal with batch mode toggle"
      min_lines: 100
    - path: "arden/app/app/obras/[id]/agrupamentos/_components/unidade-delete-confirmation.tsx"
      provides: "Delete confirmation AlertDialog"
      min_lines: 30
  key_links:
    - from: "agrupamentos-page-client.tsx"
      to: "split-view-layout.tsx"
      via: "Component composition"
      pattern: "<SplitViewLayout"
    - from: "unidades-panel.tsx"
      to: "listUnidades"
      via: "useEffect fetch on agrupamento selection"
      pattern: "listUnidades\\(.*agrupamento"
    - from: "unidade-form-modal.tsx"
      to: "createUnidade|createUnidadesBatch"
      via: "Form submission"
      pattern: "create(Unidade|UnidadesBatch)"
---

<objective>
Transform the agrupamentos page into a split-view layout with unidades CRUD.

Purpose: Complete the Phase 4 UI allowing users to manage unidades within agrupamentos using a master-detail pattern.

Output: Refactored agrupamentos page with split-view, selection state, unidades panel, and create/edit/delete modals for unidades.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-unidades/04-CONTEXT.md
@.planning/phases/04-unidades/04-RESEARCH.md
@.planning/phases/04-unidades/04-01-SUMMARY.md

# Existing components to modify
@arden/app/app/obras/[id]/agrupamentos/page.tsx
@arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-page-client.tsx
@arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-table.tsx
@arden/app/app/obras/[id]/agrupamentos/_components/agrupamento-form-modal.tsx

# Pattern references
@arden/app/app/obras/[id]/agrupamentos/_components/delete-confirmation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create split-view layout and refactor agrupamentos panel</name>
  <files>
    arden/app/app/obras/[id]/agrupamentos/_components/split-view-layout.tsx
    arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-panel.tsx
    arden/app/app/obras/[id]/agrupamentos/_components/agrupamentos-page-client.tsx
    arden/app/app/obras/[id]/agrupamentos/page.tsx
  </files>
  <action>
**1. Create SplitViewLayout component:**
```typescript
// split-view-layout.tsx
interface SplitViewLayoutProps {
  leftPanel: React.ReactNode
  rightPanel: React.ReactNode
}

export function SplitViewLayout({ leftPanel, rightPanel }: SplitViewLayoutProps) {
  return (
    <div className="flex flex-col lg:flex-row gap-6">
      <div className="w-full lg:w-2/5">{leftPanel}</div>
      <div className="w-full lg:w-3/5">{rightPanel}</div>
    </div>
  )
}
```

**2. Create AgrupamentosPanel component:**
Extract agrupamentos display logic from agrupamentos-table.tsx into a new panel component.

Key features:
- Page header: "Agrupamentos" title + obra name subtitle
- Toolbar with "Novo Agrupamento" button (keep reorder button if >1 agrupamentos)
- Clickable list items (NOT table rows) for better selection UX
- Selected item styling: `bg-surface-200 border-l-2 border-brand`
- Each item shows: nome + count inline as "(N)" in muted text
- Empty state: "Nenhum agrupamento" with create button
- Support reorder mode (keep existing dnd-kit functionality)

Props interface:
```typescript
interface AgrupamentosPanelProps {
  agrupamentos: AgrupamentoWithCount[]
  obraNome: string
  selectedId: string | null
  onSelect: (id: string) => void
  onCreateClick: () => void
  onEditClick: (agrupamento: AgrupamentoWithCount) => void
  onDeleteClick: (agrupamento: AgrupamentoWithCount) => void
  isReorderMode: boolean
  onReorderStart: () => void
  onReorderSave: (orderedIds: string[]) => void
  onReorderCancel: () => void
}
```

**3. Modify agrupamentos-page-client.tsx:**
- Add `selectedAgrupamentoId` state: `useState<string | null>(null)`
- Add handler `handleSelectAgrupamento(id: string)`
- Replace AgrupamentosTable with SplitViewLayout
- Pass AgrupamentosPanel as leftPanel
- Pass UnidadesPanel as rightPanel (will create in Task 2)
- Import and render UnidadeFormModal and UnidadeDeleteConfirmation (from Task 3)

**4. Update page.tsx:**
No changes needed - Server Component already fetches agrupamentos with counts.

**Design notes from CONTEXT.md:**
- Selection highlight: bg-surface-200 + border-l-2 border-brand
- Count display: "Bloco A (12)" inline format
- Mobile: flex-col (stacks)
- Desktop: flex-row with lg:w-2/5 / lg:w-3/5
  </action>
  <verify>
- All files compile: `cd arden && npx tsc --noEmit`
- AgrupamentosPanel displays clickable list with selection styling
- Count shows inline with agrupamento name
- Reorder functionality preserved
  </verify>
  <done>Split-view layout implemented with selectable agrupamentos panel on left side</done>
</task>

<task type="auto">
  <name>Task 2: Create unidades panel with empty state and list display</name>
  <files>arden/app/app/obras/[id]/agrupamentos/_components/unidades-panel.tsx</files>
  <action>
Create the right panel that shows unidades for the selected agrupamento.

**Component structure:**

```typescript
interface UnidadesPanelProps {
  agrupamento: AgrupamentoWithCount | null
  onCreateClick: () => void
  onEditClick: (unidade: Unidade) => void
  onDeleteClick: (unidade: Unidade) => void
}
```

**Behavior:**

1. **No agrupamento selected (agrupamento === null):**
   Show empty state with Database icon:
   ```
   [Database icon - h-12 w-12 text-foreground-muted]
   "Selecione um agrupamento"
   "Clique em um agrupamento a esquerda para ver suas unidades."
   ```
   Use same empty state pattern as agrupamentos-table.tsx

2. **Agrupamento selected:**
   - Header: "Unidades de {agrupamento.nome}"
   - Toolbar: "Nova Unidade" button (right-aligned)
   - Fetch unidades using `listUnidades(agrupamento.id)` in useEffect
   - Show loading state while fetching
   - If no unidades: empty state "Nenhuma unidade cadastrada" + "Criar primeira unidade" button
   - If unidades exist: show list/table

3. **Unidades list display:**
   Use Table component for consistency:
   - Columns: Nome, Acoes (dropdown)
   - Dropdown menu: Editar, Separator, Excluir (destructive)
   - List should auto-refresh when agrupamento changes

**Data fetching pattern:**
```typescript
const [unidades, setUnidades] = useState<Unidade[]>([])
const [isLoading, setIsLoading] = useState(false)

useEffect(() => {
  if (!agrupamento) {
    setUnidades([])
    return
  }

  setIsLoading(true)
  listUnidades(agrupamento.id)
    .then(setUnidades)
    .catch((error) => toast.error(error.message))
    .finally(() => setIsLoading(false))
}, [agrupamento?.id])
```

**Refresh pattern:**
Export a function or use a key prop to trigger refetch after create/edit/delete.
Option: Accept `refreshKey` prop that increments on mutations.
  </action>
  <verify>
- File compiles: `cd arden && npx tsc --noEmit`
- Empty state shows when no agrupamento selected
- Loading state shows while fetching
- Unidades list renders when data loaded
- Dropdown actions visible for each unidade
  </verify>
  <done>Unidades panel displays correctly with empty states and list view</done>
</task>

<task type="auto">
  <name>Task 3: Create unidade form modal and delete confirmation</name>
  <files>
    arden/app/app/obras/[id]/agrupamentos/_components/unidade-form-modal.tsx
    arden/app/app/obras/[id]/agrupamentos/_components/unidade-delete-confirmation.tsx
  </files>
  <action>
**1. Create UnidadeFormModal:**

Follow agrupamento-form-modal.tsx pattern but with DIFFERENT batch approach:

Props:
```typescript
interface UnidadeFormModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
  mode: 'create' | 'edit'
  unidade: Unidade | null
  agrupamentoId: string
}
```

**Single mode form:**
- Field: nome (input)
- Use unidadeFormSchema for validation
- Submit: createUnidade or updateUnidade

**Batch mode form (create only):**
- Checkbox: "Criar multiplas unidades"
- Field: rangeInput with placeholder "Apto 101-110"
- Use unidadeBatchSchema for validation
- Preview: Show first 5 names + "..." + "(N unidades)" if more
- Submit: parse rangeInput with parseNumericRange, generate names with generateUnidadeNames, call createUnidadesBatch

**Preview pattern (from CONTEXT.md):**
```typescript
const parsed = parseNumericRange(rangeInput)
if (parsed) {
  const names = generateUnidadeNames(parsed)
  const preview = names.slice(0, 5)
  const hasMore = names.length > 5
  // Show: preview.join(', ') + (hasMore ? `, ... (${names.length} unidades)` : '')
}
```

**Dialog structure:**
- Title: "Nova Unidade" or "Editar Unidade"
- Description changes for batch mode
- Footer: Cancel + Submit buttons

**2. Create UnidadeDeleteConfirmation:**

Follow delete-confirmation.tsx pattern exactly:

Props:
```typescript
interface UnidadeDeleteConfirmationProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  unidade: Unidade | null
  onSuccess: () => void
}
```

- AlertDialog with destructive variant
- Title: "Excluir Unidade"
- Description: 'Tem certeza que deseja excluir a unidade "{nome}"? Esta acao nao pode ser desfeita.'
- Buttons: Cancelar (outline) + Excluir (destructive)
- On confirm: call deleteUnidade, show toast, call onSuccess
- Handle loading state during deletion
  </action>
  <verify>
- Both files compile: `cd arden && npx tsc --noEmit`
- UnidadeFormModal:
  - Creates single unidade successfully
  - Creates batch unidades with "Apto 101-105" input
  - Preview shows correct names
  - Edit mode updates existing unidade
- UnidadeDeleteConfirmation:
  - Shows confirmation dialog
  - Deletes unidade on confirm
  - Shows toast feedback
  </verify>
  <done>Create, edit, and delete modals fully functional for unidades</done>
</task>

</tasks>

<verification>
Full integration testing:
1. Navigate to /app/obras/[id]/agrupamentos
2. See split-view layout (agrupamentos left, empty state right)
3. Click an agrupamento - right panel shows its unidades
4. Create single unidade - appears in list
5. Create batch "Apto 101-105" - 5 unidades appear
6. Edit a unidade name - change persists
7. Delete a unidade - removed from list
8. On mobile viewport - panels stack vertically
</verification>

<success_criteria>
- UNID-01: User sees list of unidades when agrupamento selected
- UNID-02: User creates new unidade via modal
- UNID-03: User edits unidade name via modal
- UNID-04: User deletes unidade with confirmation
- UNID-05: User creates batch with "Apto 101-110" format
- UI follows design decisions from CONTEXT.md (split-view, selection styling, badge count)
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-unidades/04-02-SUMMARY.md`
</output>
