---
phase: 04-unidades
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - database/rls-policies.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Engenheiros can create unidades (not just admins)"
    - "Engenheiros can update unidades"
    - "Engenheiros can delete unidades"
  artifacts:
    - path: "database/rls-policies.sql"
      provides: "Updated RLS policies for unidades"
  key_links:
    - from: "database/rls-policies.sql"
      to: "unidades table"
      via: "RLS policies"
      pattern: "unidades_(insert|update|delete)"
---

<objective>
Fix RLS policies to allow engenheiros to manage unidades.

Purpose: Engenheiros (not just admins) should be able to create, edit, and delete unidades per the PRD. This is the same fix applied to agrupamentos in 03-04.
Output: Updated database/rls-policies.sql with is_admin_or_engenheiro() for unidades CRUD.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-unidades/04-UAT.md
@.planning/phases/03-agrupamentos/03-04-SUMMARY.md (same pattern)

# Root cause from UAT
RLS policies unidades_insert, unidades_update, unidades_delete require is_admin() but engenheiros also need access per PRD.
Lines 264-292 in database/rls-policies.sql need to change is_admin() to is_admin_or_engenheiro().

# Reference: Phase 3 fix
The identical fix was applied to agrupamentos in Phase 3 Plan 04. Follow the same pattern.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update unidades RLS policies</name>
  <files>database/rls-policies.sql</files>
  <action>
Update the following policies in database/rls-policies.sql:

1. `unidades_insert` (lines 264-272):
   Change `is_admin()` to `is_admin_or_engenheiro()` in the WHERE clause

2. `unidades_update` (lines 274-282):
   Change `is_admin()` to `is_admin_or_engenheiro()` in the WHERE clause

3. `unidades_delete` (lines 284-292):
   Change `is_admin()` to `is_admin_or_engenheiro()` in the WHERE clause

4. Update the comment above (line 263):
   Change "INSERT/UPDATE/DELETE: Apenas admin" to "INSERT/UPDATE/DELETE: Admin ou engenheiro"

This allows both admins and engenheiros to manage unidades, which aligns with the PRD where engenheiros configure obras.
  </action>
  <verify>
Verify:
1. All three policies now use is_admin_or_engenheiro()
2. Comment updated to reflect new permission level
3. SELECT policy unchanged (already allows engenheiro access)
  </verify>
  <done>
unidades RLS policies updated to allow engenheiro access for INSERT/UPDATE/DELETE operations.
  </done>
</task>

</tasks>

<verification>
- [ ] unidades_insert uses is_admin_or_engenheiro()
- [ ] unidades_update uses is_admin_or_engenheiro()
- [ ] unidades_delete uses is_admin_or_engenheiro()
- [ ] Comment reflects "Admin ou engenheiro"
</verification>

<success_criteria>
- RLS policies updated in database/rls-policies.sql
- Same pattern as agrupamentos policies (for consistency)
</success_criteria>

<output>
After completion, create `.planning/phases/04-unidades/04-03-SUMMARY.md`
</output>

<user_action_required>
After this plan executes, the user must apply the migration to their Supabase instance:

```bash
# If using Supabase CLI with local database
npx supabase db push

# Or run the SQL directly in Supabase Dashboard > SQL Editor
```

This is a database change that cannot be applied by code alone.
</user_action_required>
