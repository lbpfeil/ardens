---
phase: 10-selecao-operacoes-massa
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-grid.tsx
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-header.tsx
autonomous: true

must_haves:
  truths:
    - "Existe um botão 'Selecionar' na toolbar da matriz que ativa o modo de seleção"
    - "Clicar numa célula no modo de seleção faz toggle (adiciona/remove) em vez de navegar"
    - "Clicar numa célula no modo normal continua navegando para a verificação individual"
    - "Células selecionadas exibem feedback visual (ring/borda brand)"
    - "Clicar no nome de um serviço no modo de seleção seleciona toda a linha"
    - "Clicar no header de uma unidade no modo de seleção seleciona toda a coluna"
    - "Tecla Esc sai do modo de seleção e limpa as células selecionadas"
    - "Cursor muda para cursor-cell no modo de seleção"
  artifacts:
    - path: "arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx"
      provides: "Estado de seleção (isSelectionMode, selectedCells Set, handlers)"
      contains: "isSelectionMode"
    - path: "arden/app/app/obras/[id]/verificacoes/_components/matriz-grid.tsx"
      provides: "Dual-mode click handler + visual feedback nas células selecionadas"
      contains: "selectedCells"
    - path: "arden/app/app/obras/[id]/verificacoes/_components/matriz-header.tsx"
      provides: "Data attributes para seleção de coluna via header de unidade"
      contains: "data-header-unidade"
  key_links:
    - from: "matriz-client.tsx"
      to: "matriz-grid.tsx"
      via: "props isSelectionMode, selectedCells, onToggleCell, onSelectRow, onSelectColumn"
      pattern: "isSelectionMode.*selectedCells"
    - from: "matriz-grid.tsx"
      to: "matriz-client.tsx"
      via: "callback onToggleCell chamado no handleClick quando isSelectionMode=true"
      pattern: "onToggleCell"
    - from: "matriz-header.tsx"
      to: "matriz-grid.tsx"
      via: "data-header-unidade capturado pelo event delegation do grid"
      pattern: "data-header-unidade"
---

<objective>
Implementar a infraestrutura de seleção de células na matriz de verificações: modo de seleção explícito, toggle de células individuais, seleção de linhas/colunas via headers, e feedback visual nas células selecionadas.

Purpose: Permite ao engenheiro selecionar múltiplas células na matriz antes de executar operações em massa (BULK-01 a BULK-05).
Output: Matriz com modo de seleção funcional -- células podem ser selecionadas/deselecionadas com feedback visual claro.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-selecao-operacoes-massa/10-CONTEXT.md
@.planning/phases/10-selecao-operacoes-massa/10-RESEARCH.md

Arquivos-fonte que serão modificados:
@arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx
@arden/app/app/obras/[id]/verificacoes/_components/matriz-grid.tsx
@arden/app/app/obras/[id]/verificacoes/_components/matriz-header.tsx
@arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts

Referências de tipos e dados:
@arden/lib/supabase/queries/verificacoes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Estado de seleção no orchestrador + botão Selecionar</name>
  <files>arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx</files>
  <action>
Adicionar ao `MatrizClient` toda a infraestrutura de estado de seleção:

1. **Novos estados:**
   - `isSelectionMode: boolean` (useState, default false)
   - `selectedCells: Set<string>` (useState, default new Set()) -- chave no formato "servicoId:unidadeId"

2. **Handlers (useCallback com updater form para evitar stale closures):**
   - `handleToggleCell(cellKey: string)` -- toggle individual: `setSelectedCells(prev => { const next = new Set(prev); if (next.has(key)) next.delete(key); else next.add(key); return next })`
   - `handleSelectRow(servicoId: string)` -- adicionar todas as unidades visíveis para o serviço: `visibleUnits.map(u => servicoId:u.id)` usando `setSelectedCells(prev => ...)`
   - `handleSelectColumn(unidadeId: string)` -- adicionar todos os serviços para a unidade: `servicos.map(s => s.id:unidadeId)` usando `setSelectedCells(prev => ...)`
   - `handleExitSelectionMode()` -- `setIsSelectionMode(false); setSelectedCells(new Set())`

3. **Esc key listener:**
   - `useEffect` que escuta `keydown` `Escape` quando `isSelectionMode === true`. Chama `handleExitSelectionMode`. Cleanup no return.

4. **Botão "Selecionar" na toolbar:**
   - Adicionar entre o filtro de agrupamentos e a legenda de cores.
   - Usar `<Button variant={isSelectionMode ? "default" : "outline"} size="sm" className="h-7 text-xs gap-1.5">` com ícone `CheckSquare` de lucide-react.
   - Label: "Selecionando..." quando ativo, "Selecionar" quando inativo.
   - onClick: toggle `isSelectionMode`. Se desativando, limpar seleção (chamar handleExitSelectionMode).

5. **Props adicionais para MatrizGrid:**
   - Passar: `isSelectionMode`, `selectedCells`, `onToggleCell={handleToggleCell}`, `onSelectRow={handleSelectRow}`, `onSelectColumn={handleSelectColumn}`

NÃO usar Zustand -- estado local em useState conforme decisão do projeto.
NÃO implementar toolbar flutuante ou modal neste task (fica para plan 02).
  </action>
  <verify>
`cd arden && npm run build` compila sem erros. O componente MatrizClient inclui os novos estados e handlers, e o botão "Selecionar" aparece na toolbar.
  </verify>
  <done>
Botão "Selecionar" visível na toolbar. Ao clicar, `isSelectionMode` alterna. Esc sai do modo. Estados `isSelectionMode` e `selectedCells` são passados como props para MatrizGrid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dual-mode click handler + feedback visual + seleção por headers</name>
  <files>
    arden/app/app/obras/[id]/verificacoes/_components/matriz-grid.tsx
    arden/app/app/obras/[id]/verificacoes/_components/matriz-header.tsx
  </files>
  <action>
**Em `matriz-grid.tsx`:**

1. **Expandir a interface `MatrizGridProps`:**
   - Adicionar: `isSelectionMode: boolean`, `selectedCells: Set<string>`, `onToggleCell: (key: string) => void`, `onSelectRow: (servicoId: string) => void`, `onSelectColumn: (unidadeId: string) => void`

2. **Modificar `handleClick` para dual-mode (event delegation):**
   - ANTES de checar `[data-cell]`, checar headers de seleção:
     - `closest('[data-header-servico]')` -- se encontrado E `isSelectionMode`, chamar `onSelectRow(dataset.headerServico)` e return
     - `closest('[data-header-unidade]')` -- se encontrado E `isSelectionMode`, chamar `onSelectColumn(dataset.headerUnidade)` e return
   - Para `[data-cell]`:
     - Se `isSelectionMode`: chamar `onToggleCell(servicoId:unidadeId)` (toggle seleção)
     - Se NÃO `isSelectionMode`: manter navegação atual (router.push)
   - Atualizar deps do useCallback: adicionar `isSelectionMode, onToggleCell, onSelectRow, onSelectColumn`

3. **Data attributes para seleção por header:**
   - No div do nome do serviço (sticky left, z-10): adicionar `data-header-servico={isSelectionMode ? servico.id : undefined}`
   - Adicionar classes condicionais no serviço: `isSelectionMode && "cursor-cell hover:bg-surface-200"`

4. **Feedback visual nas células selecionadas:**
   - Para cada célula de dados, calcular: `const isSelected = isSelectionMode && selectedCells.has(servicoId:unidadeId)`
   - No div da célula (com `data-cell`):
     - Cursor: `isSelectionMode ? "cursor-cell" : "cursor-pointer hover:opacity-80"`
     - No div interno (w-7 h-7 rounded-md): adicionar `isSelected && "ring-2 ring-brand ring-offset-1 ring-offset-surface-100"` usando `cn()`
   - Importar `cn` de `@/lib/utils` (se não importado)

5. **Atributo no container do grid:**
   - Adicionar `data-selection-mode={isSelectionMode || undefined}` no div container principal (com `display: grid`)

**Em `matriz-header.tsx`:**

6. **Modificar `UnitHeaderCell` para suportar seleção de coluna:**
   - Adicionar props: `isSelectionMode?: boolean`
   - Adicionar `data-header-unidade={isSelectionMode ? unidade.id : undefined}` no div
   - Adicionar classes condicionais: `isSelectionMode && "cursor-cell hover:bg-surface-200"`

7. **Atualizar chamada de UnitHeaderCell em `matriz-grid.tsx`:**
   - Passar `isSelectionMode={isSelectionMode}` para cada `UnitHeaderCell`

IMPORTANTE: NÃO modificar comportamento dos headers de agrupamento (Row 1). Eles mantêm expand/collapse em TODOS os modos, conforme Pitfall 4 do RESEARCH.
IMPORTANTE: Usar `cn()` de `@/lib/utils` para merge de classes condicionais.
IMPORTANTE: Manter o componente memo() no MatrizGrid -- as novas props serão comparadas por referência (Set é novo a cada mudança, o que é correto).
  </action>
  <verify>
`cd arden && npm run build` compila sem erros. Verificar que:
1. No modo normal, clicar numa célula navega (comportamento preservado).
2. No modo de seleção, clicar numa célula não navega -- faz toggle visual.
3. Clicar no nome do serviço no modo de seleção seleciona toda a linha.
4. Clicar no header da unidade no modo de seleção seleciona toda a coluna.
5. Células selecionadas mostram ring brand.
6. Cursor muda para cursor-cell no modo de seleção.
  </verify>
  <done>
Modo de seleção funcional: clique individual faz toggle com ring visual, headers selecionam linha/coluna, cursor diferenciado, navegação normal preservada.
  </done>
</task>

</tasks>

<verification>
1. `cd arden && npm run build` -- zero erros de compilação
2. Abrir a página da matriz em `/app/obras/[id]/verificacoes`
3. Modo normal: clicar numa célula navega para verificação individual
4. Clicar "Selecionar" ativa modo de seleção
5. Clicar em células faz toggle com ring brand visível
6. Clicar no nome de um serviço seleciona toda a linha
7. Clicar no header de uma unidade seleciona toda a coluna
8. Pressionar Esc sai do modo e limpa seleção
9. O botão mostra "Selecionando..." quando ativo
</verification>

<success_criteria>
- BULK-01: Click individual faz toggle de seleção -- IMPLEMENTADO
- BULK-02: Shift+Click (=click simples que acumula, per CONTEXT) -- IMPLEMENTADO
- BULK-03: Ctrl+Click (=click simples que acumula, per CONTEXT) -- IMPLEMENTADO
- BULK-04: Header do serviço seleciona linha inteira -- IMPLEMENTADO
- BULK-05: Header da unidade seleciona coluna inteira -- IMPLEMENTADO
- Build compila sem erros
- Navegação normal preservada no modo padrão
</success_criteria>

<output>
Após conclusão, criar `.planning/phases/10-selecao-operacoes-massa/10-01-SUMMARY.md`
</output>
