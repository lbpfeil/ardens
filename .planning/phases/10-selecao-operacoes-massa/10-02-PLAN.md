---
phase: 10-selecao-operacoes-massa
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-selection-toolbar.tsx
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-bulk-modal.tsx
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx
autonomous: true

must_haves:
  truths:
    - "Ao selecionar células, uma toolbar fixa aparece no rodapé da página com contagem e botões"
    - "Botão 'Verificar' na toolbar abre modal com escolha Conforme/NC + descrição"
    - "Botão 'Exceção' na toolbar abre modal em modo exceção"
    - "Modal exibe resumo: quantas serão criadas, quantas ignoradas (Conformes/Exceções), quantas NC receberão reinspeção"
    - "Ao confirmar, a operação bulk é executada via Server Action bulkVerificar"
    - "Sucesso: toast, matriz atualiza, seleção limpa, modo de seleção desativado"
    - "Erro: toast de erro, seleção mantida para retry"
    - "Botão 'Cancelar' na toolbar sai do modo de seleção"
  artifacts:
    - path: "arden/app/app/obras/[id]/verificacoes/_components/matriz-selection-toolbar.tsx"
      provides: "Bottom bar fixa com contagem + botões Verificar/Exceção/Cancelar"
      exports: ["SelectionToolbar"]
    - path: "arden/app/app/obras/[id]/verificacoes/_components/matriz-bulk-modal.tsx"
      provides: "Modal de verificação em massa com seleção de resultado, resumo de conflitos, e confirmação"
      exports: ["BulkModal"]
    - path: "arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx"
      provides: "Integração da toolbar + modal + chamada ao bulkVerificar Server Action"
      contains: "bulkVerificar"
  key_links:
    - from: "matriz-client.tsx"
      to: "matriz-selection-toolbar.tsx"
      via: "props selectedCount, onVerificar, onExcecao, onCancel"
      pattern: "SelectionToolbar"
    - from: "matriz-client.tsx"
      to: "matriz-bulk-modal.tsx"
      via: "props open, summary, mode, onConfirm, isPending"
      pattern: "BulkModal"
    - from: "matriz-client.tsx"
      to: "bulk-verificar.ts"
      via: "import { bulkVerificar } e chamada com startTransition"
      pattern: "bulkVerificar"
    - from: "matriz-bulk-modal.tsx"
      to: "matriz-status.ts"
      via: "import { deriveMatrizCellStatus } para computar resumo de conflitos"
      pattern: "deriveMatrizCellStatus"
---

<objective>
Implementar a toolbar flutuante de ações, o modal de verificação em massa com resumo de conflitos, e a integração com o Server Action `bulkVerificar` existente.

Purpose: Completa o fluxo de operações em massa (BULK-06 a BULK-09): o engenheiro seleciona células, vê o resumo do que acontecerá, confirma, e todas são verificadas atomicamente.
Output: Fluxo completo de seleção + ação bulk funcional, com resolução inteligente de conflitos.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-selecao-operacoes-massa/10-CONTEXT.md
@.planning/phases/10-selecao-operacoes-massa/10-RESEARCH.md
@.planning/phases/10-selecao-operacoes-massa/10-01-SUMMARY.md

Arquivos-fonte:
@arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx
@arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts
@arden/lib/supabase/actions/bulk-verificar.ts
@arden/lib/supabase/queries/verificacoes.ts
@arden/components/ui/dialog.tsx
@arden/components/ui/progress.tsx
@arden/components/ui/button.tsx
@arden/components/ui/textarea.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Toolbar flutuante + Modal de verificação em massa</name>
  <files>
    arden/app/app/obras/[id]/verificacoes/_components/matriz-selection-toolbar.tsx
    arden/app/app/obras/[id]/verificacoes/_components/matriz-bulk-modal.tsx
  </files>
  <action>
**Criar `matriz-selection-toolbar.tsx`:**

Componente da bottom bar fixa no rodapé (estilo Gmail):

```
interface SelectionToolbarProps {
  selectedCount: number
  onVerificar: () => void
  onExcecao: () => void
  onCancel: () => void
}
```

- Container: `fixed bottom-0 left-0 right-0 z-40 border-t border-border bg-surface-100 px-6 py-3`
- Usar `flex items-center justify-between`
- Lado esquerdo: contagem -- `<strong>{selectedCount}</strong> {singular/plural} selecionada(s)`
- Lado direito: 3 botões em `flex items-center gap-2`:
  - "Cancelar" (Button variant="outline" size="sm", onClick=onCancel)
  - "Exceção" (Button variant="outline" size="sm", onClick=onExcecao, ícone AlertTriangle de lucide-react)
  - "Verificar" (Button size="sm" -- variante default/brand, onClick=onVerificar, ícone Check de lucide-react)
- Animação de entrada: `animate-in slide-in-from-bottom duration-200` (tw-animate-css já configurado no projeto)
- Renderizar null se `selectedCount === 0`
- Usar 'use client' no topo

**Criar `matriz-bulk-modal.tsx`:**

Modal com Dialog do shadcn/ui para verificação em massa:

```
interface BulkSummary {
  pendentes: string[]          // Serão criadas normalmente
  ncExistentes: string[]       // NC que receberão reinspeção (se bulk Conforme)
  conformesTravadas: string[]  // Ignoradas (imutáveis)
  excecoesTravadas: string[]   // Ignoradas (imutáveis)
}

interface BulkModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  summary: BulkSummary
  mode: 'verificar' | 'excecao'
  onConfirm: (resultado: 'conforme' | 'nao_conforme' | 'excecao', descricao?: string) => void
  isPending: boolean
}
```

Exportar também a função `computeBulkSummary`:

```
function computeBulkSummary(
  selectedCells: Set<string>,
  verificacoesMap: Record<string, MatrizVerificacao>
): BulkSummary
```

Lógica de `computeBulkSummary`:
- Para cada chave no Set, buscar no `verificacoesMap`
- Se não existe: `pendentes`
- Se existe: usar `deriveMatrizCellStatus()`:
  - 'pendente' -> `pendentes`
  - 'conforme' ou 'conforme_reinspecao' -> `conformesTravadas`
  - 'excecao' -> `excecoesTravadas`
  - 'nao_conforme' ou 'nc_reinspecao' -> `ncExistentes`

Layout do modal:
1. **DialogHeader/DialogTitle:** "Verificação em Massa" (modo verificar) ou "Marcar como Exceção" (modo excecao)
2. **Seleção de resultado** (apenas modo verificar): dois botões lado a lado "Conforme" e "Não Conforme". Estado local `resultado` (useState, default 'conforme'). Usar estilo de seleção: botão ativo com bg-brand ou bg-destructive + texto branco, inativo com variant outline.
3. **Resumo de conflitos** (section com `text-sm space-y-1`):
   - Se `pendentes.length + ncExistentes.length > 0`: "{N} verificações serão criadas como {resultado}"
   - Se `ncExistentes.length > 0` E resultado é 'conforme' E modo é 'verificar': "{N} NC existentes receberão reinspeção"
   - Se `conformesTravadas.length + excecoesTravadas.length > 0`: "{N} células serão ignoradas (já concluídas)" em `text-foreground-muted`
4. **Textarea de descrição** (opcional): placeholder "Descrição opcional...", rows=3
5. **Indicador de loading:** quando `isPending`, mostrar `<Progress className="h-1" />` (componente indeterminado -- sem prop `value` para animação contínua)
6. **DialogFooter:** "Cancelar" (outline, disabled se isPending) + "Confirmar" (default, disabled se isPending ou actionable===0). Label do confirmar muda para "Processando..." quando isPending.

IMPORTANTE: Modo 'excecao' NÃO mostra seleção de resultado. Chama `onConfirm('excecao', descricao)` diretamente.
IMPORTANTE: Usar componentes shadcn existentes: Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter de `@/components/ui/dialog`.
IMPORTANTE: Importar `deriveMatrizCellStatus` de `./matriz-status` e tipos de `@/lib/supabase/queries/verificacoes`.
  </action>
  <verify>
`cd arden && npm run build` compila sem erros. Os dois novos arquivos existem e exportam seus componentes.
  </verify>
  <done>
SelectionToolbar renderiza bottom bar com contagem e 3 botões. BulkModal renderiza modal com seleção de resultado, resumo de conflitos, textarea, e indicador de loading. computeBulkSummary classifica células selecionadas em 4 categorias.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integração no orchestrador -- wiring toolbar + modal + Server Action</name>
  <files>arden/app/app/obras/[id]/verificacoes/_components/matriz-client.tsx</files>
  <action>
Conectar a SelectionToolbar e o BulkModal ao estado de seleção do MatrizClient (já implementado em 10-01):

1. **Imports:**
   - `import { SelectionToolbar } from './matriz-selection-toolbar'`
   - `import { BulkModal, computeBulkSummary } from './matriz-bulk-modal'`
   - `import { bulkVerificar } from '@/lib/supabase/actions/bulk-verificar'`
   - `import { useTransition } from 'react'` (adicionar ao import existente)
   - `import { toast } from 'sonner'`

2. **Novos estados no MatrizClient:**
   - `const [bulkModalOpen, setBulkModalOpen] = useState(false)`
   - `const [bulkMode, setBulkMode] = useState<'verificar' | 'excecao'>('verificar')`
   - `const [isPending, startTransition] = useTransition()`

3. **Resumo computado (useMemo):**
   - `const bulkSummary = useMemo(() => computeBulkSummary(selectedCells, verificacoesMap), [selectedCells, verificacoesMap])`

4. **Handlers para toolbar:**
   - `handleOpenVerificar`: `setBulkMode('verificar'); setBulkModalOpen(true)`
   - `handleOpenExcecao`: `setBulkMode('excecao'); setBulkModalOpen(true)`

5. **Handler de confirmação (handleBulkConfirm):**
   ```
   (resultado: 'conforme' | 'nao_conforme' | 'excecao', descricao?: string) => {
     const pares = Array.from(selectedCells).map(key => {
       const [servico_id, unidade_id] = key.split(':')
       return { servico_id, unidade_id }
     })

     startTransition(async () => {
       const result = await bulkVerificar({
         obra_id: obraId,
         resultado,
         pares,
         descricao,
       })

       if (result.error) {
         toast.error(result.error)
         // Seleção mantida para retry (per CONTEXT)
       } else {
         const { created, skipped, reinspected } = result.data
         const parts: string[] = []
         if (created > 0) parts.push(`${created} verificações criadas`)
         if (reinspected > 0) parts.push(`${reinspected} reinspecionadas`)
         if (skipped > 0) parts.push(`${skipped} ignoradas`)
         toast.success(parts.join(', '))
         setBulkModalOpen(false)
         handleExitSelectionMode()
         // revalidatePath é chamado dentro do bulkVerificar
       }
     })
   }
   ```

6. **Renderização:**
   - Após o `</MatrizGrid>` e antes do `</>` final, adicionar:
     ```
     {isSelectionMode && (
       <SelectionToolbar
         selectedCount={selectedCells.size}
         onVerificar={handleOpenVerificar}
         onExcecao={handleOpenExcecao}
         onCancel={handleExitSelectionMode}
       />
     )}

     <BulkModal
       open={bulkModalOpen}
       onOpenChange={setBulkModalOpen}
       summary={bulkSummary}
       mode={bulkMode}
       onConfirm={handleBulkConfirm}
       isPending={isPending}
     />
     ```

IMPORTANTE: Usar `useTransition` (não `useState` para isPending) -- consistente com padrão existente em verificacao-individual-client.tsx.
IMPORTANTE: Após sucesso, chamar `handleExitSelectionMode()` que limpa seleção e sai do modo (per CONTEXT: "automaticamente após operação bulk confirmada").
IMPORTANTE: NÃO chamar `router.refresh()` -- o `revalidatePath` dentro do `bulkVerificar` Server Action já cuida da revalidação.
IMPORTANTE: Se `result.data` retornar contagens, montar toast com as partes relevantes (não mostrar "0 ignoradas").
  </action>
  <verify>
`cd arden && npm run build` compila sem erros. Fluxo completo:
1. Ativar modo de seleção
2. Clicar em células para selecionar
3. Toolbar aparece com contagem correta
4. Clicar "Verificar" abre modal com resumo
5. Selecionar Conforme/NC + descrição
6. Confirmar executa bulk via Server Action
7. Toast de sucesso com contagens
8. Modal fecha, seleção limpa, modo desativado
  </verify>
  <done>
Fluxo completo de operações em massa funcional: seleção -> toolbar -> modal com resumo de conflitos -> confirmação -> bulk Server Action -> feedback toast -> limpeza de estado.
  </done>
</task>

</tasks>

<verification>
1. `cd arden && npm run build` -- zero erros de compilação
2. Abrir a página da matriz em `/app/obras/[id]/verificacoes`
3. Clicar "Selecionar" para ativar modo
4. Selecionar algumas células -- toolbar aparece com contagem
5. Clicar "Verificar" -- modal abre com resumo correto
6. Escolher Conforme + descrição opcional -> "Confirmar"
7. Toast mostra contagens reais (created, skipped, reinspected)
8. Matriz atualiza com novas cores do heatmap
9. Seleção limpa e modo desativado após sucesso
10. Testar "Exceção" -- modal em modo exceção sem seleção de resultado
11. Testar com células já Conformes na seleção -- resumo mostra que serão ignoradas
12. Testar erro -- seleção mantida para retry
</verification>

<success_criteria>
- BULK-06: Toolbar flutuante com contagem + botão "Verificar" -- IMPLEMENTADO
- BULK-07: Modal com resultado (C/NC/Exceção) + descrição -- IMPLEMENTADO
- BULK-08: Resolução de conflitos: Conformes ignorados, NCs viram reinspeção -- IMPLEMENTADO (via RPC + resumo visual)
- BULK-09: Marcação automática de todos os itens conforme resultado -- IMPLEMENTADO (via RPC bulk_verificar)
- Build compila sem erros
- Toast com feedback de contagens
- Seleção limpa após sucesso, mantida após erro
</success_criteria>

<output>
Após conclusão, criar `.planning/phases/10-selecao-operacoes-massa/10-02-SUMMARY.md`
</output>
