---
phase: 09-matriz-verificacoes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database/schema.sql
  - arden/lib/supabase/queries/verificacoes.ts
  - arden/components/ui/tooltip.tsx
  - arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts
autonomous: true

must_haves:
  truths:
    - "Migration applied via mcp__supabase__apply_migration adds tem_reinspecao boolean to verificacoes"
    - "Trigger atualizar_contadores_verificacao recalculates tem_reinspecao from itens_verificacao"
    - "getMatrizData returns tem_reinspecao in each MatrizVerificacao object"
    - "Status utility correctly maps 6 visual states from verificacao data"
    - "shadcn tooltip component installed and available at components/ui/tooltip.tsx"
    - "database/schema.sql updated to reflect tem_reinspecao column"
  artifacts:
    - path: "arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts"
      provides: "MatrizCellStatus type, STATUS_COLORS, STATUS_LABELS, deriveMatrizCellStatus function"
      exports: ["MatrizCellStatus", "STATUS_COLORS", "STATUS_LABELS", "deriveMatrizCellStatus"]
    - path: "arden/components/ui/tooltip.tsx"
      provides: "shadcn Tooltip component wrapping Radix UI primitive"
    - path: "arden/lib/supabase/queries/verificacoes.ts"
      provides: "Extended MatrizVerificacao with tem_reinspecao boolean"
  key_links:
    - from: "atualizar_contadores_verificacao trigger"
      to: "verificacoes.tem_reinspecao"
      via: "Subquery checking itens_verificacao.status_reinspecao IS NOT NULL"
    - from: "getMatrizData query"
      to: "verificacoes.tem_reinspecao"
      via: "Added to SELECT fields"
    - from: "deriveMatrizCellStatus"
      to: "MatrizVerificacao.tem_reinspecao"
      via: "Uses tem_reinspecao to distinguish conforme vs conforme_reinspecao"
---

<objective>
Preparar a camada de dados e utilitários necessários para a Matriz de Verificações.

Purpose: A matriz precisa de 6 estados visuais distintos (pendente, conforme, NC, exceção, conforme após reinspeção, NC após reinspeção). O banco atual não fornece a informação de reinspeção na query da matriz. Este plano adiciona essa informação via migration + trigger, estende a query existente, instala o componente tooltip, e cria o utilitário de mapeamento status-para-cor.

Output: Campo `tem_reinspecao` no banco, query `getMatrizData()` estendida, componente tooltip instalado, utilitário de status com 6 cores do heatmap.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CONVENTIONS.md

Source files:
@arden/lib/supabase/queries/verificacoes.ts
@database/schema.sql
@arden/app/globals.css (CSS variables for status colors)
@arden/components/ui/progress.tsx (reference for shadcn component pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Adicionar campo tem_reinspecao ao banco e atualizar trigger</name>
  <files>database/schema.sql</files>
  <action>
1. Use `mcp__supabase__apply_migration` para adicionar coluna `tem_reinspecao` à tabela `verificacoes`:
   - name: "add_tem_reinspecao_to_verificacoes"
   - query:
     ```sql
     ALTER TABLE verificacoes ADD COLUMN tem_reinspecao BOOLEAN DEFAULT FALSE;
     ```

2. Use `mcp__supabase__apply_migration` para atualizar a função trigger `atualizar_contadores_verificacao`:
   - name: "update_trigger_add_tem_reinspecao"
   - query: Substituir a função para incluir o cálculo de `tem_reinspecao`:
     ```sql
     CREATE OR REPLACE FUNCTION atualizar_contadores_verificacao()
     RETURNS TRIGGER AS $$
     BEGIN
       UPDATE verificacoes v SET
         total_itens = (SELECT COUNT(*) FROM itens_verificacao WHERE verificacao_id = v.id),
         itens_verificados = (SELECT COUNT(*) FROM itens_verificacao WHERE verificacao_id = v.id AND status != 'nao_verificado'),
         itens_conformes = (SELECT COUNT(*) FROM itens_verificacao WHERE verificacao_id = v.id AND status = 'conforme'),
         itens_nc = (SELECT COUNT(*) FROM itens_verificacao WHERE verificacao_id = v.id AND status = 'nao_conforme' AND status_reinspecao IS NULL),
         itens_excecao = (SELECT COUNT(*) FROM itens_verificacao WHERE verificacao_id = v.id AND status = 'excecao'),
         tem_reinspecao = EXISTS(SELECT 1 FROM itens_verificacao WHERE verificacao_id = v.id AND status_reinspecao IS NOT NULL),
         status = CASE
           WHEN (SELECT COUNT(*) FROM itens_verificacao WHERE verificacao_id = v.id AND status = 'nao_verificado') =
                (SELECT COUNT(*) FROM itens_verificacao WHERE verificacao_id = v.id) THEN 'pendente'
           WHEN (SELECT COUNT(*) FROM itens_verificacao WHERE verificacao_id = v.id AND status = 'nao_conforme' AND status_reinspecao IS NULL) > 0 THEN 'com_nc'
           WHEN (SELECT COUNT(*) FROM itens_verificacao WHERE verificacao_id = v.id AND status = 'nao_verificado') > 0 THEN 'em_andamento'
           ELSE 'concluida'
         END
       WHERE v.id = COALESCE(NEW.verificacao_id, OLD.verificacao_id);
       RETURN COALESCE(NEW, OLD);
     END;
     $$ LANGUAGE plpgsql;
     ```

3. Backfill existing records (use `mcp__supabase__execute_sql`):
   ```sql
   UPDATE verificacoes v SET tem_reinspecao = EXISTS(
     SELECT 1 FROM itens_verificacao iv
     WHERE iv.verificacao_id = v.id AND iv.status_reinspecao IS NOT NULL
   );
   ```

4. Atualizar `database/schema.sql` para refletir a nova coluna:
   - Na tabela `verificacoes` (linha ~540), adicionar `tem_reinspecao BOOLEAN DEFAULT FALSE` após `itens_excecao`
   - Na função `atualizar_contadores_verificacao` (linha ~1007), adicionar a linha `tem_reinspecao = EXISTS(...)`

5. Verificar aplicação com `mcp__supabase__execute_sql`:
   ```sql
   SELECT column_name, data_type, column_default
   FROM information_schema.columns
   WHERE table_name = 'verificacoes' AND column_name = 'tem_reinspecao';
   ```
  </action>
  <verify>
  - Migration aplicada sem erros
  - `SELECT tem_reinspecao FROM verificacoes LIMIT 1` retorna resultado (coluna existe)
  - `database/schema.sql` contém `tem_reinspecao BOOLEAN DEFAULT FALSE` na definição de verificacoes
  - `database/schema.sql` contém `tem_reinspecao = EXISTS` na função trigger
  </verify>
  <done>Campo tem_reinspecao existe na tabela verificacoes, trigger recalcula automaticamente quando itens são atualizados, schema.sql documentado.</done>
</task>

<task type="auto">
  <name>Task 2: Estender query getMatrizData, instalar tooltip, criar utilitário de status</name>
  <files>
    arden/lib/supabase/queries/verificacoes.ts
    arden/components/ui/tooltip.tsx
    arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts
  </files>
  <action>
1. **Estender MatrizVerificacao interface** em `arden/lib/supabase/queries/verificacoes.ts`:
   - Adicionar campo `tem_reinspecao: boolean` à interface `MatrizVerificacao`
   - Na query de verificações dentro de `getMatrizData()`, adicionar `tem_reinspecao` ao string SELECT:
     ```
     'id, unidade_id, servico_id, status, total_itens, itens_verificados, itens_conformes, itens_nc, itens_excecao, tem_reinspecao'
     ```

2. **Instalar componente tooltip shadcn/ui** via CLI:
   ```bash
   cd arden && npx shadcn@latest add tooltip
   ```
   Isso cria `arden/components/ui/tooltip.tsx` usando o `@radix-ui/react-tooltip` já instalado via `radix-ui@1.4.3`.

3. **Criar utilitário de status da matriz** em `arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts`:
   ```typescript
   // Tipos e utilitários para status visual das células da matriz heatmap

   export type MatrizCellStatus =
     | 'pendente'
     | 'conforme'
     | 'nao_conforme'
     | 'excecao'
     | 'conforme_reinspecao'
     | 'nc_reinspecao'

   // Cores de fundo para cada status (CSS variables do design system)
   export const STATUS_COLORS: Record<MatrizCellStatus, string> = {
     pendente: 'bg-surface-200',
     conforme: 'bg-brand',
     nao_conforme: 'bg-destructive',
     excecao: 'bg-warning',
     conforme_reinspecao: 'bg-brand-600',
     nc_reinspecao: 'bg-destructive-600',
   }

   // Labels em português para tooltip
   export const STATUS_LABELS: Record<MatrizCellStatus, string> = {
     pendente: 'Pendente',
     conforme: 'Conforme',
     nao_conforme: 'Não Conforme',
     excecao: 'Exceção',
     conforme_reinspecao: 'Conforme após Reinspeção',
     nc_reinspecao: 'NC após Reinspeção',
   }

   // Importar MatrizVerificacao do queries
   import type { MatrizVerificacao } from '@/lib/supabase/queries/verificacoes'

   /**
    * Deriva o status visual da célula a partir dos dados da verificação.
    * Combina status_verificacao + contadores + tem_reinspecao para
    * produzir um dos 6 estados visuais do heatmap.
    */
   export function deriveMatrizCellStatus(
     verificacao: MatrizVerificacao | undefined
   ): MatrizCellStatus {
     if (!verificacao) return 'pendente'

     const { status, itens_conformes, itens_nc, itens_excecao, total_itens, tem_reinspecao } = verificacao

     if (status === 'pendente') return 'pendente'

     if (status === 'concluida') {
       if (itens_excecao === total_itens) return 'excecao'
       if (tem_reinspecao) return 'conforme_reinspecao'
       return 'conforme'
     }

     if (status === 'com_nc') {
       if (tem_reinspecao) return 'nc_reinspecao'
       return 'nao_conforme'
     }

     // em_andamento: tratar como pendente visualmente
     return 'pendente'
   }
   ```

   Garantir que o import de `MatrizVerificacao` é type-only (`import type`).
  </action>
  <verify>
  - `npm run build` no diretório arden compila sem erros de TypeScript
  - `arden/components/ui/tooltip.tsx` existe e exporta Tooltip, TooltipContent, TooltipTrigger, TooltipProvider
  - `arden/app/app/obras/[id]/verificacoes/_components/matriz-status.ts` existe e exporta MatrizCellStatus, STATUS_COLORS, STATUS_LABELS, deriveMatrizCellStatus
  - Interface MatrizVerificacao inclui campo tem_reinspecao: boolean
  - getMatrizData query inclui tem_reinspecao no SELECT
  </verify>
  <done>Query da matriz retorna tem_reinspecao, tooltip shadcn instalado, utilitário de status com 6 cores e função de derivação prontos para uso.</done>
</task>

</tasks>

<verification>
1. Campo tem_reinspecao existe no banco (verificar via SQL)
2. Trigger recalcula tem_reinspecao (testar com execute_sql)
3. `npm run build` compila sem erros
4. MatrizVerificacao.tem_reinspecao está tipado como boolean
5. deriveMatrizCellStatus retorna os 6 estados corretos
6. Tooltip component disponível em components/ui/
</verification>

<success_criteria>
- Migration aplicada e campo existe no banco
- Trigger atualizado recalcula tem_reinspecao automaticamente
- getMatrizData retorna dados com tem_reinspecao
- 6 status visuais mapeados com cores do design system
- Tooltip shadcn disponível para uso
- Build compila sem erros
</success_criteria>

<output>
After completion, create `.planning/phases/09-matriz-verificacoes/09-01-SUMMARY.md`
</output>
