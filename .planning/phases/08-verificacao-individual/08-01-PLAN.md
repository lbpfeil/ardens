---
phase: 08-verificacao-individual
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/page.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-checklist.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-nc-modal.tsx
  - database/schema.sql
autonomous: true

must_haves:
  truths:
    - "Page wrapper uses bg-background min-h-full pattern"
    - "Header (h1 + description) is in Server Component, not Client"
    - "Engineer sees page at /app/obras/[id]/verificacoes/[verificacaoId] with service name, unit name, obra name in header"
    - "Engineer sees list of all verification items with C/NC/NA toggle per item"
    - "Clicking C or NA on a toggle calls marcarItemVerificacao Server Action and updates UI optimistically"
    - "Clicking NC opens modal requiring observation before Server Action is called"
    - "Dismissing NC modal without submitting rolls back toggle to previous state"
    - "ToggleGroup prevents deselection (empty value guard)"
    - "Verificação result auto-computes: any NC item -> verification NC; all C/NA -> Conforme"
  artifacts:
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/page.tsx"
      provides: "Server Component page with data fetch"
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx"
      provides: "Client orchestrator with optimistic updates"
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx"
      provides: "Header showing service + unit + obra identification"
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-checklist.tsx"
      provides: "Item list with ToggleGroup C/NC/NA controls"
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-nc-modal.tsx"
      provides: "Modal for NC observation (required)"
  key_links:
    - from: "page.tsx"
      to: "getVerificacaoComItens"
      via: "server-side fetch with supabase"
    - from: "verificacao-individual-client.tsx"
      to: "marcarItemVerificacao"
      via: "Server Action import"
    - from: "item-checklist.tsx"
      to: "item-nc-modal.tsx"
      via: "NC toggle opens modal, confirm callback calls parent handler"
---

<objective>
Create the core verification page where an engineer evaluates each inspection item of a service/unit pair with C/NC/NA toggles. This is the foundational UI for individual verification.

Purpose: VERIF-01 (dedicated page), VERIF-02 (toggle list), VERIF-03 (auto result calculation). This plan creates the end-to-end flow from page load to item marking with optimistic updates.
Output: Working page at `/app/obras/[id]/verificacoes/[verificacaoId]` with item checklist and NC modal.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CONVENTIONS.md

# Phase 7 artifacts (data layer this plan consumes)
@arden/lib/supabase/queries/verificacoes.ts
@arden/lib/supabase/actions/itens-verificacao.ts
@arden/lib/validations/verificacao.ts

# Existing patterns to follow
@arden/app/app/biblioteca/page.tsx
@arden/components/ui/dialog.tsx

# Design system
@docs/design/DESIGN-SYSTEM.md

# Database schema for verificacoes/itens_verificacao
@database/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add descricao column to verificacoes + Create page route and header</name>
  <files>
    database/schema.sql
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/page.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx
  </files>
  <action>
**Step 1: Database migration**

The `verificacoes` table is missing a `descricao` column needed for VERIF-04 (campo de descrição geral). Apply migration via `mcp__supabase__apply_migration`:

```
name: "add_descricao_to_verificacoes"
query: "ALTER TABLE verificacoes ADD COLUMN descricao TEXT;"
```

Then update `database/schema.sql` to add `descricao TEXT,` after the `status` line (line ~531) in the verificacoes table definition, with a comment `-- Descrição geral da verificação`.

Also update the `getVerificacaoComItens` query in `arden/lib/supabase/queries/verificacoes.ts` to include `descricao` in the select fields, AND add `descricao` to the `VerificacaoComItens` interface.

**Step 2: Server Component page**

Create `arden/app/app/obras/[id]/verificacoes/[verificacaoId]/page.tsx`:

- Import `createClient` from `@/lib/supabase/server`
- Import `getVerificacaoComItens` from `@/lib/supabase/queries/verificacoes`
- Import `VerificacaoIndividualClient` from `./_components/verificacao-individual-client`
- Extract `id` (obra_id) and `verificacaoId` from `params` (await params first — Next.js 15+ requires `const { id, verificacaoId } = await params`)
- Call `getVerificacaoComItens(supabase, verificacaoId)` for the main data
- ALSO fetch service name, unit name, and obra name with a separate query:
  ```typescript
  const { data: context } = await supabase
    .from('verificacoes')
    .select('servicos(nome, codigo), unidades(nome), obras(nome)')
    .eq('id', verificacaoId)
    .single()
  ```
- If verificacao is null, show a "Verificação não encontrada" message (simple div with text-foreground-light)
- Return the page wrapper following the CONVENTIONS.md pattern:
  ```tsx
  <div className="p-6 bg-background min-h-full">
    <div className="max-w-4xl mx-auto">
      <VerificacaoHeader
        servicoNome={context?.servicos?.nome}
        servicoCodigo={context?.servicos?.codigo}
        unidadeNome={context?.unidades?.nome}
        obraNome={context?.obras?.nome}
      />
      <VerificacaoIndividualClient
        verificacao={verificacao}
      />
    </div>
  </div>
  ```
- Use `max-w-4xl` (not 6xl) for a focused single-page form layout

**Step 3: Header component**

Create `arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx`:

- NOT a 'use client' component — pure presentational, can be server rendered
- Props: `servicoNome`, `servicoCodigo`, `unidadeNome`, `obraNome` (all `string | undefined`)
- Display:
  - Breadcrumb-like text: `{obraNome} / {unidadeNome}` in `text-sm text-foreground-muted`
  - Main title: `{servicoCodigo} — {servicoNome}` in `text-xl font-normal text-foreground`
  - Bottom border: `border-b border-border pb-4 mb-6`
- If servicoCodigo is null/undefined, just show servicoNome
  </action>
  <verify>
- `database/schema.sql` contains `descricao TEXT` in verificacoes table
- `arden/lib/supabase/queries/verificacoes.ts` includes `descricao` in select and VerificacaoComItens interface
- `page.tsx` exists and imports createClient, getVerificacaoComItens
- `page.tsx` uses `await params` pattern (Next.js 15+)
- `page.tsx` has `bg-background min-h-full` wrapper
- `verificacao-header.tsx` exists and renders service/unit/obra names
- `npx tsc --noEmit` passes for new files
  </verify>
  <done>
Server Component page loads verification data and renders header with service name, unit name, and obra name. Database has descricao column.
  </done>
</task>

<task type="auto">
  <name>Task 2: Item checklist with C/NC/NA toggles + NC modal + Client orchestrator</name>
  <files>
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-checklist.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-nc-modal.tsx
  </files>
  <action>
**Step 1: NC Modal component**

Create `item-nc-modal.tsx`:

- `'use client'` directive
- Import: `Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter` from `@/components/ui/dialog`
- Import: `Button` from `@/components/ui/button`, `Textarea` from `@/components/ui/textarea`, `Label` from `@/components/ui/label`
- Import: `useForm` from `react-hook-form`, `zodResolver` from `@hookform/resolvers/zod`
- Import: `z` from `zod`
- Zod schema: `ncObservacaoSchema = z.object({ observacao: z.string().min(1, 'Observação é obrigatória para itens NC') })`
- Props interface `ItemNCModalProps`:
  - `open: boolean`
  - `onOpenChange: (open: boolean) => void`
  - `itemNome: string` (the item's observacao name, shown as context)
  - `onConfirm: (observacao: string) => void`
  - `onCancel: () => void` (called when modal is dismissed without submitting)
- On form submit: call `onConfirm(data.observacao)`, reset form, close modal
- On `onOpenChange(false)` (dismiss): call `onCancel()` to rollback toggle
- Dialog title: "Não Conformidade"
- Subtitle: show `itemNome` in `text-sm text-foreground-light`
- Textarea placeholder: "Descreva o problema encontrado..."
- Submit button: `variant="destructive"`, text "Marcar NC"
- Cancel button: `variant="outline"`, text "Cancelar"
- Reset form with `useEffect` when `open` changes to false

**Step 2: Item Checklist component**

Create `item-checklist.tsx`:

- `'use client'` directive
- Import: `ToggleGroup` from `radix-ui` (the project uses `import { ToggleGroup } from "radix-ui"` or `import * as ToggleGroup from "@radix-ui/react-toggle-group"` — check which Radix version is installed by looking at package.json)

**IMPORTANT RADIX IMPORT:** The project's dialog.tsx uses `import { Dialog as DialogPrimitive } from "radix-ui"`. Follow the same pattern: `import { ToggleGroup } from "radix-ui"`. Then use `ToggleGroup.Root` and `ToggleGroup.Item`.

- Import: `Check, X, Minus` from `lucide-react` (Check for C, X for NC, Minus for NA)
- Import: `ItemNCModal` from `./item-nc-modal`
- Import: `type ItemVerificacao` from `@/lib/supabase/queries/verificacoes`

- Props interface `ItemChecklistProps`:
  - `itens: ItemVerificacao[]`
  - `onItemMark: (itemId: string, status: 'conforme' | 'nao_conforme' | 'excecao', observacao?: string) => void`
  - `disabled?: boolean` (for locked verificação)
  - `onItemClick?: (item: ItemVerificacao) => void` (for detail modal, to be added in Plan 02)

- State: `pendingNC: { itemId: string; itemNome: string; previousStatus: string } | null`

- For each item, render a row:
  - Left: item number (index + 1) in `text-xs text-foreground-muted w-6`
  - Middle: item name (`item.item_servico.observacao`) — clickable area, calls `onItemClick?.(item)`. Style: `text-sm text-foreground cursor-pointer hover:text-brand-link`
  - Right: ToggleGroup with 3 items
    - `type="single"`, `value={item.status === 'nao_verificado' ? '' : item.status}`
    - `disabled={disabled}`
    - `onValueChange`:
      - Guard: `if (!value) return` (prevent deselection)
      - If `value === 'nao_conforme'`: set `pendingNC` state with item info, do NOT call onItemMark yet
      - Else: call `onItemMark(item.id, value, undefined)` directly
    - ToggleGroup.Item for each status with styling:
      - Conforme: `data-[state=on]:bg-brand data-[state=on]:text-white` (green)
      - NC: `data-[state=on]:bg-destructive data-[state=on]:text-white` (red)
      - NA: `data-[state=on]:bg-warning data-[state=on]:text-foreground` (yellow/amber)
    - All items: `px-2.5 py-1.5 text-xs rounded-none first:rounded-l-md last:rounded-r-md border border-border transition-colors`
    - Container: `inline-flex`

- Row container: `flex items-center gap-3 p-3 rounded-md border border-border hover:bg-surface-100 transition-colors`
  - Add status indicator: if item.status is conforme/nao_conforme/excecao, show subtle left border color:
    - conforme: `border-l-2 border-l-brand`
    - nao_conforme: `border-l-2 border-l-destructive`
    - excecao: `border-l-2 border-l-warning`

- NC Modal: render `ItemNCModal` at the bottom, controlled by `pendingNC` state:
  - `open={pendingNC !== null}`
  - `onConfirm={(obs) => { onItemMark(pendingNC.itemId, 'nao_conforme', obs); setPendingNC(null) }}`
  - `onCancel={() => setPendingNC(null)}` (rollback: do nothing, toggle stays at previous value)
  - `itemNome={pendingNC?.itemNome}`

**Step 3: Client Orchestrator component**

Create `verificacao-individual-client.tsx`:

- `'use client'` directive
- Import: `useState, useTransition` from `react`
- Import: `marcarItemVerificacao` from `@/lib/supabase/actions/itens-verificacao`
- Import: `toast` from `sonner`
- Import: `ItemChecklist` from `./item-checklist`
- Import: `type VerificacaoComItens, type ItemVerificacao` from `@/lib/supabase/queries/verificacoes`

- Props: `{ verificacao: VerificacaoComItens }`

- State:
  - `itens: ItemVerificacao[]` initialized from `verificacao.itens`
  - `isPending` from `useTransition`

- Compute locked state:
  ```typescript
  const isLocked = verificacao.status === 'concluida'
    && verificacao.total_itens > 0
    && verificacao.itens_conformes === verificacao.total_itens
  ```

- `handleItemMark` function:
  1. Optimistic update: `setItens(prev => prev.map(item => item.id === itemId ? { ...item, status, observacao: observacao || item.observacao, data_inspecao: new Date().toISOString() } : item))`
  2. `startTransition(async () => { ... })`:
     - Call `marcarItemVerificacao({ item_verificacao_id: itemId, status, observacao })`
     - If `result.error`: `toast.error(result.error)`, rollback: `setItens(verificacao.itens)`
     - If success: `toast.success('Item atualizado')` (no need to manually revalidate — Server Action calls revalidatePath)

- Render:
  ```tsx
  <div className="space-y-6">
    {/* Item checklist */}
    <div>
      <h2 className="text-sm font-medium text-foreground-light mb-3">
        Itens de verificação ({itens.length})
      </h2>
      <ItemChecklist
        itens={itens}
        onItemMark={handleItemMark}
        disabled={isLocked}
      />
    </div>
  </div>
  ```
  </action>
  <verify>
- `item-nc-modal.tsx` exists with Dialog, form validation, onConfirm/onCancel callbacks
- `item-checklist.tsx` exists with ToggleGroup, NC interception, empty value guard
- `verificacao-individual-client.tsx` exists with optimistic updates, useTransition, marcarItemVerificacao
- ToggleGroup `onValueChange` has `if (!value) return` guard
- NC modal dismissal calls `onCancel` (rollback)
- `npx tsc --noEmit` passes for all new files
  </verify>
  <done>
Engineer can open verification page, see all items with C/NC/NA toggles, mark items with optimistic updates, and NC requires observation via modal before saving.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/app/obras/{obraId}/verificacoes/{verificacaoId}` — page loads without errors
2. Header shows service name, unit name, obra name
3. All verification items appear as a checklist with C/NC/NA toggles
4. Clicking C calls Server Action and shows toast
5. Clicking NC opens modal requiring observation
6. Dismissing NC modal does NOT change item status
7. Submitting NC modal with observation calls Server Action
8. Clicking NA calls Server Action directly
9. Toggle cannot be deselected (clicking active toggle again does nothing)
10. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- Page renders at correct route with data from Phase 7 query
- All 3 toggle states work: C (direct), NC (modal), NA (direct)
- Optimistic updates provide instant feedback
- Server Actions persist data correctly
- NC observation is required (validated by Zod)
</success_criteria>

<output>
After completion, create `.planning/phases/08-verificacao-individual/08-01-SUMMARY.md`
</output>
