---
phase: 08-verificacao-individual
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-detail-modal.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/excecao-modal.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/reinspecao-modal.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx
  - arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-checklist.tsx
autonomous: false

must_haves:
  truths:
    - "Clicking item row (outside toggle) opens detail modal showing Observação, Método, Tolerância"
    - "Engineer can write a general description (textarea) for the verification"
    - "Engineer can mark verification as Exceção via button in header, which requires justification modal"
    - "NC items show a Reinspecionar button that opens reinspeção modal"
    - "Reinspeção modal offers 4 outcomes: Conforme após reinspeção, Retrabalho, Aprovado com concessão, Reprovado após retrabalho"
    - "Locked verification (Conforme concluída) shows disabled toggles and info banner"
    - "Completed verification shows result banner (green Conforme / red NC)"
  artifacts:
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-detail-modal.tsx"
      provides: "Read-only modal showing item template fields"
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/excecao-modal.tsx"
      provides: "Justification modal for marking verification as Exceção"
    - path: "arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/reinspecao-modal.tsx"
      provides: "Modal for reinspeção of NC items"
  key_links:
    - from: "verificacao-individual-client.tsx"
      to: "atualizarResultadoVerificacao"
      via: "Server Action for Exceção"
    - from: "verificacao-individual-client.tsx"
      to: "marcarItemReinspecao"
      via: "Server Action for reinspeção"
    - from: "item-checklist.tsx"
      to: "item-detail-modal.tsx"
      via: "onItemClick callback opens modal"
---

<objective>
Add all secondary features to the verification page: item detail modal, general description field, Exceção flow, reinspeção cycle, locked state, and completion banners. This completes the individual verification experience.

Purpose: VERIF-04 (descrição geral), VERIF-05 (Exceção), VERIF-06 (reinspeção). Also adds locked state UI and completion banners for a polished user experience.
Output: Fully functional individual verification page with all 6 VERIF requirements satisfied.
</objective>

<execution_context>
@C:\Users\lbp80\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lbp80\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CONVENTIONS.md

# Phase 7 artifacts
@arden/lib/supabase/actions/verificacoes.ts
@arden/lib/supabase/actions/itens-verificacao.ts
@arden/lib/validations/verificacao.ts
@arden/lib/supabase/queries/verificacoes.ts

# Plan 01 output (read SUMMARY for what was built)
@.planning/phases/08-verificacao-individual/08-01-SUMMARY.md

# Existing patterns
@arden/components/ui/dialog.tsx
@arden/components/ui/alert-dialog.tsx
@docs/design/DESIGN-SYSTEM.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Item detail modal + Descrição geral + Exceção flow</name>
  <files>
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-detail-modal.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/excecao-modal.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-header.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-checklist.tsx
  </files>
  <action>
**Step 1: Item Detail Modal**

Create `item-detail-modal.tsx`:

- `'use client'` directive
- Import: `Dialog, DialogContent, DialogHeader, DialogTitle` from `@/components/ui/dialog`
- Import: `type ItemVerificacao` from `@/lib/supabase/queries/verificacoes`
- Props: `{ open: boolean; onOpenChange: (open: boolean) => void; item: ItemVerificacao | null }`
- If item is null, render nothing inside DialogContent
- Display 3 sections with headers in `text-xs font-medium text-foreground-muted uppercase tracking-wider mb-1.5`:
  1. "O que verificar" — `item.item_servico.observacao` (always present)
  2. "Como verificar" — `item.item_servico.metodo` (conditionally, only if non-null)
  3. "Critério de aceitação" — `item.item_servico.tolerancia` (conditionally, only if non-null)
- Each section value in `text-sm text-foreground`
- DialogContent: `className="sm:max-w-lg"`

**Step 2: Wire item detail modal into checklist**

Update `item-checklist.tsx` (from Plan 01):
- Add state: `selectedItem: ItemVerificacao | null`
- When user clicks item row (the text area, outside toggle): `setSelectedItem(item)`
- Render `ItemDetailModal` at bottom: `open={selectedItem !== null}`, `onOpenChange={(open) => !open && setSelectedItem(null)}`, `item={selectedItem}`

**Step 3: Exceção Modal**

Create `excecao-modal.tsx`:

- `'use client'` directive
- Import: `AlertDialog` components from `@/components/ui/alert-dialog` (use AlertDialog because it's a destructive action with confirmation)
- Import: `useForm` from `react-hook-form`, `zodResolver`, `z` from `zod`
- Import: `Textarea` from `@/components/ui/textarea`, `Label` from `@/components/ui/label`
- Zod schema: `excecaoSchema = z.object({ justificativa: z.string().min(1, 'Justificativa é obrigatória') })`
- Props: `{ open: boolean; onOpenChange: (open: boolean) => void; onConfirm: (justificativa: string) => void; isSubmitting?: boolean }`
- AlertDialog title: "Marcar como Exceção"
- AlertDialog description: "Este serviço não se aplica a esta unidade. Informe a justificativa abaixo."
- Form with Textarea for justificativa (placeholder: "Descreva por que este serviço não se aplica...")
- Action button: `variant="default"` (not destructive — exceção is not a danger, just a reclassification), text "Confirmar Exceção"
- Cancel button: "Cancelar"
- Reset form when modal closes

**Step 4: Descrição geral textarea**

Update `verificacao-individual-client.tsx` (from Plan 01):

- Add state: `descricao: string` initialized from `verificacao.descricao || ''`
- Add state: `descricaoSaved: boolean` to track if changes are saved
- Import: `Textarea` from `@/components/ui/textarea`, `Label` from `@/components/ui/label`, `Button` from `@/components/ui/button`
- Import: `atualizarResultadoVerificacao` from `@/lib/supabase/actions/verificacoes`
- Render textarea at the TOP of the page content (before item checklist):
  ```tsx
  <div className="mb-6">
    <Label htmlFor="descricao" className="text-sm font-medium text-foreground-light">
      Descrição geral
    </Label>
    <Textarea
      id="descricao"
      value={descricao}
      onChange={(e) => { setDescricao(e.target.value); setDescricaoSaved(false) }}
      placeholder="Observações gerais sobre esta verificação..."
      rows={3}
      className="mt-1.5"
      disabled={isLocked}
    />
    {descricao !== (verificacao.descricao || '') && (
      <Button
        size="sm"
        variant="outline"
        className="mt-2"
        onClick={handleSaveDescricao}
        disabled={isPending}
      >
        Salvar descrição
      </Button>
    )}
  </div>
  ```
- `handleSaveDescricao`: Call a new Server Action or use `atualizarResultadoVerificacao` — actually, the existing `atualizarResultadoVerificacao` expects resultado + descricao, which is not right for just saving description. Instead, create a simple inline update:
  ```typescript
  const handleSaveDescricao = () => {
    startTransition(async () => {
      const supabase = ... // Can't use server supabase from client
    })
  }
  ```
  Wait — we need a Server Action for this. The existing actions don't support updating just the description. Create a new action or modify the approach:

  **Better approach:** Add a new Server Action `atualizarDescricaoVerificacao` in `arden/lib/supabase/actions/verificacoes.ts`. BUT this plan should NOT modify files from Phase 7 plan boundaries. Instead, create a simple dedicated Server Action inline in a new file, OR extend the existing verificacoes actions.

  **Decision:** Add `atualizarDescricaoVerificacao` to the existing `arden/lib/supabase/actions/verificacoes.ts` file. This is a simple addition:
  ```typescript
  export async function atualizarDescricaoVerificacao(
    input: { verificacao_id: string; descricao: string }
  ): Promise<ActionResult<{ id: string }>> {
    const supabase = await createClient()
    const { verificacao_id, descricao } = input

    const { data: verif, error: fetchError } = await supabase
      .from('verificacoes')
      .select('id, obra_id, status, itens_conformes, total_itens')
      .eq('id', verificacao_id)
      .single()

    if (fetchError || !verif) return { error: 'Verificação não encontrada' }
    if (isVerificacaoTravada(verif)) return { error: 'Verificação travada' }

    const { error: updateError } = await supabase
      .from('verificacoes')
      .update({ descricao })
      .eq('id', verificacao_id)

    if (updateError) return { error: updateError.message }

    revalidatePath(`/app/obras/${verif.obra_id}`)
    return { data: { id: verificacao_id } }
  }
  ```
  Also add a Zod schema `atualizarDescricaoSchema` in `arden/lib/validations/verificacao.ts`:
  ```typescript
  export const atualizarDescricaoSchema = z.object({
    verificacao_id: uuidString(),
    descricao: z.string().max(2000).optional().default(''),
  })
  export type AtualizarDescricaoInput = z.infer<typeof atualizarDescricaoSchema>
  ```
  Use proper validation in the action.

- In the client, call `atualizarDescricaoVerificacao` on button click, show toast on success/error.

**Step 5: Exceção flow in header and client**

Update `verificacao-header.tsx` (from Plan 01):
- Make it a `'use client'` component (needs to handle button click)
- Add props: `onExcecaoClick?: () => void`, `isExcecao?: boolean`, `disabled?: boolean`
- Add "Marcar como Exceção" button in header, positioned to the right of the title:
  ```tsx
  <div className="flex items-center justify-between">
    <div>
      {/* existing breadcrumb + title */}
    </div>
    {!isExcecao && !disabled && (
      <Button variant="outline" size="sm" onClick={onExcecaoClick}>
        Marcar como Exceção
      </Button>
    )}
    {isExcecao && (
      <Badge variant="warning">Exceção</Badge>
    )}
  </div>
  ```
- Import `Button` from `@/components/ui/button`, `Badge` from `@/components/ui/badge`

Update `verificacao-individual-client.tsx`:
- Add state: `excecaoModalOpen: boolean`
- Import `ExcecaoModal` from `./excecao-modal`
- Import `atualizarResultadoVerificacao` from `@/lib/supabase/actions/verificacoes`
- `handleExcecao`:
  1. Call `atualizarResultadoVerificacao({ verificacao_id: verificacao.id, resultado: 'excecao', descricao: justificativa })`
  2. On success: toast, close modal. The Server Action + revalidatePath will update the page data.
  3. On error: toast.error
- Pass `onExcecaoClick={() => setExcecaoModalOpen(true)}` to header
- Render ExcecaoModal
- Determine `isExcecao` from verificacao status/items (if all items are 'excecao', or if explicitly marked)
  </action>
  <verify>
- `item-detail-modal.tsx` exists with 3 sections (observação, método, tolerância)
- `excecao-modal.tsx` exists with justification form
- Clicking item row opens detail modal
- Descrição textarea renders at top, save button appears when changed
- `atualizarDescricaoVerificacao` Server Action added to verificacoes.ts
- Exceção button in header opens excecao-modal
- `npx tsc --noEmit` passes
  </verify>
  <done>
Item detail modal, general description field, and Exceção flow are working. Engineer can view item details, write verification description, and mark verification as Exceção with justification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Reinspeção flow + Locked state + Completion banner</name>
  <files>
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/reinspecao-modal.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/verificacao-individual-client.tsx
    arden/app/app/obras/[id]/verificacoes/[verificacaoId]/_components/item-checklist.tsx
  </files>
  <action>
**Step 1: Reinspeção Modal**

Create `reinspecao-modal.tsx`:

- `'use client'` directive
- Import: `Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter` from `@/components/ui/dialog`
- Import: `Button` from `@/components/ui/button`, `Textarea` from `@/components/ui/textarea`, `Label` from `@/components/ui/label`
- Import: `useForm` from `react-hook-form`, `zodResolver`, `z` from `zod`
- Import: `useState` from `react`

- Props interface:
  - `open: boolean`
  - `onOpenChange: (open: boolean) => void`
  - `itemNome: string`
  - `onConfirm: (statusReinspecao: string, observacao?: string) => void`

- State: `selectedOutcome: string | null` — tracks which reinspeção outcome was selected

- UI layout:
  - Title: "Reinspeção"
  - Subtitle: `itemNome` in `text-sm text-foreground-light`
  - 4 outcome buttons displayed as a vertical list of selectable cards:
    1. **Conforme após reinspeção** — "Não havia problema real" (icon: Check, color: green border on selection)
    2. **Retrabalho** — "Correção executada" (icon: Wrench/Tool, color: blue border)
    3. **Aprovado com concessão** — "Defeito tolerável aceito" (icon: AlertTriangle, color: warning border)
    4. **Reprovado após retrabalho** — "Correção insuficiente" (icon: X, color: destructive border)
  - Each card: `p-3 border rounded-md cursor-pointer hover:bg-surface-100 transition-colors`
  - Selected card: `border-2 border-brand bg-surface-100`
  - Card content: outcome name in `text-sm font-medium` + description in `text-xs text-foreground-muted`

  - Optional observation textarea below cards (label: "Observação (opcional)")

  - Footer with "Confirmar" button (disabled until an outcome is selected) and "Cancelar"

- On confirm: call `onConfirm(selectedOutcome!, observacaoValue)`, reset state, close modal

- Map outcome IDs to schema values:
  - "conforme_apos_reinspecao"
  - "retrabalho"
  - "aprovado_com_concessao"
  - "reprovado_apos_retrabalho"

**Step 2: Wire reinspeção into checklist**

Update `item-checklist.tsx`:

- For items with `status === 'nao_conforme'` AND `status_reinspecao === null` (NC without reinspeção yet):
  - Show a "Reinspecionar" button next to the toggle group
  - Button: `variant="outline"`, `size="sm"`, text "Reinspecionar"
  - onClick: call new prop `onReinspecionar?: (item: ItemVerificacao) => void`

- For items with `status_reinspecao` set (already reinspected):
  - Show the reinspeção result as a small badge next to the toggle:
    - `conforme_apos_reinspecao`: Badge green "Conforme após reinspeção"
    - `retrabalho`: Badge blue "Retrabalho"
    - `aprovado_com_concessao`: Badge warning "Aprovado com concessão"
    - `reprovado_apos_retrabalho`: Badge destructive "Reprovado após retrabalho"
  - Badge: `text-xs` using `Badge` component from `@/components/ui/badge`

**Step 3: Wire reinspeção into client orchestrator**

Update `verificacao-individual-client.tsx`:

- Import: `marcarItemReinspecao` from `@/lib/supabase/actions/itens-verificacao`
- Import: `ReinspecaoModal` from `./reinspecao-modal`
- Add state: `reinspecaoItem: ItemVerificacao | null`
- `handleReinspecao(statusReinspecao: string, observacao?: string)`:
  1. Call `marcarItemReinspecao({ item_verificacao_id: reinspecaoItem!.id, status_reinspecao: statusReinspecao, observacao_reinspecao: observacao })`
  2. On success: toast.success("Reinspeção registrada"), close modal
  3. On error: toast.error(result.error)
  4. Optimistic update: set `status_reinspecao` on the item
- Pass `onReinspecionar={(item) => setReinspecaoItem(item)}` to ItemChecklist
- Render ReinspecaoModal

**Step 4: Locked state UI**

Update `verificacao-individual-client.tsx`:

- At the top of the rendered content, BEFORE the description textarea, show banners based on verification state:

  ```tsx
  {/* Banner: Verificação Conforme travada */}
  {isLocked && (
    <div className="mb-4 p-3 rounded-md bg-brand/10 border border-brand/30 text-sm text-brand flex items-center gap-2">
      <Lock className="h-4 w-4" />
      Verificação Conforme — não pode ser alterada
    </div>
  )}

  {/* Banner: Verificação concluída (all items marked) */}
  {!isLocked && allItemsMarked && hasAnyNC && (
    <div className="mb-4 p-3 rounded-md bg-destructive/10 border border-destructive/30 text-sm text-destructive flex items-center gap-2">
      <AlertTriangle className="h-4 w-4" />
      Verificação concluída — Não Conforme
    </div>
  )}

  {!isLocked && allItemsMarked && !hasAnyNC && (
    <div className="mb-4 p-3 rounded-md bg-brand/10 border border-brand/30 text-sm text-brand flex items-center gap-2">
      <Check className="h-4 w-4" />
      Verificação concluída — Conforme
    </div>
  )}
  ```

- Compute `allItemsMarked`:
  ```typescript
  const allItemsMarked = itens.length > 0 && itens.every(i => i.status !== 'nao_verificado')
  ```
- Compute `hasAnyNC`:
  ```typescript
  const hasAnyNC = itens.some(i => i.status === 'nao_conforme' && !i.status_reinspecao)
  ```
  Note: An NC item that has been reinspected with conforme_apos_reinspecao is NOT an open NC.

- Import `Lock, AlertTriangle, Check` from `lucide-react`

- When `isLocked`, also disable the description textarea and hide the Exceção button (pass `disabled={isLocked}` to header)
  </action>
  <verify>
- `reinspecao-modal.tsx` exists with 4 outcome cards and observation textarea
- NC items show "Reinspecionar" button
- Reinspected items show outcome badge
- Locked verification shows info banner and disabled toggles
- Completed verification shows green/red banner
- `npx tsc --noEmit` passes
  </verify>
  <done>
Reinspeção cycle works for NC items with 4 outcomes. Locked (Conforme) verifications show disabled UI with banner. Completed verifications show result banner.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete individual verification page with all features: item checklist with C/NC/NA toggles, NC observation modal, item detail modal, general description field, Exceção flow, reinspeção cycle, locked state, and completion banners.</what-built>
  <how-to-verify>
1. Ensure dev server is running: `cd arden && npm run dev`
2. You need a verification record in the database. If none exists, create one via Supabase SQL or use the `criarVerificacao` Server Action
3. Navigate to `/app/obras/{obraId}/verificacoes/{verificacaoId}`
4. Verify:
   a. Header shows service name, unit name, obra name
   b. Items appear as checklist with C/NC/NA toggles
   c. Click C on an item — toggle turns green, toast appears
   d. Click NC on an item — modal opens asking for observation
   e. Submit NC observation — modal closes, toggle turns red
   f. Dismiss NC modal (click outside) — toggle returns to previous state
   g. Click NA on an item — toggle turns yellow/amber
   h. Click item text — detail modal opens showing Observação/Método/Tolerância
   i. Write text in Descrição geral textarea — "Salvar descrição" button appears
   j. Click "Marcar como Exceção" — justification modal opens
   k. NC items show "Reinspecionar" button
   l. Click Reinspecionar — modal with 4 outcome cards opens
   m. When all items are marked: banner appears (green if Conforme, red if NC)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. All VERIF requirements covered:
   - VERIF-01: Dedicated page at /app/obras/[id]/verificacoes/[verificacaoId]
   - VERIF-02: Toggle list C/NC/NA per item
   - VERIF-03: Auto result (any NC -> NC, all C/NA -> Conforme)
   - VERIF-04: Descrição geral textarea
   - VERIF-05: Exceção with justification
   - VERIF-06: Reinspeção cycle (4 outcomes)
2. Locked (Conforme) verification properly disabled
3. Optimistic updates with rollback on error
4. NC requires observation before saving
5. `npx tsc --noEmit` passes
6. Page follows CONVENTIONS.md pattern (bg-background min-h-full, server fetch)
</verification>

<success_criteria>
- All 6 VERIF requirements demonstrably working
- No TypeScript errors
- Follows design system (colors, spacing, components)
- Follows project conventions (Server Component page, client interactivity, Server Actions)
- User can complete full verification lifecycle: mark items -> see result -> reinspect NCs
</success_criteria>

<output>
After completion, create `.planning/phases/08-verificacao-individual/08-02-SUMMARY.md`
</output>
