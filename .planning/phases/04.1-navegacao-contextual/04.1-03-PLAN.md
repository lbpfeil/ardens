---
phase: 04.1-navegacao-contextual
plan: 03
type: execute
wave: 2
depends_on: ["04.1-01", "04.1-02"]
files_modified:
  - arden/app/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Layout detects context from URL (global vs obra)"
    - "Global context shows SidebarGlobal"
    - "Obra context (URL has /obras/[id]/*) shows SidebarObra"
    - "Breadcrumb updates based on context"
    - "Sidebar expands on hover"
    - "Clicking obra in list enters obra context"
    - "BackToGlobal returns to global context"
  artifacts:
    - path: "arden/app/app/layout.tsx"
      provides: "Context-aware layout with dual sidebar"
      min_lines: 80
      contains: "usePathname"
  key_links:
    - from: "arden/app/app/layout.tsx"
      to: "@/components/navigation"
      via: "import navigation components"
      pattern: "import.*from.*@/components/navigation"
    - from: "arden/app/app/layout.tsx"
      to: "next/navigation"
      via: "usePathname, useParams"
      pattern: "usePathname|useParams"
---

<objective>
Update the app layout to use the new navigation components with context-aware sidebar switching.

Purpose: This is the integration point - the layout detects URL context and renders the appropriate sidebar (global vs obra).

Output: Updated `app/app/layout.tsx` that switches between SidebarGlobal and SidebarObra based on URL.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04.1-navegacao-contextual/04.1-RESEARCH.md
@.planning/phases/04.1-navegacao-contextual/04.1-CONTEXT.md
@.planning/phases/04.1-navegacao-contextual/04.1-01-SUMMARY.md
@.planning/phases/04.1-navegacao-contextual/04.1-02-SUMMARY.md
@arden/app/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor layout for context detection</name>
  <files>
    arden/app/app/layout.tsx
  </files>
  <action>
Completely refactor `arden/app/app/layout.tsx` to use the new navigation system.

**Key changes:**

1. **Remove old mock data and nav arrays** - Delete `mockOrg`, `mockProject`, `mockBranch`, `primaryNav`, `bottomNav`, `verificacoesSubmenu`

2. **Remove old state** - Remove `activeItem`, `showSecondary`, `secondaryItems` state. Keep `sidebarExpanded` and `mounted`.

3. **Add context detection:**
```typescript
import { usePathname, useParams } from 'next/navigation'
import { SidebarGlobal, SidebarObra, Breadcrumb } from '@/components/navigation'

// Inside component:
const pathname = usePathname()
const params = useParams<{ id?: string }>()

// Detect obra context: URL is /app/obras/[id] or deeper
const isObraContext = pathname.startsWith('/app/obras/') && params.id && pathname !== '/app/obras'
```

4. **Fetch obra name for breadcrumb (simple approach):**
For now, pass `obraName={null}` to Breadcrumb. The breadcrumb will show just the ID or skip the name. We can enhance this later with a context provider.

5. **Render conditional sidebar:**
```typescript
{isObraContext ? (
  <SidebarObra obraId={params.id!} expanded={sidebarExpanded} />
) : (
  <SidebarGlobal expanded={sidebarExpanded} />
)}
```

6. **Update top bar:**
- Keep logo link to /app
- Replace mock breadcrumb with `<Breadcrumb obraName={null} />`
- Keep search button, help button, user dropdown

7. **Keep existing patterns:**
- StoreProvider wrapper
- `mounted` state for hydration safety on user dropdown
- hover expand/collapse on sidebar
- Mobile menu button (but can simplify - just show icon, sidebar handles content)

**Structure:**
```tsx
<StoreProvider>
  <div className="h-screen bg-background flex flex-col overflow-hidden">
    {/* Top Bar */}
    <header className="h-14 min-h-14 border-b border-border bg-background flex items-center px-4 gap-4">
      <div className="flex items-center gap-3">
        <Link href="/app" className="text-sm font-medium text-foreground">ARDEN</Link>
        <ChevronRight className="w-4 h-4 text-foreground-muted" />
        <Breadcrumb obraName={null} />
      </div>
      {/* ... right side: search, help, avatar ... */}
    </header>

    {/* Main Content Area */}
    <div className="flex-1 flex overflow-hidden">
      {/* Sidebar */}
      <aside
        className={\`\${sidebarExpanded ? 'w-56' : 'w-14'} min-w-14 border-r border-border bg-sidebar flex flex-col transition-all duration-200\`}
        onMouseEnter={() => setSidebarExpanded(true)}
        onMouseLeave={() => setSidebarExpanded(false)}
      >
        {isObraContext ? (
          <SidebarObra obraId={params.id!} expanded={sidebarExpanded} />
        ) : (
          <SidebarGlobal expanded={sidebarExpanded} />
        )}
      </aside>

      {/* Main Content */}
      <main className="flex-1 overflow-auto bg-surface-100">
        {children}
      </main>
    </div>
  </div>
</StoreProvider>
```

**Icons to keep imported:** Home, Search, HelpCircle, ChevronRight, Menu, X, LogOut, User, Settings (for dropdown only)

**Icons to remove:** LayoutDashboard, ClipboardCheck, Wrench, AlertTriangle, FileText, Package, Users (moved to navigation components)
  </action>
  <verify>
TypeScript compiles:
```bash
cd arden && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "(layout|Error)" || echo "No errors"
```

Build succeeds:
```bash
cd arden && npm run build 2>&1 | tail -10
```
  </verify>
  <done>
Layout refactored with context detection and conditional sidebar rendering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test navigation flows</name>
  <files>
    (no new files - manual verification)
  </files>
  <action>
Start dev server and verify navigation works:

```bash
cd arden && npm run dev
```

Test cases to verify (manual):
1. Visit `/app` - Should show SidebarGlobal with Home, Dashboard, Obras, Biblioteca FVS, etc.
2. Click "Obras" - Navigate to `/app/obras`, still SidebarGlobal
3. Click on any obra row - Navigate to `/app/obras/[id]`, sidebar switches to SidebarObra
4. SidebarObra shows: Dashboard, Servicos, Unidades, Verificacoes, NCs, Relatorios, Equipe, Configuracoes
5. Click "Unidades" - Navigate to `/app/obras/[id]/unidades`
6. Click "Visao Global" (BackToGlobal) - Navigate to `/app/obras`, sidebar switches back to SidebarGlobal
7. Hover over collapsed sidebar - Expands to show labels
8. Move mouse away - Collapses back to icons

Note: Some items have "Em breve" badges - these are placeholders for future features.
  </action>
  <verify>
Dev server starts:
```bash
cd arden && npm run dev &
sleep 5
curl -s http://localhost:3000/app | grep -q "ARDEN" && echo "App running"
```

(Manual verification of navigation flows)
  </verify>
  <done>
Navigation flows work correctly. Global/obra context switching functional.
  </done>
</task>

</tasks>

<verification>
Full verification:
```bash
# TypeScript
cd arden && npx tsc --noEmit --skipLibCheck

# Build
cd arden && npm run build

# Lint (if configured)
cd arden && npm run lint 2>/dev/null || echo "Lint not configured"
```

Manual verification (dev server):
- [ ] `/app` shows global sidebar
- [ ] `/app/obras` shows global sidebar
- [ ] `/app/obras/[id]` shows obra sidebar
- [ ] `/app/obras/[id]/unidades` shows obra sidebar
- [ ] BackToGlobal returns to `/app/obras`
- [ ] Sidebar expand/collapse on hover works
</verification>

<success_criteria>
- [ ] Layout uses `usePathname` and `useParams` for context detection
- [ ] SidebarGlobal renders for global context URLs
- [ ] SidebarObra renders for obra context URLs
- [ ] Breadcrumb shows in top bar
- [ ] Context switching works (click obra -> obra sidebar, click back -> global sidebar)
- [ ] Hover expand/collapse preserved
- [ ] No TypeScript errors
- [ ] Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-navegacao-contextual/04.1-03-SUMMARY.md`
</output>
