# Phase 4.1: Navegacao Contextual - Research

**Researched:** 2026-01-21
**Domain:** Next.js App Router Navigation + Zustand State Management
**Confidence:** HIGH

## Summary

This phase implements a dual-context navigation system (Global vs Obra-specific) using Next.js App Router's nested layouts and Zustand for state management. The existing codebase already has a solid foundation with a working layout in `app/app/layout.tsx` that includes top bar, primary sidebar, and secondary sidebar structure. The current implementation uses mock data and local state - we need to evolve it to be context-aware based on URL params.

Key findings:
1. **The foundation exists** - Current `app/app/layout.tsx` already implements the Supabase-style layout structure with expandable sidebar, top bar with breadcrumb, and proper styling
2. **Use `usePathname` + `useParams`** for context detection - these hooks let us determine if user is in global context (`/app/obras`) or obra context (`/app/obras/[id]/*`)
3. **Zustand store already has `currentObraId`** - The existing `app-store.ts` has the state field we need, just needs to be connected to URL params
4. **Route rename required** - Change `/agrupamentos` to `/unidades` per CONTEXT.md decisions

**Primary recommendation:** Extend existing layout to detect URL context and switch between two sidebar configurations, using `useParams` to extract obra ID and `usePathname` for active link highlighting.

## Standard Stack

The established libraries/tools for this domain:

### Core (Already in Project)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| next | 16.1.1 | Framework with App Router | Primary routing/layouts |
| zustand | 5.0.10 | State management | Already configured, has `currentObraId` |
| lucide-react | 0.562.0 | Icons | Already used in current sidebar |
| next/navigation | (bundled) | `usePathname`, `useParams`, `useRouter` | Official hooks for App Router |

### Supporting (Already in Project)
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| tailwind-merge | 3.4.0 | Class merging | Conditional styling |
| clsx | 2.1.1 | Class composition | Conditional classes |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Zustand context | React Context | Zustand already set up, simpler API |
| Custom breadcrumb | next-breadcrumbs library | Extra dependency, we need custom styling to match Supabase |

**Installation:** No new packages needed - all dependencies present.

## Architecture Patterns

### Current Project Structure (Relevant Parts)
```
arden/
├── app/
│   ├── layout.tsx              # Root layout (fonts, Toaster)
│   └── app/
│       ├── layout.tsx          # Main app layout (sidebar, top bar) <- MODIFY
│       ├── page.tsx            # Home
│       └── obras/
│           ├── page.tsx        # Obras list (Global Context)
│           └── [id]/
│               ├── page.tsx    # Obra dashboard <- MODIFY
│               ├── agrupamentos/ <- RENAME to unidades/
│               │   └── page.tsx
│               └── configuracoes/ <- CREATE
│                   └── page.tsx
├── components/
│   └── navigation/             # NEW folder for sidebar components
│       ├── sidebar-global.tsx
│       ├── sidebar-obra.tsx
│       ├── sidebar-item.tsx
│       ├── breadcrumb.tsx
│       └── top-bar.tsx
└── lib/
    └── stores/
        └── app-store.ts        # Already has currentObraId
```

### Pattern 1: Context Detection from URL

**What:** Determine navigation context by checking URL path segments
**When to use:** In layout component to decide which sidebar to render

```typescript
// Source: Next.js official docs (usePathname, useParams)
'use client'
import { usePathname, useParams } from 'next/navigation'

function useNavigationContext() {
  const pathname = usePathname()
  const params = useParams<{ id?: string }>()

  // Check if we're inside an obra context
  const isObraContext = pathname.startsWith('/app/obras/') && params.id

  return {
    context: isObraContext ? 'obra' : 'global',
    obraId: params.id || null,
    currentPath: pathname,
  }
}
```

### Pattern 2: Dual Sidebar Configuration

**What:** Two separate navigation configs that swap based on context
**When to use:** Sidebar component rendering

```typescript
// Global context navigation
const globalNavItems = [
  { icon: Home, label: 'Home', href: '/app' },
  { icon: LayoutDashboard, label: 'Dashboard', href: '/app/dashboard', badge: 'Em breve' },
  { icon: Building2, label: 'Obras', href: '/app/obras' },
  { icon: Library, label: 'Biblioteca FVS', href: '/app/biblioteca', badge: 'Em breve' },
  // separator
  { icon: Users, label: 'Usuarios', href: '/app/usuarios', badge: 'Em breve' },
  { icon: Settings, label: 'Configuracoes', href: '/app/configuracoes', badge: 'Em breve' },
]

// Obra context navigation
const obraNavItems = (obraId: string) => [
  { icon: LayoutDashboard, label: 'Dashboard', href: `/app/obras/${obraId}` },
  // separator - Operacao
  { icon: Wrench, label: 'Servicos', href: `/app/obras/${obraId}/servicos`, badge: 'Em breve' },
  { icon: Building2, label: 'Unidades', href: `/app/obras/${obraId}/unidades` },
  { icon: ClipboardCheck, label: 'Verificacoes', href: `/app/obras/${obraId}/verificacoes`, badge: 'Em breve' },
  { icon: AlertTriangle, label: 'NCs', href: `/app/obras/${obraId}/ncs', badge: 'Em breve' },
  // separator - Admin
  { icon: FileText, label: 'Relatorios', href: `/app/obras/${obraId}/relatorios`, badge: 'Em breve' },
  { icon: Users, label: 'Equipe', href: `/app/obras/${obraId}/equipe`, badge: 'Em breve' },
  { icon: Settings, label: 'Configuracoes', href: `/app/obras/${obraId}/configuracoes` },
]
```

### Pattern 3: Active Link Detection with usePathname

**What:** Highlight current nav item based on URL
**When to use:** Sidebar item rendering

```typescript
// Source: Next.js official docs
'use client'
import { usePathname } from 'next/navigation'
import Link from 'next/link'
import { cn } from '@/lib/utils'

interface SidebarItemProps {
  href: string
  icon: LucideIcon
  label: string
  expanded: boolean
  badge?: string
}

function SidebarItem({ href, icon: Icon, label, expanded, badge }: SidebarItemProps) {
  const pathname = usePathname()
  // For obra context, check if path starts with href (handles sub-routes)
  const isActive = pathname === href || pathname.startsWith(`${href}/`)

  return (
    <Link
      href={href}
      className={cn(
        'flex items-center gap-3 px-2 py-2 rounded-md text-sm transition-colors',
        isActive
          ? 'bg-sidebar-accent text-foreground'
          : 'text-foreground-light hover:text-foreground hover:bg-surface-100'
      )}
    >
      <Icon className="w-4 h-4 shrink-0" />
      {expanded && (
        <>
          <span className="truncate">{label}</span>
          {badge && (
            <span className="ml-auto text-xs bg-surface-200 px-1.5 py-0.5 rounded text-foreground-muted">
              {badge}
            </span>
          )}
        </>
      )}
    </Link>
  )
}
```

### Pattern 4: Dynamic Breadcrumb

**What:** Build breadcrumb from pathname with obra name lookup
**When to use:** Top bar

```typescript
'use client'
import { usePathname, useParams } from 'next/navigation'
import Link from 'next/link'

interface BreadcrumbProps {
  obraName?: string // Passed from parent that fetched it
}

function Breadcrumb({ obraName }: BreadcrumbProps) {
  const pathname = usePathname()
  const params = useParams<{ id?: string }>()

  // Parse path segments
  const segments = pathname.split('/').filter(Boolean)
  // segments for /app/obras/123/unidades = ['app', 'obras', '123', 'unidades']

  const crumbs = []

  // Always start with org name (construtora)
  crumbs.push({ label: 'Pfeil', href: '/app' }) // TODO: Get from auth context

  if (params.id && obraName) {
    // We're in obra context
    crumbs.push({ label: obraName, href: `/app/obras/${params.id}` })

    // Add section if not on dashboard
    const section = segments[segments.length - 1]
    if (section !== params.id) {
      const sectionLabel = sectionLabels[section] || section
      crumbs.push({ label: sectionLabel, href: pathname })
    }
  }

  return (
    <nav className="flex items-center text-sm">
      {crumbs.map((crumb, i) => (
        <Fragment key={crumb.href}>
          {i > 0 && <span className="text-foreground-muted mx-1">/</span>}
          {i === crumbs.length - 1 ? (
            <span className="text-foreground">{crumb.label}</span>
          ) : (
            <Link href={crumb.href} className="text-foreground-light hover:text-foreground">
              {crumb.label}
            </Link>
          )}
        </Fragment>
      ))}
    </nav>
  )
}

const sectionLabels: Record<string, string> = {
  unidades: 'Unidades',
  servicos: 'Servicos',
  verificacoes: 'Verificacoes',
  ncs: 'Nao-Conformidades',
  relatorios: 'Relatorios',
  equipe: 'Equipe',
  configuracoes: 'Configuracoes',
}
```

### Pattern 5: Zustand Store Sync with URL

**What:** Keep Zustand store in sync with URL-derived context
**When to use:** Layout component effect

```typescript
'use client'
import { useEffect } from 'react'
import { useParams } from 'next/navigation'
import { useAppStore } from '@/lib/stores'

function NavigationSync() {
  const params = useParams<{ id?: string }>()
  const setCurrentObra = useAppStore(s => s.setCurrentObra)

  useEffect(() => {
    // Sync Zustand with URL
    setCurrentObra(params.id || null)
  }, [params.id, setCurrentObra])

  return null // Render nothing, just syncs state
}
```

### Anti-Patterns to Avoid

- **Storing obra data in Zustand that's already in URL**: URL is source of truth for current obra ID. Don't duplicate.
- **Fetching obra in layout for sidebar**: Pass obra name from page component down, or use a lightweight fetch in a suspense boundary.
- **Using `useRouter().push()` for context switch**: Use `<Link>` components instead for proper prefetching.
- **Putting all navigation logic in a single file**: Split into focused components (SidebarGlobal, SidebarObra, SidebarItem).

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Active link detection | Custom path comparison | `usePathname()` + startsWith | Built-in, handles all edge cases |
| Context detection | Parse window.location | `useParams()` + `usePathname()` | SSR-safe, reactive |
| Class merging | String concatenation | `cn()` from lib/utils (clsx + tailwind-merge) | Already in project, handles conflicts |
| Route navigation | window.location.href | `<Link>` or `useRouter().push()` | Preserves React state, prefetches |

**Key insight:** Next.js App Router provides all the hooks needed for navigation state. Don't create parallel state management systems for what URL already tracks.

## Common Pitfalls

### Pitfall 1: Hydration Mismatch with usePathname

**What goes wrong:** SSR renders one path, client has different path after rewrite/redirect
**Why it happens:** URL can change between server render and client hydration
**How to avoid:** For dynamic breadcrumb text, use `useState` + `useEffect` pattern:
```typescript
const [mounted, setMounted] = useState(false)
useEffect(() => setMounted(true), [])
if (!mounted) return <Skeleton />
```
**Warning signs:** Console error about text content mismatch

### Pitfall 2: Sidebar Re-renders on Every Navigation

**What goes wrong:** Entire sidebar re-renders when navigating between pages
**Why it happens:** Layout is a Client Component re-rendering on every pathname change
**How to avoid:**
- Split sidebar into Server Component wrapper + Client Component items
- Use React.memo for sidebar items
- Keep expanded state local to sidebar, not in pathname
**Warning signs:** Visible flicker on navigation, loss of hover state

### Pitfall 3: obra Data Fetching in Layout

**What goes wrong:** Layout needs obra name for breadcrumb, fetches on every navigation
**Why it happens:** Trying to show obra name without passing it from page
**How to avoid:**
- Option A: Fetch obra in page, pass to client component that updates breadcrumb context
- Option B: Use React Server Component in layout with `params` to fetch
- Option C: Accept ID-only breadcrumb initially, hydrate name client-side
**Warning signs:** Waterfall requests, slow navigation

### Pitfall 4: Link href Mismatch with Active State

**What goes wrong:** Link shows as active when it shouldn't (or vice versa)
**Why it happens:** Using exact match when should use prefix, or vice versa
**How to avoid:**
- Dashboard/Home: exact match (`pathname === href`)
- Section items: prefix match (`pathname.startsWith(href)`)
**Warning signs:** Multiple items appear active, or none active on sub-pages

### Pitfall 5: Route Rename Breaking Links

**What goes wrong:** After renaming `/agrupamentos` to `/unidades`, old links break
**Why it happens:** Hardcoded links scattered across codebase
**How to avoid:**
- Search entire codebase for "agrupamentos" before rename
- Add Next.js redirect in `next.config.js` for any bookmarked URLs
**Warning signs:** 404 errors after deployment

## Code Examples

Verified patterns from official sources and existing codebase:

### Layout with Context-Aware Sidebar (Main Implementation)

```typescript
// Source: Pattern combining existing app/app/layout.tsx with Next.js docs
'use client'

import { usePathname, useParams } from 'next/navigation'
import { SidebarGlobal } from '@/components/navigation/sidebar-global'
import { SidebarObra } from '@/components/navigation/sidebar-obra'
import { TopBar } from '@/components/navigation/top-bar'
import { StoreProvider } from '@/lib/stores'

export default function AppLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname()
  const params = useParams<{ id?: string }>()

  // Determine context from URL
  const isObraContext = pathname.startsWith('/app/obras/') && params.id

  return (
    <StoreProvider>
      <div className="h-screen bg-background flex flex-col overflow-hidden">
        <TopBar obraId={params.id} />

        <div className="flex-1 flex overflow-hidden">
          {isObraContext ? (
            <SidebarObra obraId={params.id!} />
          ) : (
            <SidebarGlobal />
          )}

          <main className="flex-1 overflow-auto bg-surface-100">
            {children}
          </main>
        </div>
      </div>
    </StoreProvider>
  )
}
```

### Sidebar Item Component with Badge

```typescript
// Source: Based on existing layout code + CONTEXT.md decisions
'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { type LucideIcon } from 'lucide-react'
import { cn } from '@/lib/utils'

interface SidebarItemProps {
  href: string
  icon: LucideIcon
  label: string
  expanded: boolean
  badge?: string
  exact?: boolean // Use exact match for active state
}

export function SidebarItem({
  href,
  icon: Icon,
  label,
  expanded,
  badge,
  exact = false
}: SidebarItemProps) {
  const pathname = usePathname()
  const isActive = exact
    ? pathname === href
    : pathname === href || pathname.startsWith(`${href}/`)

  return (
    <li>
      <Link
        href={href}
        className={cn(
          'w-full flex items-center gap-3 px-2 py-2 rounded-md text-sm transition-colors',
          isActive
            ? 'bg-sidebar-accent text-foreground'
            : 'text-foreground-light hover:text-foreground hover:bg-surface-100'
        )}
      >
        <Icon className="w-4 h-4 shrink-0" />
        {expanded && (
          <>
            <span className="truncate">{label}</span>
            {badge && (
              <span className="ml-auto text-[10px] bg-surface-200 px-1.5 py-0.5 rounded text-foreground-muted whitespace-nowrap">
                {badge}
              </span>
            )}
          </>
        )}
      </Link>
    </li>
  )
}
```

### Status Indicator (Online/Offline)

```typescript
// Source: Existing layout code
interface StatusIndicatorProps {
  expanded: boolean
}

export function StatusIndicator({ expanded }: StatusIndicatorProps) {
  // TODO: Connect to actual online/offline detection
  const isOnline = true

  return (
    <div className="px-2 py-2">
      <div className="flex items-center gap-2 px-2">
        <div className={cn(
          'w-2 h-2 rounded-full',
          isOnline ? 'bg-brand' : 'bg-destructive'
        )} />
        {expanded && (
          <span className="text-xs text-foreground-light">
            {isOnline ? 'Online' : 'Offline'}
          </span>
        )}
      </div>
    </div>
  )
}
```

### Back to Global Button (Obra Sidebar Footer)

```typescript
// Source: CONTEXT.md decisions
'use client'

import Link from 'next/link'
import { ArrowLeft } from 'lucide-react'

interface BackToGlobalProps {
  expanded: boolean
}

export function BackToGlobal({ expanded }: BackToGlobalProps) {
  return (
    <div className="border-t border-border py-2 px-2">
      <Link
        href="/app/obras"
        className="w-full flex items-center gap-3 px-2 py-2 rounded-md text-sm text-foreground-light hover:text-foreground hover:bg-surface-100 transition-colors"
      >
        <ArrowLeft className="w-4 h-4 shrink-0" />
        {expanded && <span>Visao Global</span>}
      </Link>
    </div>
  )
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Pages Router `useRouter` | App Router `usePathname`/`useParams` | Next.js 13+ | Simpler API, SSR-safe |
| Global Zustand store | Per-request store with provider | Zustand 4.4+ | Avoids SSR state leaks |
| Secondary sidebar for all modules | Secondary sidebar only when needed | Supabase 2024 | Cleaner UX, more content space |

**Deprecated/outdated:**
- `next/router`: Use `next/navigation` in App Router
- `router.pathname` (route template): App Router `usePathname` returns actual path

## Open Questions

Things that couldn't be fully resolved:

1. **Obra name in breadcrumb**
   - What we know: Need obra name for breadcrumb, can fetch in page
   - What's unclear: Best pattern to pass to layout without prop drilling
   - Recommendation: Start with ID-only breadcrumb, add name via context in Phase 4.2 or when implementing obra header

2. **Secondary sidebar necessity for MVP**
   - What we know: Design spec includes secondary sidebar (240px) for modules with subdivisions
   - What's unclear: Do any MVP modules need secondary sidebar?
   - Recommendation: Defer secondary sidebar to later phases (Verificacoes, Servicos have subdivisions but are placeholders)

3. **Redirect for renamed route**
   - What we know: Renaming `/agrupamentos` to `/unidades`
   - What's unclear: Are there external bookmarks/links to maintain?
   - Recommendation: Add redirect in next.config.js to be safe:
     ```js
     redirects: async () => [
       { source: '/app/obras/:id/agrupamentos', destination: '/app/obras/:id/unidades', permanent: true }
     ]
     ```

## Sources

### Primary (HIGH confidence)
- [Next.js usePathname docs](https://nextjs.org/docs/app/api-reference/functions/use-pathname) - API for pathname detection
- [Next.js useParams docs](https://nextjs.org/docs/app/api-reference/functions/use-params) - API for dynamic params
- [Next.js Layouts and Pages](https://nextjs.org/docs/app/getting-started/layouts-and-pages) - Nested layout patterns
- Existing codebase: `arden/app/app/layout.tsx` - Working sidebar implementation
- Existing codebase: `arden/lib/stores/app-store.ts` - Zustand store with `currentObraId`

### Secondary (MEDIUM confidence)
- [Zustand Next.js guide](https://zustand.docs.pmnd.rs/guides/nextjs) - Per-request store pattern (WebSearch verified)
- [Next.js navigation guide](https://nextjs.org/docs/app/getting-started/linking-and-navigating) - Link and navigation patterns

### Tertiary (LOW confidence)
- WebSearch results on dynamic breadcrumbs - various community patterns

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already in project, versions verified
- Architecture: HIGH - Based on existing working code + official docs
- Pitfalls: MEDIUM - Common patterns from community, not all personally verified
- Code examples: HIGH - Adapted from existing codebase + official docs

**Research date:** 2026-01-21
**Valid until:** 60 days (stable patterns, no breaking changes expected)
